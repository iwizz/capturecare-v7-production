{% extends "base.html" %}

{% block title %}{{ patient.first_name }} {{ patient.last_name }} - CaptureCare{% endblock %}

{% block content %}
<script>
    // Set base URL for video room links (use public URL if configured, otherwise current origin)
    window.baseUrl = {{ base_url|tojson|safe if base_url else 'window.location.origin' }};
    {% if not base_url or '127.0.0.1' in base_url or 'localhost' in base_url %}
    console.warn('‚ö†Ô∏è BASE_URL not configured or uses localhost - patient video links will not work for external patients!');
    console.warn('‚ö†Ô∏è Set BASE_URL environment variable to your public URL (e.g., ngrok URL or domain)');
    {% endif %}
</script>

<!-- Patient Search Box -->
<div class="bg-white rounded-lg shadow-md p-4 mb-4">
    <div class="flex items-center gap-3">
        <div class="flex-1 relative">
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            <input type="text" id="patientSearch" placeholder="Search patients by name or email..." 
                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-brand-bright-teal"
                   autocomplete="off">
            <div id="searchResults" class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-96 overflow-y-auto"></div>
        </div>
        <button onclick="showAllPatients()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
            <i class="fas fa-users mr-2"></i>All Patients
        </button>
    </div>
</div>

<!-- Patient Tabs -->
<div id="patientTabs" class="bg-white rounded-lg shadow-md mb-4 overflow-x-auto">
    <div class="flex border-b border-gray-200 min-w-max">
        <!-- Tabs will be inserted here by JavaScript -->
    </div>
</div>

<!-- Patient Header - Sticky and Compact -->
<div class="sticky top-0 z-50 bg-white shadow-md border-b border-gray-200 mb-3">
    <div class="px-4 py-2 flex items-center justify-between gap-3">
        <div class="flex items-center gap-3 flex-1 min-w-0">
            <h1 class="text-xl font-bold text-gray-800 truncate">
                {{ patient.first_name }} {{ patient.last_name }}
            </h1>
            <span class="text-sm text-gray-500 hidden sm:inline">‚Ä¢</span>
            <span class="text-sm text-gray-600 truncate hidden sm:inline">{{ patient.email }}</span>
            {% if patient.date_of_birth %}
                <span class="text-sm text-gray-500 hidden md:inline">
                    DOB: {{ patient.date_of_birth.strftime('%Y-%m-%d') }}{% if patient_age %} ({{ patient_age }} years){% endif %}
                </span>
            {% endif %}
            {% if patient.withings_user_id %}
                <span class="px-2 py-1 bg-green-100 text-brand-teal rounded text-xs font-semibold whitespace-nowrap">
                    <i class="fas fa-check-circle"></i> Withings
                </span>
            {% endif %}
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
            <button type="button" onclick="openIOSInviteModal()" class="px-3 py-1.5 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 transition font-semibold whitespace-nowrap">
                <i class="fas fa-mobile-alt mr-1"></i>Send App Invite
            </button>
            {% if not patient.withings_user_id %}
                <button type="button" onclick="sendWithingsEmailToPatient()" class="px-3 py-1.5 text-sm bg-brand-bright-teal text-white rounded hover:bg-brand-teal transition font-semibold whitespace-nowrap">
                    <i class="fas fa-envelope mr-1"></i>Send Withings Link
                </button>
            {% endif %}
            <button type="button" onclick="confirmDeletePatient()" class="px-3 py-1.5 text-sm bg-red-600 text-white rounded hover:bg-red-700 transition font-semibold whitespace-nowrap">
                <i class="fas fa-trash mr-1"></i>Delete
            </button>
        </div>
    </div>
</div>

<!-- Date Range Filter - Sticky -->
<div class="sticky top-[49px] z-40 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-2 mb-4 border border-blue-200">
    <form method="GET" action="{{ url_for('patient_detail', patient_id=patient.id) }}" class="flex flex-wrap items-center gap-2">
        <div class="flex-1 min-w-[120px]">
            <label for="start_date" class="block text-xs font-semibold text-gray-700 mb-0.5">
                <i class="fas fa-calendar-alt mr-1"></i>Start
            </label>
            <input type="date" id="start_date" name="start_date" value="{{ start_date }}"
                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="flex-1 min-w-[120px]">
            <label for="end_date" class="block text-xs font-semibold text-gray-700 mb-0.5">
                <i class="fas fa-calendar-alt mr-1"></i>End
            </label>
            <input type="date" id="end_date" name="end_date" value="{{ end_date }}"
                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
        </div>
        <div class="flex items-end gap-1">
            <button type="submit" class="px-2.5 py-1 text-xs bg-brand-bright-teal text-white rounded hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-filter mr-1"></i>Apply
            </button>
            <button type="button" onclick="setDateRange(7)" class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">7d</button>
            <button type="button" onclick="setDateRange(30)" class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">30d</button>
            <button type="button" onclick="setDateRange(90)" class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">90d</button>
        </div>
    </form>
</div>

<!-- Latest Health Metrics Summary Cards -->
{% if latest_values %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    {% if latest_values.get('weight') %}
    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-weight text-3xl opacity-80"></i>
            <span class="text-xs uppercase tracking-wide opacity-90">Weight</span>
        </div>
        <div class="text-4xl font-bold mb-1">{{ "%.1f"|format(latest_values.weight.value) }}</div>
        <div class="text-sm opacity-90">{{ latest_values.weight.unit }}</div>
        <div class="text-xs mt-2 opacity-75">{{ latest_values.weight.timestamp.strftime('%b %d, %Y') }}</div>
    </div>
    {% endif %}
    
    {% if latest_values.get('heart_rate') %}
    <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-heartbeat text-3xl opacity-80"></i>
            <span class="text-xs uppercase tracking-wide opacity-90">Heart Rate</span>
        </div>
        <div class="text-4xl font-bold mb-1">{{ "%d"|format(latest_values.heart_rate.value|int) }}</div>
        <div class="text-sm opacity-90">{{ latest_values.heart_rate.unit }}</div>
        <div class="text-xs mt-2 opacity-75">{{ latest_values.heart_rate.timestamp.strftime('%b %d, %Y') }}</div>
    </div>
    {% endif %}
    
    {% if latest_values.get('systolic_bp') %}
    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-heart-pulse text-3xl opacity-80"></i>
            <span class="text-xs uppercase tracking-wide opacity-90">Blood Pressure</span>
        </div>
        <div class="text-4xl font-bold mb-1">
            {{ "%d"|format(latest_values.systolic_bp.value|int) }}/{{ "%d"|format(latest_values.get('diastolic_bp', {}).get('value', 0)|int) }}
        </div>
        <div class="text-sm opacity-90">mmHg</div>
        <div class="text-xs mt-2 opacity-75">{{ latest_values.systolic_bp.timestamp.strftime('%b %d, %Y') }}</div>
    </div>
    {% endif %}
    
    {% if latest_values.get('steps') %}
    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
        <div class="flex items-center justify-between mb-2">
            <i class="fas fa-walking text-3xl opacity-80"></i>
            <span class="text-xs uppercase tracking-wide opacity-90">Daily Steps</span>
        </div>
        <div class="text-4xl font-bold mb-1">{{ "{:,.0f}".format(latest_values.steps.value) }}</div>
        <div class="text-sm opacity-90">steps</div>
        <div class="text-xs mt-2 opacity-75">{{ latest_values.steps.timestamp.strftime('%b %d, %Y') }}</div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="grid md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold text-gray-700 mb-2">Withings Status</h3>
        {% if patient.withings_user_id %}
            <p class="text-brand-bright-teal"><i class="fas fa-check-circle"></i> Connected</p>
            <p class="text-sm text-gray-500 mt-1">User ID: {{ patient.withings_user_id }}</p>
        {% else %}
            <p class="text-gray-500"><i class="fas fa-times-circle"></i> Not Connected</p>
        {% endif %}
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold text-gray-700 mb-2">Cliniko Status</h3>
        {% if patient.cliniko_patient_id %}
            <p class="text-brand-bright-teal"><i class="fas fa-link"></i> Linked</p>
            <p class="text-sm text-gray-500 mt-1">ID: {{ patient.cliniko_patient_id }}</p>
        {% else %}
            <p class="text-gray-500"><i class="fas fa-unlink"></i> Not Linked</p>
        {% endif %}
    </div>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="font-semibold text-gray-700 mb-2">Devices</h3>
        <p class="text-2xl font-bold text-gray-800">{{ devices|length }}</p>
        <p class="text-sm text-gray-500 mt-1">Active devices</p>
    </div>
</div>

<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Actions</h2>
    <div class="flex flex-wrap gap-4">
        <button type="button" onclick="startSync(false)" class="bg-brand-bright-teal text-white px-6 py-3 rounded-lg hover:bg-brand-teal transition font-semibold">
            <i class="fas fa-sync mr-2"></i>Sync New Data
        </button>
        
        <button type="button" onclick="if(confirm('This will refresh ALL historical data (up to 1 year). This may take a few minutes. Continue?')) startSync(true)" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
            <i class="fas fa-database mr-2"></i>Refresh All Data
        </button>
        
        <!-- Patient Report Button -->
        <button type="button" onclick="openReportEditor('patient')" class="bg-brand-bright-teal text-white px-6 py-3 rounded-lg hover:bg-brand-teal transition font-semibold">
            <i class="fas fa-user-check mr-2"></i>Patient Report
        </button>
        
        <!-- Clinical Note Button -->
        <button type="button" onclick="openReportEditor('clinical')" class="bg-brand-teal text-white px-6 py-3 rounded-lg hover:bg-brand-bright-teal transition font-semibold">
            <i class="fas fa-notes-medical mr-2"></i>Clinical Note (SOAP)
        </button>
        
        <!-- Video Script Button -->
        <button type="button" onclick="openReportEditor('video_script')" class="bg-cyan-600 text-white px-6 py-3 rounded-lg hover:bg-cyan-700 transition font-semibold">
            <i class="fas fa-video mr-2"></i>Video Script
        </button>
        
        <!-- Target Ranges Button -->
        <button type="button" onclick="openTargetRangesModal()" class="bg-brand-soft-blue text-white px-6 py-3 rounded-lg hover:bg-brand-teal transition font-semibold">
            <i class="fas fa-bullseye mr-2"></i>Set Target Ranges
        </button>
    </div>
    <p class="text-sm text-gray-600 mt-3">
        <i class="fas fa-info-circle mr-1"></i>
        Sync automatically fetches new data since your last sync, or pulls all available data if this is the first sync.
    </p>
</div>

<!-- Patient Information & Appointments Section -->
<div class="grid md:grid-cols-2 gap-6 mb-8">
    <!-- Patient Information Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-user-circle text-brand-bright-teal mr-2"></i>Patient Information
            </h2>
            <button type="button" onclick="toggleEditMode()" id="editToggleBtn" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-edit mr-2"></i>Edit
            </button>
        </div>
        
        <!-- Tab Navigation -->
        <div class="border-b border-gray-200 mb-4">
            <nav class="flex space-x-4">
                <button type="button" onclick="switchPatientTab('basic')" id="basicInfoTab" class="px-4 py-2 font-semibold text-brand-bright-teal border-b-2 border-brand-bright-teal">
                    <i class="fas fa-user mr-1"></i>Patient Information
                </button>
                <button type="button" onclick="switchPatientTab('registration')" id="registrationInfoTab" class="px-4 py-2 font-semibold text-gray-500 hover:text-brand-bright-teal border-b-2 border-transparent">
                    <i class="fas fa-clipboard-list mr-1"></i>Registration Details
                </button>
                <button type="button" onclick="switchPatientTab('video')" id="videoInfoTab" class="px-4 py-2 font-semibold text-gray-500 hover:text-brand-bright-teal border-b-2 border-transparent">
                    <i class="fas fa-video mr-1"></i>AI Avatar Health Video
                </button>
            </nav>
        </div>
        
        <!-- View Mode -->
        <div id="patientInfoView">
            <!-- Basic Information Tab -->
            <div id="basicInfoContent" class="tab-content">
                <div class="space-y-6">
                    <!-- üë§ Personal Information -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">
                            üë§ Personal Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">First Name</p>
                                <p class="font-semibold text-gray-800">{{ patient.first_name }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Last Name</p>
                                <p class="font-semibold text-gray-800">{{ patient.last_name }}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">üìß Email</p>
                                <p class="font-semibold text-gray-800">{{ patient.email }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">üìÖ Date of Birth</p>
                                <p class="font-semibold text-gray-800">
                                    {{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else 'Not set' }}
                                    {% if patient.date_of_birth %}
                                        <span class="text-sm text-brand-bright-teal ml-2">
                                            üéÇ {{ patient_age }} years old
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">üë®‚Äç‚öïÔ∏è Allocated Practitioner</p>
                                <p class="font-semibold text-gray-800">
                                    {% if patient.allocated_practitioner %}
                                        {{ patient.allocated_practitioner.full_name }}
                                        <span class="text-xs text-gray-500 ml-2">({{ patient.allocated_practitioner.role }})</span>
                                    {% else %}
                                        <span class="text-gray-400">Not assigned</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">‚öß Sex</p>
                                <p class="font-semibold text-gray-800">
                                    {% if patient.sex == 'Male' %}‚ôÇÔ∏è Male
                                    {% elif patient.sex == 'Female' %}‚ôÄÔ∏è Female
                                    {% elif patient.sex == 'Other' %}‚öß Other
                                    {% else %}Not set{% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üìû Contact Information -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">
                            üìû Contact Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">‚òéÔ∏è Phone</p>
                                <p class="font-semibold text-gray-800">{{ patient.phone or 'Not set' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">üì± Mobile</p>
                                <p class="font-semibold text-gray-800">{{ patient.mobile or 'Not set' }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- üè† Address -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">
                            üè† Address
                        </h3>
                        <p class="font-semibold text-gray-800">
                            {% if patient.address_line1 %}
                                {{ patient.address_line1 }}
                                {% if patient.address_line2 %}, {{ patient.address_line2 }}{% endif %}
                                <br>{{ patient.city or '' }} {{ patient.state or '' }} {{ patient.postcode or '' }}
                                {% if patient.country %}<br>{{ patient.country }}{% endif %}
                            {% else %}
                                Not set
                            {% endif %}
                        </p>
                    </div>
                    
                    <!-- üö® Emergency Contact -->
                    {% if patient.emergency_contact_name %}
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-700 mb-3 text-sm">
                            üö® Emergency Contact
                        </h3>
                        <div class="space-y-2">
                            <p class="font-semibold text-gray-800">{{ patient.emergency_contact_name }} ({{ patient.emergency_contact_relationship or 'Relationship not specified' }})</p>
                            <p class="text-sm text-gray-600">üìû {{ patient.emergency_contact_phone or 'Phone not provided' }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- ‚öïÔ∏è Medical Alerts -->
                    {% if patient.medical_alerts %}
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="font-bold text-red-700 mb-2 text-sm">
                            ‚ö†Ô∏è Medical Alerts
                        </h3>
                        <p class="font-semibold text-red-800">{{ patient.medical_alerts }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Registration Details Tab -->
            <div id="registrationInfoContent" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- GP Information -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-user-md text-brand-bright-teal mr-2"></i>GP Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Has GP</p>
                                <p class="font-semibold">
                                    {% if patient.has_gp %}
                                        <i class="fas fa-check-circle text-green-600"></i> Yes
                                    {% else %}
                                        <i class="fas fa-times-circle text-gray-400"></i> No
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">GP Name</p>
                                <p class="font-semibold">{{ patient.gp_name or 'Not provided' }}</p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">GP Address</p>
                                <p class="font-semibold">{{ patient.gp_address or 'Not provided' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">GP Phone</p>
                                <p class="font-semibold">{{ patient.gp_phone or 'Not provided' }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Emergency Contact Details -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-ambulance text-red-600 mr-2"></i>Emergency Contact
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Emergency Contact Name</p>
                                <p class="font-semibold">{{ patient.emergency_contact_name or 'Not provided' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Emergency Mobile</p>
                                <p class="font-semibold">{{ patient.emergency_contact_phone or 'Not provided' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Emergency Email</p>
                                <p class="font-semibold">{{ patient.emergency_contact_email or 'Not provided' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Contact Consent</p>
                                <p class="font-semibold">
                                    {% if patient.emergency_contact_consent %}
                                        <i class="fas fa-check-circle text-green-600"></i> Given
                                    {% else %}
                                        <i class="fas fa-times-circle text-gray-400"></i> Not given
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Health Information -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-heartbeat text-purple-600 mr-2"></i>Health Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">Current Medications</p>
                                <p class="font-semibold">{{ patient.current_medications or 'None listed' }}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Has Smart Device</p>
                                <p class="font-semibold">
                                    {% if patient.owns_smart_device %}
                                        <i class="fas fa-check-circle text-green-600"></i> Yes
                                    {% else %}
                                        <i class="fas fa-times-circle text-gray-400"></i> No
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-500">Health Focus Areas</p>
                                <p class="font-semibold">{{ patient.health_focus_areas or 'Not specified' }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Consent & Terms -->
                    <div>
                        <h3 class="font-bold text-gray-800 mb-3">
                            <i class="fas fa-file-signature text-brand-teal mr-2"></i>Consent & Terms
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500">Terms Accepted</p>
                                <p class="font-semibold">
                                    {% if patient.terms_consent %}
                                        <i class="fas fa-check-circle text-green-600"></i> Accepted
                                    {% else %}
                                        <i class="fas fa-times-circle text-gray-400"></i> Not accepted
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Avatar Health Video Tab -->
            <div id="videoInfoContent" class="tab-content hidden">
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border border-brand-soft-blue">
                    <p class="text-sm text-gray-600 mb-4">Generate personalized health report videos with AI avatar narration</p>
                    
                    <div class="bg-white rounded-lg p-6 mb-4">
                        <h3 class="font-bold text-lg mb-4 text-gray-800">
                            <i class="fas fa-user-nurse text-brand-teal mr-2"></i>Avatar & Voice Settings
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-users mr-1"></i>Avatar Type
                                </label>
                                <select id="avatarSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">ü§ñ Auto-select medical professional</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Select nurse/doctor avatar (gender, age, appearance)</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-globe mr-1"></i>Voice Language
                                </label>
                                <select id="voiceLanguage" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterVoices()">
                                    <option value="English">üá¨üáß English</option>
                                    <option value="Spanish">üá™üá∏ Spanish</option>
                                    <option value="French">üá´üá∑ French</option>
                                    <option value="German">üá©üá™ German</option>
                                    <option value="Italian">üáÆüáπ Italian</option>
                                    <option value="Portuguese">üáµüáπ Portuguese</option>
                                    <option value="Chinese">üá®üá≥ Chinese</option>
                                    <option value="Japanese">üáØüáµ Japanese</option>
                                    <option value="Korean">üá∞üá∑ Korean</option>
                                    <option value="Hindi">üáÆüá≥ Hindi</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-venus-mars mr-1"></i>Voice Gender
                                </label>
                                <select id="voiceGender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterVoices()">
                                    <option value="">Any gender</option>
                                    <option value="female">Female</option>
                                    <option value="male">Male</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-gauge mr-1"></i>Speech Speed
                                </label>
                                <select id="voiceSpeed" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="0.8">üê¢ Slow (0.8x)</option>
                                    <option value="0.9">Slightly Slow (0.9x)</option>
                                    <option value="1.0" selected>Normal (1.0x)</option>
                                    <option value="1.1">Slightly Fast (1.1x)</option>
                                    <option value="1.2">üêá Fast (1.2x)</option>
                                </select>
                            </div>
                            
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-microphone mr-1"></i>Specific Voice (Optional)
                                </label>
                                <select id="voiceSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <option value="">Auto-select best voice</option>
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Leave as auto-select to automatically choose based on language & gender</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-6">
                            <button onclick="generateHeyGenVideo()" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md">
                                <i class="fas fa-play-circle mr-2"></i>Generate Video
                            </button>
                            <button onclick="loadAvatarsAndVoices()" class="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh Options
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video Status -->
                    <div id="videoStatus" class="hidden bg-brand-cream border border-brand-soft-blue rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-spinner fa-spin text-brand-bright-teal text-xl"></i>
                            <div>
                                <p class="font-semibold text-brand-teal" id="videoStatusText">Generating video...</p>
                                <p class="text-sm text-brand-bright-teal">This may take 2-5 minutes. You can leave this page and come back later.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Result -->
                    <div id="videoResult" class="hidden bg-brand-cream border border-brand-soft-blue rounded-lg p-6">
                        <h4 class="font-bold text-brand-teal mb-3 text-lg">
                            <i class="fas fa-check-circle mr-2"></i>Video Ready!
                        </h4>
                        <div class="flex items-center gap-4">
                            <a id="videoLink" href="#" target="_blank" class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold inline-flex items-center">
                                <i class="fas fa-external-link-alt mr-2"></i>Open Video
                            </a>
                            <a id="videoDownload" href="#" download class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold inline-flex items-center">
                                <i class="fas fa-download mr-2"></i>Download
                            </a>
                            <button onclick="checkVideoStatus()" class="px-4 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition">
                                <i class="fas fa-sync-alt mr-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Edit Mode (hidden by default) -->
        <div id="patientInfoEdit" style="display: none;">
            <form method="POST" action="{{ url_for('update_patient', patient_id=patient.id) }}">
                <!-- Fixed Height Scrollable Container -->
                <div class="overflow-y-auto border border-gray-200 rounded-lg p-4 bg-gray-50" style="max-height: 600px;">
                    
                    <!-- Personal Information Section -->
                    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">üë§</span> Personal Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-user mr-1 text-brand-teal"></i>First Name *
                                </label>
                                <input type="text" name="first_name" value="{{ patient.first_name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-user mr-1 text-brand-teal"></i>Last Name *
                                </label>
                                <input type="text" name="last_name" value="{{ patient.last_name }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent" required>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-envelope mr-1 text-brand-teal"></i>Email Address *
                                </label>
                                <input type="email" name="email" value="{{ patient.email }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent" required>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-user-md mr-1 text-brand-teal"></i>Allocated Practitioner
                                </label>
                                <select name="allocated_practitioner_id" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                                    <option value="">Not assigned</option>
                                    {% for practitioner in practitioners %}
                                    <option value="{{ practitioner.id }}" 
                                            {% if patient.allocated_practitioner_id == practitioner.id %}selected{% endif %}>
                                        {{ practitioner.full_name }} ({{ practitioner.role }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">This practitioner will be pre-selected when booking appointments</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="text-lg mr-1">üéÇ</span>Date of Birth
                                </label>
                                <div class="relative">
                                    <input type="date" id="dobInput" name="date_of_birth" 
                                           value="{{ patient.date_of_birth.strftime('%Y-%m-%d') if patient.date_of_birth else '' }}" 
                                           onchange="calculateAge()"
                                           max="{{ today }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent text-base">
                                </div>
                                <p id="ageDisplay" class="text-xs text-gray-600 mt-1"></p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <span class="text-lg mr-1">‚ö•</span>Sex
                                </label>
                                <select name="sex" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                                    <option value="">Not specified</option>
                                    <option value="Male" {% if patient.sex == 'Male' %}selected{% endif %}>‚ôÇÔ∏è Male</option>
                                    <option value="Female" {% if patient.sex == 'Female' %}selected{% endif %}>‚ôÄÔ∏è Female</option>
                                    <option value="Other" {% if patient.sex == 'Other' %}selected{% endif %}>‚öß Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contact Information Section -->
                    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">üìû</span> Contact Information
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-phone mr-1 text-brand-teal"></i>Phone
                                </label>
                                <input type="tel" name="phone" value="{{ patient.phone or '' }}" 
                                       placeholder="(02) 1234 5678"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-mobile-alt mr-1 text-brand-teal"></i>Mobile
                                </label>
                                <input type="tel" name="mobile" value="{{ patient.mobile or '' }}" 
                                       placeholder="0412 345 678"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Address Section -->
                    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">üè†</span> Address
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-map-marker-alt mr-1 text-brand-teal"></i>Street Address Line 1
                                </label>
                                <input type="text" name="address_line1" value="{{ patient.address_line1 or '' }}" 
                                       placeholder="123 Main Street"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-map-marker-alt mr-1 text-brand-teal"></i>Street Address Line 2
                                </label>
                                <input type="text" name="address_line2" value="{{ patient.address_line2 or '' }}" 
                                       placeholder="Unit 4B"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-city mr-1 text-brand-teal"></i>City
                                </label>
                                <input type="text" name="city" value="{{ patient.city or '' }}" 
                                       placeholder="Sydney"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-map mr-1 text-brand-teal"></i>State
                                </label>
                                <select name="state" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                                    <option value="">Select state</option>
                                    <option value="NSW" {% if patient.state == 'NSW' %}selected{% endif %}>NSW</option>
                                    <option value="VIC" {% if patient.state == 'VIC' %}selected{% endif %}>VIC</option>
                                    <option value="QLD" {% if patient.state == 'QLD' %}selected{% endif %}>QLD</option>
                                    <option value="SA" {% if patient.state == 'SA' %}selected{% endif %}>SA</option>
                                    <option value="WA" {% if patient.state == 'WA' %}selected{% endif %}>WA</option>
                                    <option value="TAS" {% if patient.state == 'TAS' %}selected{% endif %}>TAS</option>
                                    <option value="NT" {% if patient.state == 'NT' %}selected{% endif %}>NT</option>
                                    <option value="ACT" {% if patient.state == 'ACT' %}selected{% endif %}>ACT</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-mailbox mr-1 text-brand-teal"></i>Postcode
                                </label>
                                <input type="text" name="postcode" value="{{ patient.postcode or '' }}" 
                                       placeholder="2000" maxlength="4"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-globe mr-1 text-brand-teal"></i>Country
                                </label>
                                <input type="text" name="country" value="{{ patient.country or 'Australia' }}" 
                                       placeholder="Australia"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Emergency Contact Section -->
                    <div class="mb-6 bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">üö®</span> Emergency Contact
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-user-shield mr-1 text-red-600"></i>Emergency Contact Name
                                </label>
                                <input type="text" name="emergency_contact_name" value="{{ patient.emergency_contact_name or '' }}" 
                                       placeholder="Jane Doe"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-phone-square mr-1 text-red-600"></i>Emergency Phone
                                </label>
                                <input type="tel" name="emergency_contact_phone" value="{{ patient.emergency_contact_phone or '' }}" 
                                       placeholder="0412 345 678"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-users mr-1 text-red-600"></i>Relationship
                                </label>
                                <select name="emergency_contact_relationship" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">Select relationship</option>
                                    <option value="Spouse" {% if patient.emergency_contact_relationship == 'Spouse' %}selected{% endif %}>Spouse</option>
                                    <option value="Partner" {% if patient.emergency_contact_relationship == 'Partner' %}selected{% endif %}>Partner</option>
                                    <option value="Parent" {% if patient.emergency_contact_relationship == 'Parent' %}selected{% endif %}>Parent</option>
                                    <option value="Child" {% if patient.emergency_contact_relationship == 'Child' %}selected{% endif %}>Child</option>
                                    <option value="Sibling" {% if patient.emergency_contact_relationship == 'Sibling' %}selected{% endif %}>Sibling</option>
                                    <option value="Friend" {% if patient.emergency_contact_relationship == 'Friend' %}selected{% endif %}>Friend</option>
                                    <option value="Other" {% if patient.emergency_contact_relationship == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Medical Alerts & Notes Section -->
                    <div class="bg-white p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                            <span class="text-2xl mr-2">‚öïÔ∏è</span> Medical Information
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-red-600 mb-1">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Medical Alerts (Allergies, Conditions, etc.)
                                </label>
                                <textarea name="medical_alerts" rows="3" 
                                          placeholder="e.g., Allergic to penicillin, Diabetic"
                                          class="w-full px-3 py-2 border border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent bg-red-50">{{ patient.medical_alerts or '' }}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1">
                                    <i class="fas fa-notes-medical mr-1 text-brand-teal"></i>Additional Notes
                                </label>
                                <textarea name="notes" rows="3" 
                                          placeholder="Any additional information about the patient"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-teal focus:border-transparent">{{ patient.notes or '' }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                </div>
                
                <!-- Action Buttons (Fixed at bottom) -->
                <div class="flex gap-3 mt-4 p-4 bg-white border-t border-gray-200 rounded-b-lg">
                    <button type="submit" class="flex-1 px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold shadow-md">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="toggleEditMode()" class="flex-1 px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Appointments Card -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-calendar-check text-brand-bright-teal mr-2"></i>Appointments
            </h2>
            <button type="button" onclick="openAppointmentModal()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-plus mr-2"></i>Book Appointment
            </button>
        </div>
        
        <div id="appointmentsList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">Loading appointments...</p>
        </div>
    </div>
    
</div>

<!-- Patient Notes, Correspondence & Billing Tabs -->
<div class="bg-white rounded-lg shadow-md mb-8">
    <!-- Tab Headers -->
    <div class="border-b border-gray-200">
        <div class="flex">
            <button id="notesTab" onclick="switchTab('notes')" class="tab-button px-6 py-4 text-lg font-semibold border-b-2 border-brand-bright-teal text-brand-bright-teal">
                <i class="fas fa-notes-medical mr-2"></i>Notes
            </button>
            <button id="correspondenceTab" onclick="switchTab('correspondence')" class="tab-button px-6 py-4 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                <i class="fas fa-envelope mr-2"></i>Correspondence
            </button>
            <button id="billingTab" onclick="switchTab('billing')" class="tab-button px-6 py-4 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                <i class="fas fa-file-invoice-dollar mr-2"></i>Billing
            </button>
            <button id="videoCallTab" onclick="switchTab('videoCall')" class="tab-button px-6 py-4 text-lg font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                <i class="fas fa-video mr-2"></i>Video Call
            </button>
        </div>
    </div>
    
    <!-- Notes Tab Content -->
    <div id="notesContent" class="p-6">
        <div class="flex justify-between items-center mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Patient Notes</h2>
                <button onclick="updateExistingNotesWithSubjects()" 
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm transition font-semibold">
                    <i class="fas fa-sync mr-2"></i>Update Existing Notes
                </button>
            </div>
            <button type="button" onclick="openNoteModal()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-plus mr-2"></i>Add Note
            </button>
        </div>
        
        <div id="notesList" class="space-y-4">
            <p class="text-gray-500 text-center py-8">Loading notes...</p>
        </div>
    </div>
    
    <!-- Correspondence Tab Content -->
    <div id="correspondenceContent" class="p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Patient Correspondence</h2>
            <div class="flex gap-3">
                <button type="button" onclick="openCallModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    <i class="fas fa-phone mr-2"></i>Call Patient
                </button>
                <button type="button" onclick="openSmsModal()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-sms mr-2"></i>Send SMS
                </button>
            </div>
        </div>
        
        <div id="correspondenceList" class="space-y-4">
            <p class="text-gray-500 text-center py-8">Loading correspondence...</p>
        </div>
    </div>
    
    <!-- Billing Tab Content -->
    <div id="billingContent" class="p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-bold text-gray-800">Billing & Invoices</h2>
            <button type="button" onclick="openInvoiceModal()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-plus mr-2"></i>Create Invoice
            </button>
        </div>
        
        <div id="invoicesList" class="space-y-3">
            <p class="text-gray-500 text-center py-4">Loading invoices...</p>
        </div>
    </div>
    
    <!-- Video Call Tab Content -->
    <div id="videoCallContent" class="p-6 hidden">
        <div class="mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">
                <i class="fas fa-phone-volume text-blue-600 mr-2"></i>Telehealth Consultation
            </h2>
            <p class="text-gray-600">Start a consultation with {{ patient.first_name }} {{ patient.last_name }} via video or phone</p>
        </div>
        
        <!-- Communication Method Selector -->
        <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
            <label class="block text-sm font-semibold text-gray-700 mb-3">
                <i class="fas fa-toggle-on mr-2"></i>Choose Communication Method
            </label>
            <div class="flex gap-3">
                <button id="selectVideoCallBtn" onclick="selectCommunicationMethod('video')" 
                        class="flex-1 px-4 py-3 bg-indigo-600 text-white rounded-lg font-semibold transition hover:bg-indigo-700 flex items-center justify-center gap-2">
                    <i class="fas fa-video"></i>
                    <span>Video Call</span>
                </button>
                <button id="selectPhoneCallBtn" onclick="selectCommunicationMethod('phone')" 
                        class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold transition hover:bg-gray-300 flex items-center justify-center gap-2">
                    <i class="fas fa-phone"></i>
                    <span>Phone Call</span>
                </button>
            </div>
        </div>
        
        <!-- Video Call Section -->
        <div id="videoCallSection" class="mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-video text-indigo-600 mr-2"></i>Video Consultation
            </h3>
        
        <!-- Video Call Status -->
        <div id="videoCallStatus" class="mb-6">
            <!-- Pre-call View -->
            <div id="preCallView" class="text-center py-8">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 max-w-2xl mx-auto">
                    <i class="fas fa-video text-blue-600 text-5xl mb-4"></i>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Ready to Start Video Call</h3>
                    <p class="text-gray-600 mb-6">Click the button below to start a video consultation. You can send the room link to the patient via SMS.</p>
                    
                    <div class="flex gap-3 justify-center">
                        <button onclick="openVideoCallModal()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                            <i class="fas fa-video mr-2"></i>Start Video Consultation
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Call View -->
            <div id="activeVideoCall" class="hidden">
                <!-- Video Container -->
                <div class="bg-gray-900 rounded-lg overflow-hidden mb-4" style="min-height: 500px;">
                    <!-- Remote Participant Video (Large) -->
                    <div id="remoteVideoContainer" class="relative bg-gray-800" style="height: 400px;">
                        <div id="remoteParticipantVideo" class="w-full h-full flex items-center justify-center">
                            <div class="text-center text-white">
                                <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
                                <p class="text-lg">Waiting for patient to join...</p>
                            </div>
                        </div>
                        
                        <!-- Local Video (Small, Bottom Right) -->
                        <div id="localVideoContainer" class="absolute bottom-4 right-4 w-48 h-36 bg-gray-700 rounded-lg overflow-hidden border-2 border-white shadow-lg">
                            <div id="localParticipantVideo" class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-4xl opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Controls -->
                    <div class="bg-gray-800 px-6 py-4 flex items-center justify-between">
                        <!-- Call Info -->
                        <div class="text-white">
                            <div class="text-sm opacity-75">Call Duration</div>
                            <div id="videoCallDuration" class="text-xl font-semibold tabular-nums">00:00</div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex gap-3">
                            <button id="videoMuteBtn" onclick="toggleVideoMute()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition flex items-center gap-2 text-white">
                                <i class="fas fa-microphone"></i>
                                <span class="hidden sm:inline">Mute</span>
                            </button>
                            
                            <button id="videoToggleBtn" onclick="toggleVideoCamera()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition flex items-center gap-2 text-white">
                                <i class="fas fa-video"></i>
                                <span class="hidden sm:inline">Video</span>
                            </button>
                            
                            <button onclick="endVideoCall()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition flex items-center gap-2 text-white font-semibold">
                                <i class="fas fa-phone-slash"></i>
                                <span>End Call</span>
                            </button>
                        </div>
                        
                        <!-- Participant Count -->
                        <div class="text-white">
                            <div class="text-sm opacity-75">Participants</div>
                            <div id="participantCount" class="text-xl font-semibold">1</div>
                        </div>
                    </div>
                </div>
                
                <!-- Room Info -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <div class="flex items-start gap-3">
                        <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-700 mb-1">Patient Invite Link</p>
                            <div class="flex gap-2">
                                <input type="text" id="videoRoomUrl" readonly class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm" value="">
                                <button onclick="copyVideoUrl()" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                                <button onclick="sendVideoInvite()" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition text-sm">
                                    <i class="fas fa-sms mr-1"></i>SMS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Phone Call Section -->
        <div id="phoneCallSection" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-phone text-green-600 mr-2"></i>Phone Consultation
            </h3>
            
            <!-- Phone Call Status -->
            <div id="phoneCallStatus">
                <!-- Pre-call View -->
                <div id="prePhoneCallView" class="text-center py-8">
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6 max-w-2xl mx-auto">
                        <i class="fas fa-phone text-green-600 text-5xl mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Ready to Call Patient</h3>
                        <p class="text-gray-600 mb-4">Click the button below to initiate a phone call to {{ patient.first_name }} {{ patient.last_name }}</p>
                        
                        {% if patient.mobile or patient.phone %}
                        <div class="mb-6">
                            <div class="inline-flex items-center gap-2 bg-white border border-green-300 rounded-lg px-4 py-2">
                                <i class="fas fa-mobile-alt text-green-600"></i>
                                <span class="font-semibold text-gray-800">{{ patient.mobile or patient.phone }}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 justify-center">
                            <button onclick="initiatePhoneCall()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold inline-flex items-center">
                                <i class="fas fa-phone mr-2"></i>Call Patient
                            </button>
                        </div>
                        {% else %}
                        <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                            <span class="text-gray-700">No phone number on file for this patient</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Active Phone Call View -->
                <div id="activePhoneCall" class="hidden">
                    <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-8">
                        <div class="text-center mb-6">
                            <div class="inline-flex items-center justify-center w-24 h-24 bg-green-600 rounded-full mb-4 animate-pulse">
                                <i class="fas fa-phone text-white text-4xl"></i>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">Call In Progress</h3>
                            <p class="text-gray-600">Connected with {{ patient.first_name }} {{ patient.last_name }}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="bg-white rounded-lg p-4 text-center">
                                <div class="text-sm text-gray-600 mb-1">Phone Number</div>
                                <div class="font-semibold text-gray-800" id="activeCallPhone">{{ patient.mobile or patient.phone }}</div>
                            </div>
                            <div class="bg-white rounded-lg p-4 text-center">
                                <div class="text-sm text-gray-600 mb-1">Call Duration</div>
                                <div class="font-semibold text-gray-800 tabular-nums" id="phoneCallDuration">00:00</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-4 mb-6">
                            <div class="text-sm text-gray-600 mb-1">Call Status</div>
                            <div class="font-semibold text-gray-800" id="phoneCallStatusText">Connecting...</div>
                        </div>
                        
                        <div class="flex justify-center">
                            <button onclick="endPhoneCall()" class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold inline-flex items-center">
                                <i class="fas fa-phone-slash mr-2"></i>End Call
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Data Charts -->
{% if health_summary %}
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">
            <i class="fas fa-chart-line text-brand-bright-teal mr-2"></i>
            Health Data Trends
        </h2>
        <button onclick="openTargetRangesModal()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold inline-flex items-center">
            <i class="fas fa-bullseye mr-2"></i>Set Target Ranges
        </button>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {% if health_summary.get('weight') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-weight text-blue-500 mr-2"></i>
                Weight Trend
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-weight"></canvas>
            </div>
        </div>
        {% endif %}
        
        {% if health_summary.get('heart_rate') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-gray-700 flex items-center">
                    <i class="fas fa-watch text-red-500 mr-2"></i>
                    Heart Rate - Smartwatch (Daily Min/Max)
                </h3>
                <button onclick="resetWatchChart()" id="resetWatchBtn" class="hidden px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    <i class="fas fa-chart-bar mr-1"></i>Show Daily View
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-3">Click on any day to view intraday heart rate details</p>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-heart_rate_watch"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-weight-scale text-red-600 mr-2"></i>
                Heart Rate - Scale
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-heart_rate_scale"></canvas>
            </div>
        </div>
        {% endif %}
        
        {% if health_summary.get('systolic_bp') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-heart-pulse text-purple-500 mr-2"></i>
                Blood Pressure
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-blood_pressure"></canvas>
            </div>
        </div>
        {% endif %}
        
        {% if health_summary.get('steps') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-walking text-green-500 mr-2"></i>
                Daily Steps
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-steps"></canvas>
            </div>
        </div>
        {% endif %}
        
        {% if health_summary.get('sleep_duration') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-bed text-indigo-500 mr-2"></i>
                Sleep Duration
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-sleep_duration"></canvas>
            </div>
        </div>
        {% endif %}
        
        {% if health_summary.get('fat_mass') %}
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-percentage text-orange-500 mr-2"></i>
                Body Composition
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-body_comp"></canvas>
            </div>
        </div>
        {% endif %}
        
        <!-- Activity & Energy Charts -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-fire text-red-500 mr-2"></i>
                Total Calories Burned
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-total_calories"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-fire-flame-curved text-brand-soft-blue mr-2"></i>
                Active Calories
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-calories"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-route text-teal-500 mr-2"></i>
                Distance Traveled
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-distance"></canvas>
            </div>
        </div>
        
        <!-- Body Composition Details -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-droplet text-blue-400 mr-2"></i>
                Hydration Level
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-hydration"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-percent text-amber-500 mr-2"></i>
                Body Fat Percentage
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-fat_ratio"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-dumbbell text-emerald-600 mr-2"></i>
                Fat-Free Mass
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-fat_free_mass"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-bone text-gray-600 mr-2"></i>
                Bone Mass
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-bone_mass"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                Basal Metabolic Rate
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-basal_metabolic_rate"></canvas>
            </div>
        </div>
        
        <!-- Cardiovascular Health -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-heart-circle-check text-rose-500 mr-2"></i>
                Vascular Age
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-vascular_age"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-waveform-lines text-pink-600 mr-2"></i>
                Pulse Wave Velocity
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-pwv"></canvas>
            </div>
        </div>
        
        <!-- Sleep Quality Details -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-moon text-indigo-700 mr-2"></i>
                Deep Sleep Duration
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-deep_sleep"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-cloud-moon text-indigo-400 mr-2"></i>
                Light Sleep Duration
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-light_sleep"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-bed-pulse text-purple-500 mr-2"></i>
                Wake-Up Count
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-wakeup_count"></canvas>
            </div>
        </div>
        
        <!-- Fitness & Oxygen Metrics -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-lungs text-cyan-600 mr-2"></i>
                VO2 Max
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-vo2_max"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-wind text-sky-500 mr-2"></i>
                Blood Oxygen (SpO2)
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-spo2"></canvas>
            </div>
        </div>
        
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 class="font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-ruler-vertical text-slate-600 mr-2"></i>
                Height
            </h3>
            <div style="height: 400px; max-height: 400px;">
                <canvas id="chart-height"></canvas>
            </div>
        </div>
    </div>
</div>
{% else %}
<div class="bg-white rounded-lg shadow-md p-12 text-center">
    <i class="fas fa-chart-bar text-6xl text-gray-300 mb-4"></i>
    <p class="text-gray-600 text-lg mb-4">No health data available for this date range</p>
    {% if patient.withings_user_id %}
        <p class="text-gray-500 mb-6">Sync data to view health metrics</p>
        <form method="POST" action="{{ url_for('sync_patient', patient_id=patient.id) }}" class="inline">
            <input type="hidden" name="days_back" value="30">
            <button type="submit" class="bg-brand-bright-teal text-white px-6 py-3 rounded-lg hover:bg-brand-teal transition">
                <i class="fas fa-sync mr-2"></i>Sync Data
            </button>
        </form>
    {% else %}
        <p class="text-gray-500">Connect Withings device to start tracking</p>
    {% endif %}
</div>
{% endif %}

{% if devices %}
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-heartbeat text-red-600 mr-2"></i>
        Registered Devices
    </h2>
    <div class="grid md:grid-cols-2 gap-4">
        {% for device in devices %}
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="font-semibold text-gray-800">{{ device.device_type }}</p>
                    <p class="text-sm text-gray-600">{{ device.device_model or 'Unknown Model' }}</p>
                </div>
                <span class="px-2 py-1 text-xs font-semibold rounded-full {% if device.status == 'active' %}bg-green-100 text-brand-teal{% else %}bg-gray-200 text-gray-600{% endif %}">
                    {{ device.status }}
                </span>
            </div>
            {% if device.last_sync %}
            <p class="text-xs text-gray-500 mt-2">Last sync: {{ device.last_sync.strftime('%Y-%m-%d %H:%M') }}</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% if cliniko_notes %}
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <i class="fas fa-notes-medical text-brand-bright-teal mr-2"></i>
        Cliniko Treatment Notes
    </h2>
    <div class="space-y-4">
        {% for note in cliniko_notes %}
        <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <p class="text-sm text-gray-500">
                        {% if note.created_at %}
                            {{ note.created_at[:10] }}
                        {% endif %}
                    </p>
                </div>
                {% if not note.draft %}
                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-brand-teal">
                        Final
                    </span>
                {% else %}
                    <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                        Draft
                    </span>
                {% endif %}
            </div>
            <div class="prose max-w-none">
                {{ note.content|safe if note.content else 'No content' }}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Target Ranges Modal -->
<div id="targetRangesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-bullseye text-brand-bright-teal mr-2"></i>Health Metric Target Ranges
                </h3>
                <button onclick="closeTargetRangesModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6">
                <div id="targetRangesContent">
                    <div class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400"></i>
                        <p class="text-gray-500 mt-2">Loading target ranges...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Date range quick set function
function setDateRange(days) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);
    
    document.getElementById('end_date').value = endDate.toISOString().split('T')[0];
    document.getElementById('start_date').value = startDate.toISOString().split('T')[0];
    document.forms[0].submit();
}

// Wait for DOM to be fully loaded before initializing charts
document.addEventListener('DOMContentLoaded', function() {

// Healthcare color schemes
const healthColors = {
    weight: { line: 'rgb(59, 130, 246)', fill: 'rgba(59, 130, 246, 0.1)', normal: [60, 80] },
    heart_rate: { line: 'rgb(239, 68, 68)', fill: 'rgba(239, 68, 68, 0.1)', normal: [60, 100] },
    blood_pressure: { 
        systolic: { line: 'rgb(147, 51, 234)', fill: 'rgba(147, 51, 234, 0.1)', normal: [90, 120] },
        diastolic: { line: 'rgb(168, 85, 247)', fill: 'rgba(168, 85, 247, 0.1)', normal: [60, 80] }
    },
    steps: { line: 'rgb(34, 197, 94)', fill: 'rgba(34, 197, 94, 0.1)', target: 10000 },
    sleep_duration: { line: 'rgb(99, 102, 241)', fill: 'rgba(99, 102, 241, 0.1)', normal: [7, 9] },
    body_comp: { 
        fat: { line: 'rgb(249, 115, 22)', fill: 'rgba(249, 115, 22, 0.1)' },
        muscle: { line: 'rgb(6, 182, 212)', fill: 'rgba(6, 182, 212, 0.1)' }
    }
};

// Chart.js default configuration
Chart.defaults.font.family = "'Inter', sans-serif";
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
Chart.defaults.plugins.tooltip.padding = 12;
Chart.defaults.plugins.tooltip.cornerRadius = 8;

{% if health_summary.get('weight') %}
// Weight Chart
(function() {
    const data = {{ health_summary.weight|tojson }};
    const ctx = document.getElementById('chart-weight').getContext('2d');
    const unit = data[0]?.unit || 'kg';
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => new Date(d.timestamp)),
            datasets: [{
                label: 'Weight',
                data: data.map(d => d.value),
                borderColor: healthColors.weight.line,
                backgroundColor: healthColors.weight.fill,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: healthColors.weight.line,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return addTargetRangeToTooltip('weight', unit, 'Weight: ' + context.parsed.y.toFixed(1) + ' ' + unit);
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    min: Math.min(...data.map(d => d.value)) - 2,
                    max: Math.max(...data.map(d => d.value)) + 2,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' ' + unit;
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [createTargetRangePlugin('weight', unit)]
    });
})();
{% endif %}

{% if health_summary.get('heart_rate') %}
// Heart Rate Watch Chart - Box Plot with Min/Avg/Max
let watchChart = null;
let watchDailyData = [];

async function loadWatchDailyData() {
    try {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const url = '/patients/{{ patient.id }}/health_data/heart_rate/daily_minmax?start_date=' + startDate + '&end_date=' + endDate;
        const response = await fetch(url);
        const result = await response.json();
        watchDailyData = result.data;
        createWatchDailyChart();
    } catch (error) {
        console.error('Error loading watch daily data:', error);
    }
}

function createWatchDailyChart() {
    if (watchChart) {
        watchChart.destroy();
    }
    
    const ctx = document.getElementById('chart-heart_rate_watch').getContext('2d');
    
    if (!watchDailyData || watchDailyData.length === 0) {
        const canvas = document.getElementById('chart-heart_rate_watch');
        canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-lg">No smartwatch heart rate data available</div>';
        return;
    }
    
    document.getElementById('resetWatchBtn').classList.add('hidden');
    
    watchChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            labels: watchDailyData.map(d => d.date),
            datasets: [{
                label: 'Daily Average HR',
                data: watchDailyData.map(d => ({ x: new Date(d.date), y: d.avg })),
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: '#ef4444',
                borderWidth: 2,
                pointStyle: 'rectRot',
                pointRadius: 8,
                pointHoverRadius: 10,
                errorBars: {
                    min: watchDailyData.map(d => d.min),
                    max: watchDailyData.map(d => d.max)
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            onClick: async (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const clickedDate = watchDailyData[index].date;
                    await loadWatchIntradayData(clickedDate);
                }
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const data = watchDailyData[index];
                            return [
                                'Average: ' + data.avg + ' bpm',
                                'Min: ' + data.min + ' bpm',
                                'Max: ' + data.max + ' bpm',
                                '',
                                'Click to view intraday details'
                            ];
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: false,
                    min: 40,
                    max: 200,
                    ticks: {
                        callback: function(value) {
                            return Math.round(value) + ' bpm';
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [createTargetRangePlugin('heart_rate', 'bpm'), {
            id: 'errorBars',
            afterDatasetDraw: function(chart, args) {
                const ctx = chart.ctx;
                const dataset = args.meta.dataset;
                const data = args.meta.data;
                
                ctx.save();
                ctx.strokeStyle = '#dc2626';
                ctx.lineWidth = 1.5;
                
                data.forEach((bar, index) => {
                    const x = bar.x;
                    const yMin = chart.scales.y.getPixelForValue(watchDailyData[index].min);
                    const yMax = chart.scales.y.getPixelForValue(watchDailyData[index].max);
                    
                    // Draw vertical line from min to max
                    ctx.beginPath();
                    ctx.moveTo(x, yMin);
                    ctx.lineTo(x, yMax);
                    ctx.stroke();
                    
                    // Draw caps at min and max
                    const capWidth = 6;
                    ctx.beginPath();
                    ctx.moveTo(x - capWidth, yMin);
                    ctx.lineTo(x + capWidth, yMin);
                    ctx.stroke();
                    
                    ctx.beginPath();
                    ctx.moveTo(x - capWidth, yMax);
                    ctx.lineTo(x + capWidth, yMax);
                    ctx.stroke();
                });
                
                ctx.restore();
            }
        }]
    });
}

async function loadWatchIntradayData(date) {
    try {
        const response = await fetch('/patients/{{ patient.id }}/health_data/heart_rate?device_source=watch&date=' + date);
        const result = await response.json();
        const intradayData = result.data;
        
        if (watchChart) {
            watchChart.destroy();
        }
        
        const ctx = document.getElementById('chart-heart_rate_watch').getContext('2d');
        
        document.getElementById('resetWatchBtn').classList.remove('hidden');
        
        watchChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: intradayData.map(d => new Date(d.timestamp)),
                datasets: [{
                    label: 'Heart Rate',
                    data: intradayData.map(d => d.value),
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 2,
                    pointHoverRadius: 4,
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Intraday Heart Rate - ' + new Date(date).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const time = new Date(context.parsed.x).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                return 'HR: ' + Math.round(context.parsed.y) + ' bpm at ' + time;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false }
                    },
                    y: {
                        min: intradayData.length > 0 ? Math.max(40, Math.min(...intradayData.map(d => d.value)) - 10) : 40,
                        max: intradayData.length > 0 ? Math.min(200, Math.max(...intradayData.map(d => d.value)) + 10) : 120,
                        ticks: {
                            callback: function(value) {
                                return Math.round(value) + ' bpm';
                            }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading intraday data:', error);
    }
}

window.resetWatchChart = function() {
    document.getElementById('resetWatchBtn').classList.add('hidden');
    loadWatchDailyData();
}

loadWatchDailyData();

// Heart Rate Scale Chart - includes historical data
(async function() {
    try {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        const response = await fetch(`/patients/{{ patient.id }}/health_data/heart_rate?device_source=scale_or_null&start_date=${startDate}&end_date=${endDate}`);
        const result = await response.json();
        const chartData = result.data;
        
        const ctx = document.getElementById('chart-heart_rate_scale').getContext('2d');
        
        if (!chartData || chartData.length === 0) {
            const canvas = document.getElementById('chart-heart_rate_scale');
            canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-lg">No scale heart rate data available</div>';
            return;
        }
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartData.map(d => new Date(d.timestamp)),
                datasets: [{
                    label: 'Heart Rate (Scale)',
                    data: chartData.map(d => d.value),
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#dc2626',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const date = new Date(context.parsed.x).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                                return 'HR: ' + Math.round(context.parsed.y) + ' bpm (' + date + ')';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                        grid: { display: false }
                    },
                    y: {
                        min: chartData.length > 0 ? Math.max(40, Math.min(...chartData.map(d => d.value)) - 10) : 40,
                        max: chartData.length > 0 ? Math.min(200, Math.max(...chartData.map(d => d.value)) + 10) : 120,
                        ticks: {
                            callback: function(value) {
                                return Math.round(value) + ' bpm';
                            }
                        },
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    }
                }
            },
            plugins: [createTargetRangePlugin('heart_rate', 'bpm')]
        });
    } catch (error) {
        console.error('Error loading scale heart rate data:', error);
    }
})();
{% endif %}

{% if health_summary.get('systolic_bp') and health_summary.get('diastolic_bp') %}
// Blood Pressure Chart
(function() {
    const systolicData = {{ health_summary.systolic_bp|tojson }};
    const diastolicData = {{ health_summary.diastolic_bp|tojson }};
    const ctx = document.getElementById('chart-blood_pressure').getContext('2d');
    
    // Custom plugin for blood pressure with two ranges
    const bpTargetRangePlugin = {
        id: 'bpTargetRangePlugin',
        beforeDatasetsDraw: (chart) => {
            const { ctx, chartArea: { left, right }, scales: { y } } = chart;
            
            // Draw systolic range
            const systolicRange = targetRanges['systolic_bp'];
            if (systolicRange && systolicRange.min !== null && systolicRange.min !== '' && 
                systolicRange.max !== null && systolicRange.max !== '') {
                const minVal = parseFloat(systolicRange.min);
                const maxVal = parseFloat(systolicRange.max);
                if (!isNaN(minVal) && !isNaN(maxVal)) {
                    const minY = y.getPixelForValue(maxVal);
                    const maxY = y.getPixelForValue(minVal);
                    ctx.save();
                    ctx.fillStyle = 'rgba(147, 51, 234, 0.1)';
                    ctx.fillRect(left, minY, right - left, maxY - minY);
                    ctx.strokeStyle = 'rgba(147, 51, 234, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(left, minY, right - left, maxY - minY);
                    ctx.restore();
                }
            }
            
            // Draw diastolic range
            const diastolicRange = targetRanges['diastolic_bp'];
            if (diastolicRange && diastolicRange.min !== null && diastolicRange.min !== '' && 
                diastolicRange.max !== null && diastolicRange.max !== '') {
                const minVal = parseFloat(diastolicRange.min);
                const maxVal = parseFloat(diastolicRange.max);
                if (!isNaN(minVal) && !isNaN(maxVal)) {
                    const minY = y.getPixelForValue(maxVal);
                    const maxY = y.getPixelForValue(minVal);
                    ctx.save();
                    ctx.fillStyle = 'rgba(168, 85, 247, 0.1)';
                    ctx.fillRect(left, minY, right - left, maxY - minY);
                    ctx.strokeStyle = 'rgba(168, 85, 247, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([3, 3]);
                    ctx.strokeRect(left, minY, right - left, maxY - minY);
                    ctx.restore();
                }
            }
        }
    };
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: systolicData.map(d => new Date(d.timestamp)),
            datasets: [{
                label: 'Systolic',
                data: systolicData.map(d => d.value),
                borderColor: healthColors.blood_pressure.systolic.line,
                backgroundColor: healthColors.blood_pressure.systolic.fill,
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }, {
                label: 'Diastolic',
                data: diastolicData.map(d => d.value),
                borderColor: healthColors.blood_pressure.diastolic.line,
                backgroundColor: healthColors.blood_pressure.diastolic.fill,
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    labels: { usePointStyle: true, padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const measurementType = context.dataset.label.toLowerCase() === 'systolic' ? 'systolic_bp' : 'diastolic_bp';
                            return addTargetRangeToTooltip(measurementType, 'mmHg', context.dataset.label + ': ' + Math.round(context.parsed.y) + ' mmHg');
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: false,
                    min: 40,
                    max: 160,
                    ticks: {
                        callback: function(value) {
                            return value + ' mmHg';
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [bpTargetRangePlugin]
    });
})();
{% endif %}

{% if health_summary.get('steps') %}
// Steps Chart
(function() {
    const data = {{ health_summary.steps|tojson }};
    const ctx = document.getElementById('chart-steps').getContext('2d');
    
    // Custom plugin for steps - can handle both range and single target
    const stepsTargetPlugin = {
        id: 'stepsTargetPlugin',
        beforeDatasetsDraw: (chart) => {
            const { ctx, chartArea: { left, right }, scales: { y } } = chart;
            const targetRange = targetRanges['steps'];
            
            if (targetRange) {
                // Check if it's a range (min/max) or single target value
                if (targetRange.min !== null && targetRange.min !== '' && 
                    targetRange.max !== null && targetRange.max !== '') {
                    // Range mode
                    const minVal = parseFloat(targetRange.min);
                    const maxVal = parseFloat(targetRange.max);
                    if (!isNaN(minVal) && !isNaN(maxVal)) {
                        const minY = y.getPixelForValue(maxVal);
                        const maxY = y.getPixelForValue(minVal);
                        ctx.save();
                        ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                        ctx.fillRect(left, minY, right - left, maxY - minY);
                        ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.strokeRect(left, minY, right - left, maxY - minY);
                        ctx.restore();
                    }
                } else if (targetRange.target !== null && targetRange.target !== '') {
                    // Single target value - draw as a horizontal line
                    const targetVal = parseFloat(targetRange.target);
                    if (!isNaN(targetVal)) {
                        const targetY = y.getPixelForValue(targetVal);
                        ctx.save();
                        ctx.strokeStyle = 'rgba(34, 197, 94, 0.7)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(left, targetY);
                        ctx.lineTo(right, targetY);
                        ctx.stroke();
                        ctx.restore();
                    }
                }
            }
        }
    };
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => new Date(d.timestamp)),
            datasets: [{
                label: 'Daily Steps',
                data: data.map(d => d.value),
                backgroundColor: data.map(d => d.value >= 10000 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(59, 130, 246, 0.8)'),
                borderColor: data.map(d => d.value >= 10000 ? 'rgb(34, 197, 94)' : 'rgb(59, 130, 246)'),
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const targetRange = targetRanges['steps'];
                            let label = 'Steps: ' + context.parsed.y.toLocaleString();
                            if (targetRange) {
                                if (targetRange.min && targetRange.max) {
                                    label += ' (Target: ' + parseFloat(targetRange.min).toLocaleString() + '-' + parseFloat(targetRange.max).toLocaleString() + ' steps)';
                                } else if (targetRange.target) {
                                    label += ' (Target: ' + parseFloat(targetRange.target).toLocaleString() + ' steps)';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    min: 0,
                    max: Math.max(...data.map(d => d.value)) + 2000,
                    ticks: {
                        callback: function(value) {
                            return value >= 1000 ? (value / 1000).toFixed(1) + 'k' : value;
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [stepsTargetPlugin]
    });
})();
{% endif %}

{% if health_summary.get('sleep_duration') %}
// Sleep Duration Chart
(function() {
    const data = {{ health_summary.sleep_duration|tojson }};
    const ctx = document.getElementById('chart-sleep_duration').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => new Date(d.timestamp)),
            datasets: [{
                label: 'Sleep Duration',
                data: data.map(d => d.value),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const hours = Math.floor(context.parsed.y);
                            const minutes = Math.round((context.parsed.y - hours) * 60);
                            return addTargetRangeToTooltip('sleep_duration', 'hours', 'Sleep: ' + hours + 'h ' + minutes + 'm');
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    min: 0,
                    max: 12,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + 'h';
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [createTargetRangePlugin('sleep_duration', 'hours')]
    });
})();
{% endif %}

{% if health_summary.get('fat_mass') %}
// Body Composition Chart
(function() {
    const fatData = {{ health_summary.fat_mass|tojson }};
    const muscleMassData = {{ health_summary.get('muscle_mass', [])|tojson }};
    
    const ctx = document.getElementById('chart-body_comp').getContext('2d');
    
    const datasets = [{
        label: 'Fat Mass',
        data: fatData.map(d => d.value),
        borderColor: healthColors.body_comp.fat.line,
        backgroundColor: healthColors.body_comp.fat.fill,
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        yAxisID: 'y'
    }];
    
    if (muscleMassData.length > 0) {
        datasets.push({
            label: 'Muscle Mass',
            data: muscleMassData.map(d => d.value),
            borderColor: healthColors.body_comp.muscle.line,
            backgroundColor: healthColors.body_comp.muscle.fill,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
        });
    }
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: fatData.map(d => new Date(d.timestamp)),
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    labels: { usePointStyle: true, padding: 15 }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    min: Math.min(...fatData.map(d => d.value), ...(muscleMassData.length > 0 ? muscleMassData.map(d => d.value) : [])) - 2,
                    max: Math.max(...fatData.map(d => d.value), ...(muscleMassData.length > 0 ? muscleMassData.map(d => d.value) : [])) + 2,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(1) + ' ' + fatData[0].unit;
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    });
})();
{% endif %}

// Helper function to create chart with "No Data" message and target range bands
function createChartOrNoData(canvasId, data, chartLabel, color, unit, options = {}) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    if (!data || data.length === 0) {
        // Draw "No Data Available" message
        const container = canvas.parentElement;
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.innerHTML = '<div class="text-center text-gray-400"><i class="fas fa-chart-line text-4xl mb-2"></i><p class="text-lg font-semibold">No Data Available</p><p class="text-sm">Sync data to view this metric</p></div>';
        return;
    }
    
    const minValue = options.minValue !== undefined ? options.minValue : Math.min(...data.map(d => d.value)) - (options.padding || 2);
    const maxValue = options.maxValue !== undefined ? options.maxValue : Math.max(...data.map(d => d.value)) + (options.padding || 2);
    
    // Get measurement type from canvasId (e.g., "chart-weight" -> "weight")
    const measurementType = canvasId.replace('chart-', '');
    const targetRange = targetRanges[measurementType];
    
    // Custom plugin to draw target range band
    const targetRangePlugin = {
        id: 'targetRangePlugin',
        beforeDatasetsDraw: (chart) => {
            if (targetRange && targetRange.min !== null && targetRange.min !== '' && 
                targetRange.max !== null && targetRange.max !== '') {
                const minVal = parseFloat(targetRange.min);
                const maxVal = parseFloat(targetRange.max);
                
                if (!isNaN(minVal) && !isNaN(maxVal)) {
                    const { ctx, chartArea: { left, right }, scales: { y } } = chart;
                    const minY = y.getPixelForValue(maxVal);
                    const maxY = y.getPixelForValue(minVal);
                    
                    ctx.save();
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                    ctx.fillRect(left, minY, right - left, maxY - minY);
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.4)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(left, minY, right - left, maxY - minY);
                    ctx.restore();
                }
            }
        }
    };
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => new Date(d.timestamp)),
            datasets: [{
                label: chartLabel,
                data: data.map(d => d.value),
                borderColor: color.line,
                backgroundColor: color.fill,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: color.line,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = chartLabel + ': ' + (options.decimals !== undefined ? context.parsed.y.toFixed(options.decimals) : Math.round(context.parsed.y)) + ' ' + unit;
                            if (targetRange && targetRange.min !== null && targetRange.min !== '' && 
                                targetRange.max !== null && targetRange.max !== '') {
                                const minVal = parseFloat(targetRange.min);
                                const maxVal = parseFloat(targetRange.max);
                                if (!isNaN(minVal) && !isNaN(maxVal)) {
                                    label += ' (Target: ' + minVal + '-' + maxVal + ' ' + unit + ')';
                                }
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: 'day', displayFormats: { day: 'MMM d' } },
                    grid: { display: false }
                },
                y: {
                    min: minValue,
                    max: maxValue,
                    ticks: {
                        callback: function(value) {
                            return (options.decimals !== undefined ? value.toFixed(options.decimals) : Math.round(value)) + ' ' + unit;
                        }
                    },
                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                }
            }
        },
        plugins: [targetRangePlugin]
    });
}

// Total Calories Chart
createChartOrNoData('chart-total_calories', {{ health_summary.get('total_calories', [])|tojson }}, 'Total Calories', 
    { line: 'rgb(239, 68, 68)', fill: 'rgba(239, 68, 68, 0.1)' }, 'kcal', { minValue: 0, padding: 500 });

// Active Calories Chart
createChartOrNoData('chart-calories', {{ health_summary.get('calories', [])|tojson }}, 'Active Calories', 
    { line: 'rgb(251, 146, 60)', fill: 'rgba(251, 146, 60, 0.1)' }, 'kcal', { minValue: 0, padding: 300 });

// Distance Chart
createChartOrNoData('chart-distance', {{ health_summary.get('distance', [])|tojson }}, 'Distance', 
    { line: 'rgb(20, 184, 166)', fill: 'rgba(20, 184, 166, 0.1)' }, 'm', { minValue: 0, padding: 1000 });

// Hydration Chart
createChartOrNoData('chart-hydration', {{ health_summary.get('hydration', [])|tojson }}, 'Hydration', 
    { line: 'rgb(96, 165, 250)', fill: 'rgba(96, 165, 250, 0.1)' }, '%', { padding: 2, decimals: 1 });

// Body Fat Percentage Chart
createChartOrNoData('chart-fat_ratio', {{ health_summary.get('fat_ratio', [])|tojson }}, 'Body Fat %', 
    { line: 'rgb(245, 158, 11)', fill: 'rgba(245, 158, 11, 0.1)' }, '%', { padding: 2, decimals: 1 });

// Fat-Free Mass Chart
createChartOrNoData('chart-fat_free_mass', {{ health_summary.get('fat_free_mass', [])|tojson }}, 'Fat-Free Mass', 
    { line: 'rgb(16, 185, 129)', fill: 'rgba(16, 185, 129, 0.1)' }, 'kg', { padding: 2, decimals: 1 });

// Bone Mass Chart
createChartOrNoData('chart-bone_mass', {{ health_summary.get('bone_mass', [])|tojson }}, 'Bone Mass', 
    { line: 'rgb(107, 114, 128)', fill: 'rgba(107, 114, 128, 0.1)' }, 'kg', { padding: 0.2, decimals: 2 });

// BMR Chart
createChartOrNoData('chart-basal_metabolic_rate', {{ health_summary.get('basal_metabolic_rate', [])|tojson }}, 'BMR', 
    { line: 'rgb(234, 179, 8)', fill: 'rgba(234, 179, 8, 0.1)' }, 'kcal', { padding: 100 });

// Vascular Age Chart
createChartOrNoData('chart-vascular_age', {{ health_summary.get('vascular_age', [])|tojson }}, 'Vascular Age', 
    { line: 'rgb(244, 63, 94)', fill: 'rgba(244, 63, 94, 0.1)' }, 'years', { padding: 2 });

// PWV Chart
createChartOrNoData('chart-pwv', {{ health_summary.get('pwv', [])|tojson }}, 'Pulse Wave Velocity', 
    { line: 'rgb(236, 72, 153)', fill: 'rgba(236, 72, 153, 0.1)' }, 'm/s', { padding: 0.5, decimals: 1 });

// Deep Sleep Chart
createChartOrNoData('chart-deep_sleep', {{ health_summary.get('deep_sleep', [])|tojson }}, 'Deep Sleep', 
    { line: 'rgb(67, 56, 202)', fill: 'rgba(67, 56, 202, 0.1)' }, 'h', { minValue: 0, maxValue: 5, decimals: 1 });

// Light Sleep Chart
createChartOrNoData('chart-light_sleep', {{ health_summary.get('light_sleep', [])|tojson }}, 'Light Sleep', 
    { line: 'rgb(129, 140, 248)', fill: 'rgba(129, 140, 248, 0.1)' }, 'h', { minValue: 0, maxValue: 8, decimals: 1 });

// Wake-Up Count Chart
createChartOrNoData('chart-wakeup_count', {{ health_summary.get('wakeup_count', [])|tojson }}, 'Wake-Up Count', 
    { line: 'rgb(168, 85, 247)', fill: 'rgba(168, 85, 247, 0.1)' }, 'times', { minValue: 0, padding: 2 });

// VO2 Max Chart
createChartOrNoData('chart-vo2_max', {{ health_summary.get('vo2_max', [])|tojson }}, 'VO2 Max', 
    { line: 'rgb(8, 145, 178)', fill: 'rgba(8, 145, 178, 0.1)' }, 'ml/kg/min', { padding: 2 });

// SpO2 Chart
createChartOrNoData('chart-spo2', {{ health_summary.get('spo2', [])|tojson }}, 'Blood Oxygen', 
    { line: 'rgb(14, 165, 233)', fill: 'rgba(14, 165, 233, 0.1)' }, '%', { minValue: 90, maxValue: 100, decimals: 1 });

// Height Chart
createChartOrNoData('chart-height', {{ health_summary.get('height', [])|tojson }}, 'Height', 
    { line: 'rgb(100, 116, 139)', fill: 'rgba(100, 116, 139, 0.1)' }, 'm', { padding: 0.02, decimals: 2 });

});  // End DOMContentLoaded

// Patient Information Edit Toggle
function toggleEditMode() {
    const viewMode = document.getElementById('patientInfoView');
    const editMode = document.getElementById('patientInfoEdit');
    const editBtn = document.getElementById('editToggleBtn');
    
    if (viewMode.style.display === 'none') {
        viewMode.style.display = 'block';
        editMode.style.display = 'none';
        editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Edit';
    } else {
        viewMode.style.display = 'none';
        editMode.style.display = 'block';
        editBtn.innerHTML = '<i class="fas fa-eye mr-2"></i>View';
        
        // Calculate age when entering edit mode
        setTimeout(() => calculateAge(), 100);
    }
}

// Calculate Age from DOB
function calculateAge() {
    const dobInput = document.getElementById('dobInput');
    const ageDisplay = document.getElementById('ageDisplay');
    
    if (!dobInput || !ageDisplay) return;
    
    const dobValue = dobInput.value;
    if (!dobValue) {
        ageDisplay.textContent = '';
        return;
    }
    
    const dob = new Date(dobValue);
    const today = new Date();
    let age = today.getFullYear() - dob.getFullYear();
    const monthDiff = today.getMonth() - dob.getMonth();
    
    // Adjust age if birthday hasn't occurred this year
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
        age--;
    }
    
    // Calculate months for children under 2 years
    if (age < 2) {
        const months = monthDiff + (age * 12);
        const adjustedMonths = today.getDate() < dob.getDate() ? months - 1 : months;
        
        if (adjustedMonths < 24) {
            ageDisplay.innerHTML = `<i class="fas fa-birthday-cake mr-1"></i><strong>${adjustedMonths} months old</strong>`;
            return;
        }
    }
    
    ageDisplay.innerHTML = `<i class="fas fa-birthday-cake mr-1"></i><strong>${age} years old</strong>`;
}

// Patient Information Tab Switching
function switchPatientTab(tab) {
    const basicContent = document.getElementById('basicInfoContent');
    const registrationContent = document.getElementById('registrationInfoContent');
    const videoContent = document.getElementById('videoInfoContent');
    const basicTab = document.getElementById('basicInfoTab');
    const registrationTab = document.getElementById('registrationInfoTab');
    const videoTab = document.getElementById('videoInfoTab');
    
    // Hide all content
    basicContent.classList.add('hidden');
    registrationContent.classList.add('hidden');
    videoContent.classList.add('hidden');
    
    // Reset all tabs
    [basicTab, registrationTab, videoTab].forEach(t => {
        t.classList.remove('text-brand-bright-teal', 'border-brand-bright-teal');
        t.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Show selected tab
    if (tab === 'basic') {
        basicContent.classList.remove('hidden');
        basicTab.classList.remove('text-gray-500', 'border-transparent');
        basicTab.classList.add('text-brand-bright-teal', 'border-brand-bright-teal');
    } else if (tab === 'registration') {
        registrationContent.classList.remove('hidden');
        registrationTab.classList.remove('text-gray-500', 'border-transparent');
        registrationTab.classList.add('text-brand-bright-teal', 'border-brand-bright-teal');
    } else if (tab === 'video') {
        videoContent.classList.remove('hidden');
        videoTab.classList.remove('text-gray-500', 'border-transparent');
        videoTab.classList.add('text-brand-bright-teal', 'border-brand-bright-teal');
    }
}

// Patient Deletion
async function confirmDeletePatient() {
    const patientName = '{{ patient.first_name }} {{ patient.last_name }}';
    
    const confirmed = await showConfirm(
        `Are you sure you want to delete ${patientName}?\n\nThis will permanently delete:\n‚Ä¢ Patient record\n‚Ä¢ All health data\n‚Ä¢ All appointments\n‚Ä¢ All notes\n‚Ä¢ All devices\n\nThis action CANNOT be undone!`,
        'danger'
    );
    
    if (confirmed) {
        window.location.href = '{{ url_for("delete_patient", patient_id=patient.id) }}';
    }
}

// Send Withings connection email to patient
async function sendWithingsEmailToPatient() {
    const patientName = '{{ patient.first_name }} {{ patient.last_name }}';
    const patientEmail = '{{ patient.email }}';
    
    if (!patientEmail) {
        await showAlert('Patient email not set. Please add an email address first.', 'error');
        return;
    }
    
    const confirmed = await showConfirm(
        `Send Withings connection link to ${patientName} at ${patientEmail}?`,
        'info'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch('/api/patients/{{ patient.id }}/send-withings-email', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            await showAlert('Email sent successfully to ' + patientEmail, 'success');
        } else {
            await showAlert('Failed to send email: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error sending email:', error);
        await showAlert('Error sending email: ' + error.message, 'error');
    }
}

// Appointments Management
async function loadAppointments() {
    try {
        const response = await fetch(`/patients/{{ patient.id }}/appointments`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const result = await response.json();
        
        const listElement = document.getElementById('appointmentsList');
        if (!listElement) {
            console.warn('appointmentsList element not found');
            return;
        }
        
        // Handle both response formats: {success: true, appointments: [...]} or just [...]
        const appointments = result.appointments || result;
        
        if (!Array.isArray(appointments) || appointments.length === 0) {
            listElement.innerHTML = '<p class="text-gray-500 text-center py-4"><i class="fas fa-calendar-plus mr-2"></i>No appointments scheduled</p>';
            return;
        }
        
        const upcoming = appointments.filter(appt => {
            try {
                return appt.start_time && new Date(appt.start_time) >= new Date();
            } catch {
                return false;
            }
        });
        const past = appointments.filter(appt => {
            try {
                return appt.start_time && new Date(appt.start_time) < new Date();
            } catch {
                return false;
            }
        });
        
        let html = '';
        
        if (upcoming.length > 0) {
            html += '<div class="mb-4"><h3 class="font-semibold text-gray-700 mb-2">Upcoming</h3>';
            upcoming.forEach(appt => {
                html += renderAppointmentCard(appt);
            });
            html += '</div>';
        }
        
        if (past.length > 0 && past.length <= 3) {
            html += '<div><h3 class="font-semibold text-gray-700 mb-2">Recent Past</h3>';
            past.slice(0, 3).forEach(appt => {
                html += renderAppointmentCard(appt, true);
            });
            html += '</div>';
        }
        
        listElement.innerHTML = html || '<p class="text-gray-500 text-center py-4">No appointments</p>';
    } catch (error) {
        console.error('Error loading appointments:', error?.message || error);
        const listElement = document.getElementById('appointmentsList');
        if (listElement) {
            listElement.innerHTML = '<p class="text-red-500 text-center py-4">Error loading appointments</p>';
        }
    }
}

function renderAppointmentCard(appt, isPast = false) {
    const startDate = new Date(appt.start_time);
    const dateStr = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const timeStr = startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    
    return `
        <div class="border ${isPast ? 'border-gray-300 bg-gray-50' : 'border-blue-300 bg-brand-cream'} rounded-lg p-3">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-semibold ${isPast ? 'text-gray-700' : 'text-blue-900'}">${appt.title}</p>
                    <p class="text-sm text-gray-600"><i class="fas fa-calendar mr-1"></i>${dateStr} at ${timeStr}</p>
                    ${appt.location ? `<p class="text-sm text-gray-600"><i class="fas fa-map-marker-alt mr-1"></i>${appt.location}</p>` : ''}
                    ${(appt.practitioner_name || appt.practitioner) ? `<p class="text-sm text-gray-600"><i class="fas fa-user-md mr-1"></i>${appt.practitioner_name || appt.practitioner}</p>` : ''}
                </div>
                ${!isPast ? `<div class="flex gap-2">
                    <button onclick="openEditAppointmentModal(${appt.id}, '${appt.title}', '${appt.appointment_type || ''}', '${appt.start_time}', ${appt.duration_minutes || 60}, '${appt.location || ''}', '${appt.practitioner || ''}', '${appt.notes || ''}', ${isPast})" class="text-brand-bright-teal hover:text-brand-teal transition" title="Edit appointment">
                        <i class="fas fa-pencil-alt"></i>
                    </button>
                    <button onclick="deleteAppointment(${appt.id})" class="text-red-500 hover:text-red-700 transition" title="Delete appointment">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>` : ''}
            </div>
        </div>
    `;
}

function openAppointmentModal() {
    document.getElementById('appointmentModal').classList.remove('hidden');
    
    // Pre-select allocated practitioner if available
    const allocatedPractitionerId = '{{ patient.allocated_practitioner_id or "" }}';
    const practitionerSelect = document.getElementById('bookPractitioner');
    
    if (allocatedPractitionerId && practitionerSelect) {
        practitionerSelect.value = allocatedPractitionerId;
        // Automatically load available dates for the allocated practitioner
        setTimeout(() => loadBookAvailableTimeSlots(), 100);
    }
}

function closeAppointmentModal() {
    document.getElementById('appointmentModal').classList.add('hidden');
    document.getElementById('appointmentForm').reset();
    document.getElementById('bookTimeSlotsContainer').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Select a practitioner, duration, and date to see available times</p>';
}

// Load available DATES first (new UX flow)
async function loadBookAvailableTimeSlots() {
    const practitionerId = document.getElementById('bookPractitioner').value;
    const duration = parseInt(document.getElementById('bookDuration').value);
    const dateLoading = document.getElementById('bookDateLoading');
    const datesContainer = document.getElementById('bookAvailableDatesContainer');
    const timeSlotsContainer = document.getElementById('bookTimeSlotsContainer');
    
    // Reset state
    datesContainer.innerHTML = '';
    timeSlotsContainer.innerHTML = '';
    timeSlotsContainer.classList.add('hidden');
    document.getElementById('bookDate').value = '';
    document.getElementById('bookTime').value = '';
    
    if (!practitionerId || !duration) {
        datesContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Select a practitioner and duration to see available dates</p>';
        return;
    }
    
    if (practitionerId === 'any') {
        datesContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Please select a specific practitioner to see available dates</p>';
        return;
    }
    
    // Show loading
    dateLoading.classList.remove('hidden');
    datesContainer.innerHTML = '';
    
    try {
        // Get available dates for next 60 days (starting from today)
        const today = new Date();
        today.setHours(0, 0, 0, 0);  // Reset time to start of day
        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + 60);
        
        // Generate array of dates (only future dates)
        const dates = [];
        const currentDate = new Date(today);
        while (currentDate <= endDate) {
            dates.push(currentDate.toISOString().split('T')[0]);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        
        // Fetch batch availability using POST
        const response = await fetch('/api/calendar/availability/batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                practitioner_ids: [parseInt(practitionerId)],
                dates: dates,
                duration: duration
            })
        });
        const data = await response.json();
        
        dateLoading.classList.add('hidden');
        
        if (!data.success || !data.availability) {
            datesContainer.innerHTML = '<p class="text-sm text-orange-600 text-center py-8">Error loading availability. Please try again.</p>';
            console.error('Batch availability error:', data);
            return;
        }
        
        // Convert practitioner ID to string since JSON keys are strings
        const practitionerIdStr = practitionerId.toString();
        
        if (!data.availability[practitionerIdStr]) {
            datesContainer.innerHTML = '<p class="text-sm text-orange-600 text-center py-8">No availability found for this practitioner in the next 60 days</p>';
            console.log('Available practitioner IDs:', Object.keys(data.availability));
            return;
        }
        
        const availability = data.availability[practitionerIdStr];
        const availableDates = [];
        const now = new Date();
        
        // Find dates with available slots (only future dates)
        for (const dateStr in availability) {
            const dayData = availability[dateStr];
            const appointmentDate = new Date(dateStr + 'T00:00:00');
            
            // Only include today or future dates
            if (appointmentDate >= today && dayData && dayData.available_slots && dayData.available_slots.length > 0) {
                availableDates.push(dateStr);
            }
        }
        
        if (availableDates.length === 0) {
            datesContainer.innerHTML = '<p class="text-sm text-orange-600 text-center py-8"><i class="fas fa-calendar-times mr-2"></i>No available time slots for this practitioner in the next 60 days. The practitioner may not have availability configured, or all slots are booked.</p>';
            return;
        }
        
        // Display available dates as clickable cards
        datesContainer.innerHTML = '<p class="text-xs text-gray-600 mb-3 text-center">Click a date to see available times:</p>';
        
        const datesGrid = document.createElement('div');
        datesGrid.className = 'grid grid-cols-3 sm:grid-cols-4 gap-2 max-h-[400px] overflow-y-auto p-2';
        
        availableDates.slice(0, 30).forEach(dateStr => {
            const date = new Date(dateStr + 'T12:00:00');
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const slotsCount = availability[dateStr].available_slots.length;
            
            const dateCard = document.createElement('button');
            dateCard.type = 'button';
            dateCard.className = 'p-3 rounded-lg border-2 border-gray-300 hover:border-brand-bright-teal hover:bg-brand-bright-teal hover:bg-opacity-10 transition-all text-center';
            dateCard.innerHTML = `
                <div class="font-bold text-sm text-gray-800">${dayName}</div>
                <div class="text-xs text-gray-600 mt-1">${monthDay}</div>
                <div class="text-xs text-green-600 mt-1">${slotsCount} slots</div>
            `;
            dateCard.onclick = () => selectDateAndLoadTimes(dateStr);
            
            datesGrid.appendChild(dateCard);
        });
        
        datesContainer.appendChild(datesGrid);
        
        if (availableDates.length > 30) {
            const moreText = document.createElement('p');
            moreText.className = 'text-xs text-gray-500 text-center mt-2';
            moreText.textContent = `Showing first 30 available dates (${availableDates.length} total)`;
            datesContainer.appendChild(moreText);
        }
        
    } catch (error) {
        console.error('Error loading available dates:', error);
        dateLoading.classList.add('hidden');
        datesContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-8">Error loading available dates. Please try again.</p>';
    }
}

// Load time slots for a specific selected date
async function selectDateAndLoadTimes(selectedDate) {
    const practitionerId = document.getElementById('bookPractitioner').value;
    const duration = parseInt(document.getElementById('bookDuration').value);
    const timeInput = document.getElementById('bookTime');
    const timeLoading = document.getElementById('bookTimeLoading');
    const timeSlotsContainer = document.getElementById('bookTimeSlotsContainer');
    
    // Set the selected date
    document.getElementById('bookDate').value = selectedDate;
    
    // Clear time selection
    timeInput.value = '';
    timeSlotsContainer.innerHTML = '';
    timeSlotsContainer.classList.remove('hidden');
    
    // Show loading
    timeLoading.classList.remove('hidden');
    
    try {
        let availableSlots = [];
        let bookedSlots = [];
        let allTimeSlots = []; // All possible slots for reference
        
        // Generate all possible time slots (8am-6pm in 30-min intervals)
        for (let hour = 8; hour < 18; hour++) {
            for (let minute of [0, 30]) {
                allTimeSlots.push(`${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`);
            }
        }
        
        if (practitionerId === 'any') {
            // For "Any Practitioner", show message that they need to select a specific practitioner
            timeSlotsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Please select a specific practitioner to see their available time slots</p>';
            timeLoading.classList.add('hidden');
            return;
        } else {
            try {
                const response = await fetch(`/api/calendar/availability/${practitionerId}?date=${selectedDate}&duration=${duration}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    availableSlots = data.available_slots || [];
                    bookedSlots = data.booked_slots || [];
                    
                    // Filter out past time slots if this is today
                    const now = new Date();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const appointmentDate = new Date(selectedDate + 'T00:00:00');
                    
                    if (appointmentDate.getTime() === today.getTime()) {
                        // This is today - filter out past times
                        const currentHour = now.getHours();
                        const currentMinute = now.getMinutes();
                        
                        availableSlots = availableSlots.filter(slot => {
                            const [slotHour, slotMinute] = slot.split(':').map(Number);
                            return (slotHour > currentHour) || (slotHour === currentHour && slotMinute > currentMinute);
                        });
                    }
                    
                    // If no slots available, show helpful message
                    if (availableSlots.length === 0) {
                        timeSlotsContainer.innerHTML = '<p class="text-sm text-amber-600 text-center py-4">No available time slots for this date. The practitioner may not have availability configured, or all slots are booked.</p>';
                        timeLoading.classList.add('hidden');
                        return;
                    }
                } else {
                    timeSlotsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error loading availability: ' + (data.error || 'Unknown error') + '</p>';
                    timeLoading.classList.add('hidden');
                    return;
                }
            } catch (error) {
                console.error('Error fetching availability:', error);
                timeSlotsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error loading availability: ' + error.message + '</p>';
                timeLoading.classList.add('hidden');
                return;
            }
        }
        
        // Create a grid container for compact display with scrollable container
        const gridContainer = document.createElement('div');
        gridContainer.className = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-[400px] overflow-y-auto p-2';
        
        // Sort ALL available time slots chronologically
        const sortedAvailableSlots = availableSlots.sort((a, b) => {
            const [hourA, minA] = a.split(':').map(Number);
            const [hourB, minB] = b.split(':').map(Number);
            return hourA * 60 + minA - (hourB * 60 + minB);
        });
        
        let hasAvailableSlots = false;
        
        // Process ALL available time slots - show every single one
        sortedAvailableSlots.forEach(timeStr => {
            const hour = parseInt(timeStr.split(':')[0]);
            const minute = parseInt(timeStr.split(':')[1]);
            const hour12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayTime = `${hour12}:${String(minute).padStart(2, '0')} ${ampm}`;
            
            const isBooked = practitionerId !== 'any' && bookedSlots.some(b => timeStr >= b.start && timeStr < b.end);
            
            const button = document.createElement('button');
            button.type = 'button';
            
            if (!isBooked) {
                // Available slot - clickable, prominent
                button.className = 'px-3 py-2 text-sm rounded-lg border-2 transition-all font-medium bg-white text-gray-700 border-gray-300 hover:border-brand-bright-teal hover:bg-brand-bright-teal hover:text-white cursor-pointer';
                button.innerHTML = displayTime;
                button.onclick = () => selectBookTimeSlot(timeStr, button);
                hasAvailableSlots = true;
            } else {
                // Booked slot - red, disabled (still show it but greyed out)
                button.className = 'px-3 py-2 text-sm rounded-lg border-2 border-red-200 bg-red-50 text-red-400 cursor-not-allowed opacity-60';
                button.innerHTML = displayTime;
                button.disabled = true;
            }
            
            gridContainer.appendChild(button);
        });
        
        if (!hasAvailableSlots) {
            timeSlotsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">No available time slots for this date</p>';
        } else {
            timeSlotsContainer.appendChild(gridContainer);
        }
    } catch (error) {
        console.error('Error loading time slots:', error);
        timeSlotsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error loading time slots</p>';
    } finally {
        timeLoading.classList.add('hidden');
    }
}

function selectBookTimeSlot(timeStr, buttonElement) {
    document.getElementById('bookTime').value = timeStr;
    
    const date = document.getElementById('bookDate').value;
    document.getElementById('bookStartTime').value = `${date}T${timeStr}`;
    
    // Reset all buttons
    document.querySelectorAll('#bookTimeSlotsContainer button').forEach(btn => {
        if (!btn.disabled) {
            btn.className = 'px-3 py-2 text-sm rounded-lg border-2 transition-all font-medium bg-white text-gray-700 border-gray-300 hover:border-brand-bright-teal hover:bg-brand-bright-teal hover:text-white cursor-pointer';
        }
    });
    
    // Highlight selected button
    buttonElement.classList.remove('hover:border-brand-bright-teal', 'hover:bg-brand-bright-teal', 'hover:text-white', 'bg-white', 'text-gray-700', 'border-gray-300');
    buttonElement.classList.add('border-brand-bright-teal', 'bg-brand-bright-teal', 'text-white', 'ring-2', 'ring-brand-bright-teal');
}

async function saveAppointment(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const appointmentData = {
        title: formData.get('title'),
        appointment_type: formData.get('appointment_type'),
        start_time: formData.get('start_time'),
        duration_minutes: parseInt(formData.get('duration_minutes')),
        location: formData.get('location'),
        practitioner_id: formData.get('practitioner_id'),
        notes: formData.get('notes'),
        add_to_calendar: formData.get('add_to_calendar') === 'on'
    };
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/appointments`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(appointmentData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeAppointmentModal();
            
            // Refresh appointments list immediately
            await loadAppointments();
            
            // Show success message
            alert('‚úÖ Appointment booked successfully!');
        } else {
            alert('‚ùå Error booking appointment: ' + result.error);
        }
    } catch (error) {
        console.error('Error booking appointment:', error);
        alert('‚ùå Error booking appointment: ' + error.message);
    }
}

async function deleteAppointment(appointmentId) {
    if (!confirm('Are you sure you want to delete this appointment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/appointments/${appointmentId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        if (result.success) {
            loadAppointments();
            alert('Appointment deleted successfully');
        } else {
            alert('Error deleting appointment: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting appointment: ' + error);
    }
}

function openEditAppointmentModal(id, title, appointmentType, startTime, durationMinutes, location, practitioner, notes, isPast) {
    if (isPast) {
        alert('Cannot edit past appointments');
        return;
    }
    
    document.getElementById('editAppointmentId').value = id;
    document.getElementById('editTitle').value = title;
    document.getElementById('editAppointmentType').value = appointmentType;
    document.getElementById('editDuration').value = durationMinutes;
    document.getElementById('editLocation').value = location;
    document.getElementById('editNotes').value = notes;
    document.getElementById('editSendEmail').checked = true;
    
    const date = new Date(startTime);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const formattedDate = `${year}-${month}-${day}`;
    const formattedTime = `${hours}:${minutes}`;
    const formattedDateTime = `${formattedDate}T${formattedTime}`;
    
    document.getElementById('editDate').value = formattedDate;
    document.getElementById('editTime').value = formattedTime;
    document.getElementById('editStartTime').value = formattedDateTime;
    
    document.getElementById('editAppointmentModal').classList.remove('hidden');
    
    // Load time slots after modal is shown
    setTimeout(() => loadEditAvailableTimeSlots(), 100);
}

function closeEditAppointmentModal() {
    document.getElementById('editAppointmentModal').classList.add('hidden');
    document.getElementById('editAppointmentForm').reset();
    document.getElementById('editTimeSlotsContainer').innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Select a practitioner, duration, and date to see available times</p>';
}

// Load available time slots for editing
async function loadEditAvailableTimeSlots() {
    const practitionerId = document.getElementById('editPractitionerSelect').value;
    const selectedDate = document.getElementById('editDate').value;
    const duration = parseInt(document.getElementById('editDuration').value);
    const currentTime = document.getElementById('editTime').value;
    const timeInput = document.getElementById('editTime');
    const timeLoading = document.getElementById('editTimeLoading');
    const timeSlotsContainer = document.getElementById('editTimeSlotsContainer');
    
    timeSlotsContainer.innerHTML = '';
    
    if (!practitionerId || !selectedDate) {
        timeSlotsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">Select a practitioner, duration, and date to see available times</p>';
        return;
    }
    
    timeLoading.classList.remove('hidden');
    
    try {
        let availableSlots = [];
        let bookedSlots = [];
        
        if (practitionerId === 'any') {
            // For "Any Practitioner", show message that they need to select a specific practitioner
            timeSlotsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Please select a specific practitioner to see their available time slots</p>';
            timeLoading.classList.add('hidden');
            return;
        }
        
        // Fetch ALL available time slots from API for the selected practitioner
        const response = await fetch(`/api/calendar/availability/${practitionerId}?date=${selectedDate}&duration=${duration}`);
        const data = await response.json();
        
        if (data.success) {
            availableSlots = data.available_slots || [];
            bookedSlots = data.booked_slots || [];
            
            // Log for debugging
            console.log(`üìÖ Loaded ${availableSlots.length} available time slots for practitioner ${practitionerId} on ${selectedDate}`);
        } else {
            timeSlotsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Error loading availability: ' + (data.error || 'Unknown error') + '</p>';
            timeLoading.classList.add('hidden');
            return;
        }
        
        // Sort ALL available time slots chronologically
        const sortedAvailableSlots = availableSlots.sort((a, b) => {
            const [hourA, minA] = a.split(':').map(Number);
            const [hourB, minB] = b.split(':').map(Number);
            return hourA * 60 + minA - (hourB * 60 + minB);
        });
        
        let hasAvailableSlots = false;
        
        // Create grid container for better display
        const gridContainer = document.createElement('div');
        gridContainer.className = 'grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 max-h-[400px] overflow-y-auto p-2';
        
        // Process ALL available time slots - show every single one
        sortedAvailableSlots.forEach(timeStr => {
            const hour = parseInt(timeStr.split(':')[0]);
            const minute = parseInt(timeStr.split(':')[1]);
            const hour12 = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayTime = `${hour12}:${String(minute).padStart(2, '0')} ${ampm}`;
            
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'px-3 py-2 text-sm rounded-lg border-2 transition-all font-medium';
            
            const isBooked = bookedSlots.some(b => timeStr >= b.start && timeStr < b.end);
            const isCurrentTime = timeStr === currentTime;
            
            if (isBooked && !isCurrentTime) {
                button.className += ' bg-red-50 text-red-400 border-red-200 cursor-not-allowed opacity-60';
                button.innerHTML = `${displayTime}<br><span class="text-[10px] text-red-500">Booked</span>`;
                button.disabled = true;
            } else {
                button.className += ' bg-white text-gray-700 border-gray-300 hover:border-brand-bright-teal hover:bg-brand-bright-teal hover:text-white cursor-pointer';
                button.innerHTML = `<span class="font-semibold">${displayTime}</span>`;
                button.onclick = () => selectEditTimeSlot(timeStr, button);
                hasAvailableSlots = true;
                
                // Pre-select the current time
                if (isCurrentTime) {
                    button.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                    button.classList.add('border-brand-bright-teal', 'bg-brand-bright-teal', 'text-white', 'ring-2', 'ring-brand-bright-teal');
                }
            }
            
            gridContainer.appendChild(button);
        });
        
        if (!hasAvailableSlots) {
            timeSlotsContainer.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">No available time slots for this date. The practitioner may not have set their availability for this day.</p>';
        } else {
            timeSlotsContainer.appendChild(gridContainer);
        }
    } catch (error) {
        console.error('Error loading time slots:', error);
        timeSlotsContainer.innerHTML = '<p class="text-sm text-red-500 text-center py-8">Error loading time slots</p>';
    } finally {
        timeLoading.classList.add('hidden');
    }
}

function selectEditTimeSlot(timeStr, buttonElement) {
    document.getElementById('editTime').value = timeStr;
    
    const date = document.getElementById('editDate').value;
    document.getElementById('editStartTime').value = `${date}T${timeStr}`;
    
    document.querySelectorAll('#editTimeSlotsContainer button').forEach(btn => {
        if (!btn.disabled) {
            btn.className = 'w-full px-4 py-3 text-left rounded-lg border-2 transition-all font-medium bg-white text-gray-700 border-gray-300 hover:border-brand-bright-teal hover:bg-brand-bright-teal hover:text-white cursor-pointer';
        }
    });
    
    buttonElement.classList.remove('hover:border-brand-bright-teal', 'hover:bg-brand-bright-teal', 'hover:text-white');
    buttonElement.classList.add('border-brand-bright-teal', 'bg-brand-bright-teal', 'text-white', 'ring-2', 'ring-brand-bright-teal');
}

async function updateAppointment(event) {
    event.preventDefault();
    
    const appointmentId = document.getElementById('editAppointmentId').value;
    const formData = new FormData(event.target);
    const appointmentData = {
        title: formData.get('title'),
        appointment_type: formData.get('appointment_type'),
        start_time: formData.get('start_time'),
        duration_minutes: parseInt(formData.get('duration_minutes')),
        location: formData.get('location'),
        practitioner: formData.get('practitioner'),
        notes: formData.get('notes'),
        send_email: formData.get('send_email') === 'on'
    };
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/appointments/${appointmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(appointmentData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeEditAppointmentModal();
            loadAppointments();
            if (appointmentData.send_email) {
                alert('Appointment updated successfully! Email notification sent to patient.');
            } else {
                alert('Appointment updated successfully!');
            }
        } else {
            alert('Error updating appointment: ' + result.error);
        }
    } catch (error) {
        alert('Error updating appointment: ' + error);
    }
}

// Load appointments on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAppointments();
    loadInvoices();
});

// Billing & Invoices Management
let invoiceItems = [];

async function loadInvoices() {
    try {
        const response = await fetch(`/patients/{{ patient.id }}/invoices`);
        const data = await response.json();
        
        const invoicesList = document.getElementById('invoicesList');
        
        if (!data.invoices || data.invoices.length === 0) {
            invoicesList.innerHTML = '<p class="text-gray-500 text-center py-4">No invoices found</p>';
            return;
        }
        
        invoicesList.innerHTML = data.invoices.map(inv => renderInvoiceCard(inv)).join('');
    } catch (error) {
        console.error('Error loading invoices:', error);
        document.getElementById('invoicesList').innerHTML = '<p class="text-red-500 text-center py-4">Error loading invoices</p>';
    }
}

function renderInvoiceCard(inv) {
    const statusColors = {
        'draft': 'gray',
        'sent': 'blue',
        'paid': 'green',
        'overdue': 'red',
        'active': 'purple',
        'cancelled': 'gray'
    };
    
    const statusColor = statusColors[inv.status] || 'gray';
    
    return `
        <div class="border border-${statusColor}-300 bg-${statusColor}-50 rounded-lg p-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <h3 class="font-semibold text-${statusColor}-900">${inv.invoice_number}</h3>
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-${statusColor}-200 text-${statusColor}-800 uppercase">
                            ${inv.status}
                        </span>
                        ${inv.is_recurring ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-200 text-purple-800"><i class="fas fa-repeat mr-1"></i>Recurring</span>' : ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-1">${inv.description || 'No description'}</p>
                    <div class="flex gap-4 text-sm text-gray-600 mb-2">
                        <span><i class="fas fa-calendar mr-1"></i>${new Date(inv.invoice_date).toLocaleDateString()}</span>
                        ${inv.due_date ? `<span><i class="fas fa-clock mr-1"></i>Due: ${new Date(inv.due_date).toLocaleDateString()}</span>` : ''}
                        ${inv.is_recurring ? `<span><i class="fas fa-sync mr-1"></i>${inv.recurring_frequency}</span>` : ''}
                    </div>
                    <p class="font-bold text-lg text-${statusColor}-900">$${inv.total_amount.toFixed(2)} ${inv.currency}</p>
                    ${inv.amount_paid > 0 ? `<p class="text-sm text-green-600">Paid: $${inv.amount_paid.toFixed(2)}</p>` : ''}
                    
                    ${inv.items && inv.items.length > 0 ? `
                        <details class="mt-2">
                            <summary class="text-sm text-brand-teal cursor-pointer hover:text-brand-bright-teal">View Items</summary>
                            <ul class="mt-2 space-y-1 ml-4">
                                ${inv.items.map(item => `
                                    <li class="text-sm text-gray-700">
                                        ${item.description} - ${item.quantity} x $${item.unit_price.toFixed(2)} = $${item.amount.toFixed(2)}
                                    </li>
                                `).join('')}
                            </ul>
                        </details>
                    ` : ''}
                </div>
                <div class="flex flex-col gap-2 ml-4">
                    ${inv.stripe_hosted_invoice_url ? `
                        <a href="${inv.stripe_hosted_invoice_url}" target="_blank" class="px-3 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition text-sm font-semibold text-center">
                            <i class="fas fa-external-link-alt mr-1"></i>View Invoice
                        </a>
                    ` : ''}
                    ${inv.stripe_invoice_pdf ? `
                        <a href="${inv.stripe_invoice_pdf}" target="_blank" class="px-3 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition text-sm font-semibold text-center">
                            <i class="fas fa-file-pdf mr-1"></i>PDF
                        </a>
                    ` : ''}
                    <button onclick="syncInvoice(${inv.id})" class="px-3 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-semibold" title="Sync status from Stripe">
                        <i class="fas fa-sync"></i>
                    </button>
                    ${inv.is_recurring && inv.status === 'active' ? `
                        <button onclick="cancelSubscription(${inv.id})" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm font-semibold" title="Cancel subscription">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

function openInvoiceModal() {
    invoiceItems = [];
    document.getElementById('invoiceModal').classList.remove('hidden');
    updateInvoiceItemsList();
    updateInvoiceFields();
}

function closeInvoiceModal() {
    document.getElementById('invoiceModal').classList.add('hidden');
    document.getElementById('invoiceForm').reset();
}

function updateInvoiceFields() {
    const invoiceType = document.getElementById('invoiceType').value;
    const recurringFields = document.getElementById('recurringFields');
    const oneOffFields = document.getElementById('oneOffFields');
    
    if (invoiceType === 'recurring') {
        recurringFields.classList.remove('hidden');
        oneOffFields.classList.add('hidden');
    } else {
        recurringFields.classList.add('hidden');
        oneOffFields.classList.remove('hidden');
    }
}

function addInvoiceItem() {
    const description = document.getElementById('itemDescription').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
    const unitPrice = parseFloat(document.getElementById('itemUnitPrice').value) || 0;
    const taxRate = parseFloat(document.getElementById('itemTaxRate').value) || 10;
    
    if (!description || unitPrice <= 0) {
        alert('Please enter item description and unit price');
        return;
    }
    
    invoiceItems.push({
        description,
        quantity,
        unit_price: unitPrice,
        tax_rate: taxRate,
        item_type: 'service'
    });
    
    document.getElementById('itemDescription').value = '';
    document.getElementById('itemQuantity').value = '1';
    document.getElementById('itemUnitPrice').value = '';
    
    updateInvoiceItemsList();
}

function removeInvoiceItem(index) {
    invoiceItems.splice(index, 1);
    updateInvoiceItemsList();
}

function updateInvoiceItemsList() {
    const itemsList = document.getElementById('invoiceItemsList');
    
    if (invoiceItems.length === 0) {
        itemsList.innerHTML = '<p class="text-gray-500 text-sm">No items added yet</p>';
        document.getElementById('invoiceTotal').textContent = '$0.00';
        return;
    }
    
    let total = 0;
    
    itemsList.innerHTML = invoiceItems.map((item, index) => {
        const subtotal = item.quantity * item.unit_price;
        const tax = subtotal * (item.tax_rate / 100);
        const itemTotal = subtotal + tax;
        total += itemTotal;
        
        return `
            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                <div class="flex-1">
                    <p class="font-semibold">${item.description}</p>
                    <p class="text-sm text-gray-600">${item.quantity} x $${item.unit_price.toFixed(2)} + ${item.tax_rate}% tax = $${itemTotal.toFixed(2)}</p>
                </div>
                <button type="button" onclick="removeInvoiceItem(${index})" class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }).join('');
    
    document.getElementById('invoiceTotal').textContent = `$${total.toFixed(2)}`;
}

async function submitInvoiceForm(event) {
    event.preventDefault();
    
    if (invoiceItems.length === 0) {
        alert('Please add at least one item to the invoice');
        return;
    }
    
    const formData = new FormData(event.target);
    const invoiceData = {
        invoice_type: formData.get('invoice_type'),
        items: invoiceItems,
        description: formData.get('description'),
        notes: formData.get('notes')
    };
    
    if (invoiceData.invoice_type === 'one_off') {
        invoiceData.due_days = parseInt(formData.get('due_days')) || 14;
    } else {
        invoiceData.frequency = formData.get('frequency');
        invoiceData.start_date = formData.get('start_date');
        invoiceData.end_date = formData.get('end_date') || null;
    }
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/invoices`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(invoiceData)
        });
        
        const result = await response.json();
        if (result.success) {
            closeInvoiceModal();
            loadInvoices();
            alert('Invoice created successfully! ' + (result.invoice.stripe_hosted_invoice_url ? 'Payment link has been generated.' : ''));
        } else {
            alert('Error creating invoice: ' + result.error);
        }
    } catch (error) {
        alert('Error creating invoice: ' + error);
    }
}

async function syncInvoice(invoiceId) {
    try {
        const response = await fetch(`/patients/{{ patient.id }}/invoices/${invoiceId}/sync`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            loadInvoices();
            alert('Invoice status synced successfully!');
        } else {
            alert('Error syncing invoice: ' + result.error);
        }
    } catch (error) {
        alert('Error syncing invoice: ' + error);
    }
}

async function cancelSubscription(invoiceId) {
    if (!confirm('Are you sure you want to cancel this subscription?')) {
        return;
    }
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/invoices/${invoiceId}/cancel`, {
            method: 'POST'
        });
        
        const result = await response.json();
        if (result.success) {
            loadInvoices();
            alert('Subscription cancelled successfully!');
        } else {
            alert('Error cancelling subscription: ' + result.error);
        }
    } catch (error) {
        alert('Error cancelling subscription: ' + error);
    }
}

// Target Ranges Modal Functions
const targetRanges = {{ target_ranges|tojson }};

// Helper function to create target range plugin for charts
function createTargetRangePlugin(measurementType, unit = '') {
    return {
        id: 'targetRangePlugin_' + measurementType,
        beforeDatasetsDraw: (chart) => {
            const targetRange = targetRanges[measurementType];
            if (!targetRange) return;
            
            const { ctx, chartArea: { left, right }, scales: { y } } = chart;
            
            // Check if it's a range (min/max) or single target value
            if (targetRange.min !== null && targetRange.min !== '' && 
                targetRange.max !== null && targetRange.max !== '') {
                // Range mode - draw shaded band
                const minVal = parseFloat(targetRange.min);
                const maxVal = parseFloat(targetRange.max);
                
                if (!isNaN(minVal) && !isNaN(maxVal)) {
                    const minY = y.getPixelForValue(maxVal);
                    const maxY = y.getPixelForValue(minVal);
                    
                    ctx.save();
                    ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                    ctx.fillRect(left, minY, right - left, maxY - minY);
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.5)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.strokeRect(left, minY, right - left, maxY - minY);
                    ctx.restore();
                }
            } else if (targetRange.target !== null && targetRange.target !== '') {
                // Single target value - draw as horizontal line
                const targetVal = parseFloat(targetRange.target);
                if (!isNaN(targetVal)) {
                    const targetY = y.getPixelForValue(targetVal);
                    ctx.save();
                    ctx.strokeStyle = 'rgba(34, 197, 94, 0.7)';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(left, targetY);
                    ctx.lineTo(right, targetY);
                    ctx.stroke();
                    ctx.restore();
                }
            }
        }
    };
}

// Helper function to add target range info to tooltip
function addTargetRangeToTooltip(measurementType, unit, originalLabel) {
    const targetRange = targetRanges[measurementType];
    if (!targetRange) return originalLabel;
    
    let label = originalLabel;
    
    // Check if it's a range (min/max) or single target value
    if (targetRange.min !== null && targetRange.min !== '' && 
        targetRange.max !== null && targetRange.max !== '') {
        const minVal = parseFloat(targetRange.min);
        const maxVal = parseFloat(targetRange.max);
        if (!isNaN(minVal) && !isNaN(maxVal)) {
            label += ' (Target: ' + minVal + '-' + maxVal + ' ' + unit + ')';
        }
    } else if (targetRange.target !== null && targetRange.target !== '') {
        const targetVal = parseFloat(targetRange.target);
        if (!isNaN(targetVal)) {
            label += ' (Target: ' + targetVal + ' ' + unit + ')';
        }
    }
    return label;
}

function openTargetRangesModal() {
    document.getElementById('targetRangesModal').classList.remove('hidden');
}

function closeTargetRangesModal() {
    document.getElementById('targetRangesModal').classList.add('hidden');
}

async function saveTargetRanges() {
    const ranges = {};
    const metricTypes = ['weight', 'heart_rate', 'systolic_bp', 'diastolic_bp', 'steps', 'sleep_duration', 
                         'fat_mass', 'muscle_mass', 'calories', 'distance', 'hydration', 'fat_ratio',
                         'fat_free_mass', 'bone_mass', 'basal_metabolic_rate', 'vascular_age', 'pwv',
                         'deep_sleep', 'light_sleep', 'wakeup_count', 'vo2_max', 'spo2', 'height'];
    
    metricTypes.forEach(type => {
        const minInput = document.getElementById(`target_${type}_min`);
        const maxInput = document.getElementById(`target_${type}_max`);
        if (minInput && maxInput) {
            ranges[type] = {
                min: minInput.value || null,
                max: maxInput.value || null
            };
        }
    });
    
    try {
        const response = await fetch(`/patients/{{ patient.id }}/target-ranges`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(ranges)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('Target ranges saved successfully! Reload the page to see the bands on charts.');
            closeTargetRangesModal();
        } else {
            alert('Error saving target ranges: ' + result.error);
        }
    } catch (error) {
        alert('Error saving target ranges: ' + error);
    }
}
</script>

<!-- Appointment Booking Modal -->
<div id="appointmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col">
        <div class="bg-gradient-to-r from-brand-teal to-brand-bright-teal text-white p-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">
                    <i class="fas fa-calendar-plus mr-2"></i>Book Appointment
                </h2>
                <button onclick="closeAppointmentModal()" class="text-white hover:text-gray-200 text-xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="appointmentForm" onsubmit="saveAppointment(event)" class="flex-1 overflow-y-auto">
            <div class="grid grid-cols-1 lg:grid-cols-2 min-h-[400px]">
                <!-- Left Column: Appointment Details -->
                <div class="p-4 border-r border-gray-200 space-y-3 bg-gray-50 overflow-y-auto">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Patient
                        </label>
                        <input type="text" value="{{ patient.first_name }} {{ patient.last_name }}" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user-md mr-2"></i>Practitioner *
                        </label>
                        <select id="bookPractitioner" name="practitioner_id" required onchange="loadBookAvailableTimeSlots()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="">Select Practitioner</option>
                            <option value="any">Any Available Practitioner</option>
                            {% for practitioner in practitioners %}
                            <option value="{{ practitioner.id }}">{{ practitioner.full_name }} ({{ practitioner.role }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-hourglass-half mr-2"></i>Duration *
                        </label>
                        <select id="bookDuration" name="duration_minutes" required onchange="loadBookAvailableTimeSlots()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60" selected>60 minutes</option>
                            <option value="90">90 minutes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-heading mr-2"></i>Title *
                        </label>
                        <input type="text" name="title" value="Appointment with {{ patient.first_name }} {{ patient.last_name }}" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Type
                        </label>
                        <select name="appointment_type"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="">Select Type</option>
                            <option value="Initial Consultation">Initial Consultation</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Health Review">Health Review</option>
                            <option value="Treatment Session">Treatment Session</option>
                            <option value="Phone Consultation">Phone Consultation</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Location
                        </label>
                        <input type="text" name="location" placeholder="e.g., Room 1, Telehealth"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-notes-medical mr-2"></i>Notes
                        </label>
                        <textarea name="notes" rows="2" placeholder="Additional notes..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal"></textarea>
                    </div>
                    
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="add_to_calendar" checked 
                                   class="mr-2 h-4 w-4 text-brand-bright-teal">
                            <span class="text-sm text-gray-700">Add to Google Calendar</span>
                        </label>
                    </div>
                </div>
                
                <!-- Right Column: Calendar & Time Selection -->
                <div class="p-4 bg-white overflow-y-auto">
                    <h3 class="text-base font-semibold text-gray-800 mb-3">Select a Date & Time</h3>
                    
                    <!-- Hidden inputs for form submission -->
                    <input type="hidden" id="bookDate" name="appointment_date" required>
                    <input type="hidden" id="bookTime" name="appointment_time" required>
                    <input type="hidden" name="start_time" id="bookStartTime">
                    
                    <!-- Loading state -->
                    <div id="bookDateLoading" class="hidden text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">Loading available dates...</p>
                    </div>
                    
                    <!-- Available Dates Display -->
                    <div id="bookAvailableDatesContainer" class="mb-4">
                        <p class="text-sm text-gray-500 text-center py-8">
                            Select a practitioner and duration to see available dates
                        </p>
                    </div>
                    
                    <!-- Time Slots (shown after selecting a date) -->
                    <div id="bookTimeLoading" class="hidden text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                        <p class="text-sm">Loading available times...</p>
                    </div>
                    
                    <div id="bookTimeSlotsContainer" class="hidden">
                        <!-- Time slots will be displayed here -->
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex space-x-2 ml-auto">
                    <button type="button" onclick="closeAppointmentModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold text-sm">
                        <i class="fas fa-times mr-1"></i>Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold text-sm">
                        <i class="fas fa-save mr-1"></i>Book Appointment
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Appointment Modal -->
<div id="editAppointmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
        <div class="bg-gradient-to-r from-brand-teal to-brand-bright-teal text-white p-6">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-edit mr-2"></i>Edit Appointment
                </h2>
                <button onclick="closeEditAppointmentModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <form id="editAppointmentForm" onsubmit="updateAppointment(event)" class="flex-1 overflow-y-auto">
            <input type="hidden" id="editAppointmentId">
            
            <div class="grid grid-cols-1 lg:grid-cols-2 min-h-[600px]">
                <!-- Left Column: Appointment Details -->
                <div class="p-6 border-r border-gray-200 space-y-4 bg-gray-50 overflow-y-auto">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2"></i>Patient
                        </label>
                        <input type="text" value="{{ patient.first_name }} {{ patient.last_name }}" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user-md mr-2"></i>Practitioner *
                        </label>
                        <select id="editPractitionerSelect" name="practitioner_id" required onchange="loadEditAvailableTimeSlots()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="">Select Practitioner</option>
                            <option value="any">Any Available Practitioner</option>
                            {% for practitioner in practitioners %}
                            <option value="{{ practitioner.id }}">{{ practitioner.full_name }} ({{ practitioner.role }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-hourglass-half mr-2"></i>Duration *
                        </label>
                        <select id="editDuration" name="duration_minutes" required onchange="loadEditAvailableTimeSlots()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">60 minutes</option>
                            <option value="90">90 minutes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-heading mr-2"></i>Title *
                        </label>
                        <input type="text" id="editTitle" name="title" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-tag mr-2"></i>Type
                        </label>
                        <select id="editAppointmentType" name="appointment_type"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                            <option value="">Select Type</option>
                            <option value="Initial Consultation">Initial Consultation</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Health Review">Health Review</option>
                            <option value="Treatment Session">Treatment Session</option>
                            <option value="Phone Consultation">Phone Consultation</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2"></i>Location
                        </label>
                        <input type="text" id="editLocation" name="location" placeholder="e.g., Room 1, Telehealth"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-notes-medical mr-2"></i>Notes
                        </label>
                        <textarea id="editNotes" name="notes" rows="2" placeholder="Additional notes..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal"></textarea>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <label class="flex items-start">
                            <input type="checkbox" id="editSendEmail" name="send_email" checked 
                                   class="mr-2 mt-1 h-4 w-4 text-brand-bright-teal">
                            <div>
                                <span class="text-sm font-semibold text-gray-700">Send email notification to patient</span>
                                <p class="text-xs text-gray-600 mt-1">Patient will receive an email about the appointment change</p>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Right Column: Calendar & Time Selection -->
                <div class="p-6 bg-white overflow-y-auto">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Select a Date & Time</h3>
                    
                    <input type="date" id="editDate" name="appointment_date" required onchange="loadEditAvailableTimeSlots()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal mb-4">
                    
                    <input type="hidden" id="editTime" name="appointment_time" required>
                    <input type="hidden" id="editStartTime" name="start_time">
                    
                    <div id="editTimeLoading" class="hidden text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading available times...</p>
                    </div>
                    
                    <div id="editTimeSlotsContainer" class="space-y-2">
                        <p class="text-sm text-gray-500 text-center py-8">
                            Select a practitioner, duration, and date to see available times
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50">
                <div class="flex space-x-3 ml-auto">
                    <button type="button" onclick="closeEditAppointmentModal()" 
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="submit"
                            class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                        <i class="fas fa-save mr-2"></i>Update Appointment
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Create Invoice Modal -->
<div id="invoiceModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-file-invoice-dollar text-brand-bright-teal mr-2"></i>
                    Create Invoice
                </h2>
                <button onclick="closeInvoiceModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>
        
        <form id="invoiceForm" onsubmit="submitInvoiceForm(event)" class="p-6">
            <div class="space-y-6">
                <!-- Invoice Type -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Invoice Type</label>
                    <select id="invoiceType" name="invoice_type" onchange="updateInvoiceFields()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="one_off">One-Off Payment</option>
                        <option value="recurring">Recurring Subscription</option>
                    </select>
                </div>
                
                <!-- One-Off Fields -->
                <div id="oneOffFields">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Payment Due</label>
                    <select name="due_days" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="7">7 days</option>
                        <option value="14" selected>14 days</option>
                        <option value="30">30 days</option>
                        <option value="60">60 days</option>
                    </select>
                </div>
                
                <!-- Recurring Fields -->
                <div id="recurringFields" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Billing Frequency</label>
                        <select name="frequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                            <input type="date" name="start_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">End Date (Optional)</label>
                            <input type="date" name="end_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>
                
                <!-- Invoice Items -->
                <div class="border border-gray-300 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-3">Invoice Items</h3>
                    
                    <div class="grid grid-cols-12 gap-2 mb-3">
                        <div class="col-span-5">
                            <input type="text" id="itemDescription" placeholder="Description" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2">
                            <input type="number" id="itemQuantity" value="1" min="1" placeholder="Qty" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2">
                            <input type="number" id="itemUnitPrice" step="0.01" placeholder="Price" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-2">
                            <input type="number" id="itemTaxRate" value="10" step="0.1" placeholder="Tax %" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div class="col-span-1">
                            <button type="button" onclick="addInvoiceItem()" 
                                    class="w-full px-2 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="invoiceItemsList" class="space-y-2 mb-3">
                        <p class="text-gray-500 text-sm">No items added yet</p>
                    </div>
                    
                    <div class="border-t border-gray-300 pt-3 flex justify-between items-center">
                        <span class="font-semibold text-gray-700">Total (inc. GST):</span>
                        <span id="invoiceTotal" class="text-2xl font-bold text-brand-teal">$0.00</span>
                    </div>
                </div>
                
                <!-- Description and Notes -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
                    <input type="text" name="description" placeholder="e.g., Monthly Consultation Services" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (Internal)</label>
                    <textarea name="notes" rows="2" placeholder="Internal notes (not visible to patient)" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button type="submit" class="px-6 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Create & Send Invoice
                </button>
                <button type="button" onclick="closeInvoiceModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Target Ranges Modal -->
<div id="targetRangesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-bullseye text-brand-soft-blue mr-2"></i>
                    Set Target Ranges
                </h2>
                <button onclick="closeTargetRangesModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <p class="text-sm text-gray-600 mt-2">Define healthy target ranges for each metric. These will appear as colored bands on the charts.</p>
        </div>
        
        <div class="p-6 grid md:grid-cols-2 gap-6">
            <!-- Weight -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-blue-700 mb-3 flex items-center">
                    <i class="fas fa-weight mr-2"></i>Weight (kg)
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" step="0.1" id="target_weight_min" value="{{ target_ranges.get('weight', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" step="0.1" id="target_weight_max" value="{{ target_ranges.get('weight', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Heart Rate -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-red-700 mb-3 flex items-center">
                    <i class="fas fa-heartbeat mr-2"></i>Heart Rate (bpm)
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" id="target_heart_rate_min" value="{{ target_ranges.get('heart_rate', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" id="target_heart_rate_max" value="{{ target_ranges.get('heart_rate', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Systolic BP -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-purple-700 mb-3 flex items-center">
                    <i class="fas fa-heart-pulse mr-2"></i>Systolic BP (mmHg)
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" id="target_systolic_bp_min" value="{{ target_ranges.get('systolic_bp', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" id="target_systolic_bp_max" value="{{ target_ranges.get('systolic_bp', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Diastolic BP -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-purple-700 mb-3 flex items-center">
                    <i class="fas fa-heart-pulse mr-2"></i>Diastolic BP (mmHg)
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" id="target_diastolic_bp_min" value="{{ target_ranges.get('diastolic_bp', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" id="target_diastolic_bp_max" value="{{ target_ranges.get('diastolic_bp', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Steps -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-green-700 mb-3 flex items-center">
                    <i class="fas fa-walking mr-2"></i>Steps
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" id="target_steps_min" value="{{ target_ranges.get('steps', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" id="target_steps_max" value="{{ target_ranges.get('steps', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Sleep Duration -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-indigo-700 mb-3 flex items-center">
                    <i class="fas fa-bed mr-2"></i>Sleep Duration (hours)
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" step="0.1" id="target_sleep_duration_min" value="{{ target_ranges.get('sleep_duration', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" step="0.1" id="target_sleep_duration_max" value="{{ target_ranges.get('sleep_duration', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- Body Fat % -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-orange-700 mb-3 flex items-center">
                    <i class="fas fa-percentage mr-2"></i>Body Fat %
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" step="0.1" id="target_fat_ratio_min" value="{{ target_ranges.get('fat_ratio', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" step="0.1" id="target_fat_ratio_max" value="{{ target_ranges.get('fat_ratio', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
            
            <!-- SpO2 -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-semibold text-cyan-700 mb-3 flex items-center">
                    <i class="fas fa-lungs mr-2"></i>Blood Oxygen %
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Min</label>
                        <input type="number" step="0.1" id="target_spo2_min" value="{{ target_ranges.get('spo2', {}).get('min', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div class="flex-1">
                        <label class="text-xs text-gray-600 block mb-1">Max</label>
                        <input type="number" step="0.1" id="target_spo2_max" value="{{ target_ranges.get('spo2', {}).get('max', '') }}" 
                               class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200 flex justify-end gap-3 sticky bottom-0 bg-white">
            <button onclick="closeTargetRangesModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                Cancel
            </button>
            <button onclick="saveTargetRanges()" class="px-6 py-2 bg-brand-soft-blue text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-save mr-2"></i>Save Target Ranges
            </button>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div id="noteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-notes-medical text-brand-bright-teal mr-2"></i><span id="noteModalTitle">Add Note</span>
            </h3>
        </div>
        
        <form id="noteForm" onsubmit="saveNote(event)" class="p-6">
            <input type="hidden" id="noteId" value="">
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Note Type</label>
                <select id="noteType" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="manual">Clinical Note</option>
                    <option value="soap">SOAP Note</option>
                    <option value="ai_report">AI Report</option>
                    <option value="observation">Observation</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Link to Appointment (Optional)</label>
                <select id="noteAppointment" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <option value="">No appointment</option>
                </select>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Note</label>
                <textarea id="noteText" rows="10" 
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg font-mono text-sm"
                          placeholder="Enter patient notes here..." required></textarea>
                <p class="text-xs text-gray-500 mt-1">Supports plain text and markdown formatting</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-paperclip mr-1"></i>Attach File (Optional)
                </label>
                <input type="file" id="noteAttachment" accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                <p class="text-xs text-gray-500 mt-1">Supported: PDF, Images (JPG, PNG, GIF, WebP), Word Documents (Max 10MB)</p>
                <div id="currentAttachment" class="mt-2 hidden">
                    <p class="text-sm text-blue-600"><i class="fas fa-file mr-2"></i>Current attachment: <span id="currentAttachmentName"></span></p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="px-6 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-save mr-2"></i>Save Note
                </button>
                <button type="button" onclick="closeNoteModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- SMS Modal -->
<div id="smsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-sms text-brand-bright-teal mr-2"></i>Send SMS
            </h3>
        </div>
        
        <form id="smsForm" onsubmit="sendSms(event)" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Recipient Phone Number
                </label>
                <input type="tel" id="smsPhone" 
                       value="{{ patient.mobile or patient.phone or '' }}" 
                       placeholder="+61400000000"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +61 for Australia)</p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    Message
                </label>
                <textarea id="smsMessage" rows="5" maxlength="160"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Type your message here..." required></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    <span id="charCount">0</span>/160 characters
                </p>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="px-6 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Send SMS
                </button>
                <button type="button" onclick="closeSmsModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- iOS App Invite Modal -->
<div id="iosInviteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-mobile-alt text-purple-600 mr-2"></i>Send iOS App Invite
            </h3>
            <p class="text-sm text-gray-600 mt-1">Preview and customize the invite message</p>
        </div>
        
        <form id="iosInviteForm" onsubmit="sendIOSInviteFromModal(event)" class="p-6">
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-user mr-1"></i>Patient
                </label>
                <div class="bg-gray-50 p-3 rounded-lg">
                    <p class="font-semibold">{{ patient.first_name }} {{ patient.last_name }}</p>
                    <p class="text-sm text-gray-600">{{ patient.email }}</p>
                    {% if patient.mobile or patient.phone %}
                    <p class="text-sm text-gray-600">{{ patient.mobile or patient.phone }}</p>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-key mr-1"></i>Login Credentials
                </label>
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg">
                    <div class="mb-2">
                        <span class="text-sm font-semibold text-gray-700">Email (Login):</span>
                        <span class="ml-2 text-sm text-gray-800 font-mono">{{ patient.email }}</span>
                    </div>
                    <div>
                        <span class="text-sm font-semibold text-gray-700">Temporary Password:</span>
                        <span id="tempPasswordPreview" class="ml-2 text-sm text-gray-800 font-mono font-bold">Generating...</span>
                        <button type="button" onclick="generateNewPassword()" class="ml-2 text-xs text-blue-600 hover:text-blue-800">
                            <i class="fas fa-sync-alt"></i> Generate New
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-paper-plane mr-1"></i>Send Via
                </label>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" id="sendEmail" name="send_methods" value="email" checked class="mr-3 w-4 h-4 text-purple-600">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">
                                <i class="fas fa-envelope text-blue-600 mr-2"></i>Email
                            </div>
                            <div class="text-sm text-gray-600">{{ patient.email }}</div>
                        </div>
                    </label>
                    {% if patient.mobile or patient.phone %}
                    <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" id="sendSMS" name="send_methods" value="sms" checked class="mr-3 w-4 h-4 text-purple-600">
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800">
                                <i class="fas fa-sms text-green-600 mr-2"></i>SMS
                            </div>
                            <div class="text-sm text-gray-600">{{ patient.mobile or patient.phone }}</div>
                        </div>
                    </label>
                    {% else %}
                    <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>No phone number available for SMS
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-eye mr-1"></i>Message Preview
                </label>
                <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
                    <div id="emailPreview" class="mb-4">
                        <div class="text-xs font-semibold text-gray-500 mb-2">EMAIL MESSAGE:</div>
                        <div id="emailMessagePreview" class="text-sm text-gray-800 whitespace-pre-wrap font-mono"></div>
                    </div>
                    <div id="smsPreview" class="border-t border-gray-300 pt-4">
                        <div class="text-xs font-semibold text-gray-500 mb-2">SMS MESSAGE:</div>
                        <div id="smsMessagePreview" class="text-sm text-gray-800 whitespace-pre-wrap font-mono"></div>
                        <div class="text-xs text-gray-500 mt-2">
                            <span id="smsCharCount">0</span>/160 characters
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" id="sendInviteBtn" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Send Invite
                </button>
                <button type="button" onclick="closeIOSInviteModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Call Modal -->
<div id="callModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
        <!-- Initial Call Setup View -->
        <div id="callSetupView" class="p-6">
            <div class="border-b border-gray-200 pb-4 mb-4">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-phone text-green-600 mr-2"></i>Call Patient
                </h3>
            </div>
            
            <form id="callForm" onsubmit="initiateCall(event)">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        Patient Phone Number
                    </label>
                    <input type="tel" id="callPhone" 
                           value="{{ patient.mobile or patient.phone or '' }}" 
                           placeholder="+61400000000"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                    <p class="text-xs text-gray-500 mt-1">Include country code (e.g., +61 for Australia)</p>
                </div>
                
                <div class="flex gap-2">
                    <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                        <i class="fas fa-phone mr-2"></i>Start Call
                    </button>
                    <button type="button" onclick="closeCallModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Active Call View -->
        <div id="activeCallView" class="p-6 hidden">
            <div class="border-b border-gray-200 pb-4 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-phone-volume text-green-600 mr-3 animate-pulse"></i>
                    <span>Call in Progress</span>
                </h3>
            </div>
            
            <!-- Call Timer -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 text-center">
                <div class="text-sm text-green-700 font-semibold mb-2">Call Duration</div>
                <div id="callTimer" class="text-5xl font-bold text-green-600 tabular-nums">00:00</div>
                <div class="text-sm text-gray-600 mt-2">
                    <i class="fas fa-phone mr-1"></i>
                    <span id="activeCallNumber"></span>
                </div>
            </div>
            
            <!-- Call Controls -->
            <div class="grid grid-cols-3 gap-3 mb-6">
                <button id="muteBtn" onclick="toggleMute()" class="flex flex-col items-center justify-center py-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    <i class="fas fa-microphone text-2xl text-gray-700 mb-2"></i>
                    <span class="text-sm font-semibold text-gray-700">Mute</span>
                </button>
                
                <button id="holdBtn" onclick="toggleHold()" class="flex flex-col items-center justify-center py-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                    <i class="fas fa-pause text-2xl text-gray-700 mb-2"></i>
                    <span class="text-sm font-semibold text-gray-700">Hold</span>
                </button>
                
                <button id="hangupBtn" onclick="hangupCall()" class="flex flex-col items-center justify-center py-4 bg-red-600 hover:bg-red-700 rounded-lg transition">
                    <i class="fas fa-phone-slash text-2xl text-white mb-2"></i>
                    <span class="text-sm font-semibold text-white">Hang Up</span>
                </button>
            </div>
            
            <!-- Call Notes -->
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-sticky-note mr-2"></i>Call Notes
                </label>
                <textarea id="callNotes" rows="6"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                          placeholder="Take notes during the call..."></textarea>
                <p class="text-xs text-gray-500 mt-1">These notes will be saved with the call record when you hang up.</p>
            </div>
        </div>
    </div>
</div>

<!-- Video Call Modal -->
<div id="videoCallModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div id="videoCallModalContent" class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Video Call Setup View -->
        <div id="videoCallSetupView" class="p-6">
            <div class="border-b border-gray-200 pb-4 mb-4 flex items-center justify-between">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-video text-indigo-600 mr-2"></i>Video Consultation
                </h3>
                <button onclick="closeVideoCallModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <p class="text-gray-600">Start a secure video consultation with {{ patient.first_name }} {{ patient.last_name }}.</p>
                <p class="text-sm text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    You can send an SMS invite to the patient with a link to join the video room.
                </p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="startVideoCallFromModal()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-semibold">
                    <i class="fas fa-video mr-2"></i>Start Video Call
                </button>
                <button type="button" onclick="closeVideoCallModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </div>
        
        <!-- Active Video Call View -->
        <div id="activeVideoCallView" class="p-6 hidden">
            <div class="border-b border-gray-200 pb-4 mb-4">
                <h3 class="text-2xl font-bold text-gray-800 flex items-center justify-between">
                    <span>
                        <i class="fas fa-video text-indigo-600 mr-3"></i>
                        <span>Video Consultation</span>
                    </span>
                    <div class="flex items-center gap-4 text-sm font-normal">
                        <span class="text-gray-600">
                            <i class="fas fa-clock mr-1"></i>
                            <span id="videoModalCallDuration">00:00</span>
                        </span>
                        <span class="text-gray-600">
                            <i class="fas fa-users mr-1"></i>
                            <span id="videoModalParticipantCount">1</span> participant(s)
                        </span>
                        <div class="flex gap-2">
                            <button onclick="minimizeVideoCallModal()" class="text-gray-500 hover:text-gray-700" title="Minimize">
                                <i class="fas fa-minus text-xl"></i>
                            </button>
                            <button onclick="closeVideoCallModal()" class="text-gray-500 hover:text-gray-700" title="Close">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                    </div>
                </h3>
            </div>
            
            <!-- Video Container -->
            <div class="relative bg-gray-900 rounded-lg overflow-hidden mb-4" style="height: 400px;">
                <!-- Remote Participant Video (main) -->
                <div id="videoModalRemoteParticipant" class="absolute inset-0 flex items-center justify-center bg-gray-800">
                    <div class="text-center text-white">
                        <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
                        <p class="text-lg">Waiting for patient to join...</p>
                    </div>
                </div>
                
                <!-- Local Participant Video (picture-in-picture) -->
                <div id="videoModalLocalParticipant" class="absolute bottom-4 right-4 w-48 h-36 bg-gray-700 rounded-lg overflow-hidden shadow-lg border-2 border-white flex items-center justify-center">
                    <i class="fas fa-user text-white text-4xl opacity-50"></i>
                </div>
            </div>
            
            <!-- Video Controls -->
            <div class="flex justify-center gap-3 mb-4">
                <button id="videoModalMuteBtn" onclick="toggleVideoMute()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition flex items-center gap-2 text-white">
                    <i class="fas fa-microphone"></i>
                    <span class="hidden sm:inline">Mute</span>
                </button>
                
                <button id="videoModalVideoToggleBtn" onclick="toggleVideoModalCamera()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition flex items-center gap-2 text-white">
                    <i class="fas fa-video"></i>
                    <span class="hidden sm:inline">Video</span>
                </button>
                
                <button onclick="sendVideoInviteFromModal()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition flex items-center gap-2 text-white">
                    <i class="fas fa-sms"></i>
                    <span class="hidden sm:inline">Send SMS Invite</span>
                </button>
                
                <button onclick="endVideoCallFromModal()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition flex items-center gap-2 text-white font-semibold">
                    <i class="fas fa-phone-slash"></i>
                    <span>End Call</span>
                </button>
            </div>
            
            <!-- Room Link -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <label class="block text-sm font-semibold text-blue-900 mb-2">
                    <i class="fas fa-link mr-1"></i>Patient Join Link
                </label>
                <div class="flex gap-2">
                    <input type="text" id="videoModalRoomUrl" readonly
                           class="flex-1 px-3 py-2 border border-blue-300 rounded-lg bg-white text-sm"
                           value="">
                    <button onclick="copyVideoModalRoomUrl()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-semibold whitespace-nowrap">
                        <i class="fas fa-copy mr-1"></i>Copy
                    </button>
                </div>
                <p class="text-xs text-blue-700 mt-2">Share this link with the patient to join the video call</p>
            </div>
        </div>
    </div>
</div>

<!-- Minimized Video Call Widget (floating) -->
<div id="minimizedVideoWidget" class="hidden fixed bottom-6 right-6 z-50">
    <div class="bg-gradient-to-br from-indigo-600 to-indigo-700 rounded-xl shadow-2xl overflow-hidden" style="width: 320px;">
        <!-- Widget Header -->
        <div class="bg-indigo-800 px-4 py-3 flex items-center justify-between cursor-move" id="videoWidgetHeader">
            <div class="flex items-center gap-3">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                <div>
                    <div class="text-white font-semibold text-sm">Video Call Active</div>
                    <div class="text-indigo-200 text-xs" id="minimizedVideoDuration">00:00</div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="maximizeVideoCallModal()" class="text-white hover:text-indigo-200" title="Restore">
                    <i class="fas fa-expand text-lg"></i>
                </button>
            </div>
        </div>
        
        <!-- Compact Video Preview -->
        <div class="relative bg-gray-900" style="height: 180px;">
            <div id="minimizedVideoPreview" class="w-full h-full flex items-center justify-center">
                <i class="fas fa-user-circle text-white text-5xl opacity-50"></i>
            </div>
        </div>
        
        <!-- Quick Controls -->
        <div class="bg-indigo-700 px-3 py-2 flex justify-around">
            <button id="minimizedMuteBtn" onclick="toggleVideoMute()" class="text-white hover:text-indigo-200 p-2" title="Mute">
                <i class="fas fa-microphone"></i>
            </button>
            <button id="minimizedVideoBtn" onclick="toggleVideoModalCamera()" class="text-white hover:text-indigo-200 p-2" title="Camera">
                <i class="fas fa-video"></i>
            </button>
            <button onclick="endVideoCallFromModal()" class="text-red-300 hover:text-red-100 p-2" title="End Call">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
</div>

<!-- Correspondence Detail Modal -->
<div id="correspondenceDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-envelope text-brand-bright-teal mr-2"></i>Correspondence Details
            </h3>
            <button onclick="closeCorrespondenceDetailModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div id="correspondenceDetailContent" class="p-6">
            <!-- Content will be populated by JavaScript -->
        </div>
        
        <div class="p-6 border-t border-gray-200 flex justify-end bg-gray-50">
            <button onclick="closeCorrespondenceDetailModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
    </div>
</div>

<!-- Note Detail Modal -->
<div id="noteDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white z-10">
            <h3 class="text-2xl font-bold text-gray-800">
                <i class="fas fa-notes-medical text-brand-bright-teal mr-2"></i>Note Details
            </h3>
            <button onclick="closeNoteDetailModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        <div id="noteDetailContent" class="p-6">
            <!-- Content will be dynamically inserted -->
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div id="customAlertModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all">
        <div id="customAlertHeader" class="px-6 py-4 border-b border-gray-200 flex items-center gap-3">
            <div id="customAlertIcon" class="text-3xl"></div>
            <h3 id="customAlertTitle" class="text-xl font-bold text-gray-800"></h3>
        </div>
        <div class="p-6">
            <p id="customAlertMessage" class="text-gray-700 text-base leading-relaxed"></p>
        </div>
        <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end">
            <button id="customAlertOkBtn" class="px-6 py-2.5 rounded-lg font-semibold transition shadow-sm">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal -->
<div id="customConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full transform transition-all">
        <div id="customConfirmHeader" class="px-6 py-4 border-b border-gray-200 flex items-center gap-3">
            <div id="customConfirmIcon" class="text-3xl"></div>
            <h3 id="customConfirmTitle" class="text-xl font-bold text-gray-800"></h3>
        </div>
        <div class="p-6">
            <p id="customConfirmMessage" class="text-gray-700 text-base leading-relaxed whitespace-pre-line"></p>
        </div>
        <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3">
            <button id="customConfirmCancelBtn" class="px-6 py-2.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-semibold transition shadow-sm">
                Cancel
            </button>
            <button id="customConfirmOkBtn" class="px-6 py-2.5 rounded-lg font-semibold transition shadow-sm">
                Confirm
            </button>
        </div>
    </div>
</div>

<script>
// Custom Alert and Confirm Functions
function showAlert(message, type = 'info') {
    return new Promise((resolve) => {
        const modal = document.getElementById('customAlertModal');
        const icon = document.getElementById('customAlertIcon');
        const title = document.getElementById('customAlertTitle');
        const messageEl = document.getElementById('customAlertMessage');
        const okBtn = document.getElementById('customAlertOkBtn');
        
        // Set icon and colors based on type
        const types = {
            'success': { icon: '‚úÖ', title: 'Success', btnClass: 'bg-green-600 hover:bg-green-700 text-white' },
            'error': { icon: '‚ùå', title: 'Error', btnClass: 'bg-red-600 hover:bg-red-700 text-white' },
            'warning': { icon: '‚ö†Ô∏è', title: 'Warning', btnClass: 'bg-yellow-600 hover:bg-yellow-700 text-white' },
            'info': { icon: '‚ÑπÔ∏è', title: 'Information', btnClass: 'bg-brand-bright-teal hover:bg-brand-teal text-white' }
        };
        
        const config = types[type] || types.info;
        icon.textContent = config.icon;
        title.textContent = config.title;
        messageEl.textContent = message;
        
        // Update button styling
        okBtn.className = `px-6 py-2.5 rounded-lg font-semibold transition shadow-sm ${config.btnClass}`;
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Handle close
        const closeHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', closeHandler);
            resolve();
        };
        
        okBtn.addEventListener('click', closeHandler);
    });
}

function showConfirm(message, type = 'warning') {
    return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('customConfirmIcon');
        const title = document.getElementById('customConfirmTitle');
        const messageEl = document.getElementById('customConfirmMessage');
        const okBtn = document.getElementById('customConfirmOkBtn');
        const cancelBtn = document.getElementById('customConfirmCancelBtn');
        
        // Set icon and colors based on type
        const types = {
            'danger': { icon: '‚ö†Ô∏è', title: 'Confirm Action', btnClass: 'bg-red-600 hover:bg-red-700 text-white' },
            'warning': { icon: '‚ö†Ô∏è', title: 'Confirm', btnClass: 'bg-yellow-600 hover:bg-yellow-700 text-white' },
            'info': { icon: '‚ùì', title: 'Confirm', btnClass: 'bg-brand-bright-teal hover:bg-brand-teal text-white' }
        };
        
        const config = types[type] || types.warning;
        icon.textContent = config.icon;
        title.textContent = config.title;
        messageEl.textContent = message;
        
        // Update button styling
        okBtn.className = `px-6 py-2.5 rounded-lg font-semibold transition shadow-sm ${config.btnClass}`;
        
        // Show modal
        modal.classList.remove('hidden');
        
        // Handle confirm
        const confirmHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            resolve(true);
        };
        
        // Handle cancel
        const cancelHandler = () => {
            modal.classList.add('hidden');
            okBtn.removeEventListener('click', confirmHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
            resolve(false);
        };
        
        okBtn.addEventListener('click', confirmHandler);
        cancelBtn.addEventListener('click', cancelHandler);
    });
}

// Tab switching functionality
function switchTab(tab) {
    const notesTab = document.getElementById('notesTab');
    const correspondenceTab = document.getElementById('correspondenceTab');
    const billingTab = document.getElementById('billingTab');
    const videoCallTab = document.getElementById('videoCallTab');
    const notesContent = document.getElementById('notesContent');
    const correspondenceContent = document.getElementById('correspondenceContent');
    const billingContent = document.getElementById('billingContent');
    const videoCallContent = document.getElementById('videoCallContent');
    
    // Reset all tabs to inactive state
    [notesTab, correspondenceTab, billingTab, videoCallTab].forEach(tabEl => {
        tabEl.classList.add('border-transparent', 'text-gray-500');
        tabEl.classList.remove('border-brand-bright-teal', 'text-brand-bright-teal');
    });
    
    // Hide all content
    [notesContent, correspondenceContent, billingContent, videoCallContent].forEach(content => {
        content.classList.add('hidden');
    });
    
    // Show selected tab
    if (tab === 'notes') {
        notesTab.classList.add('border-brand-bright-teal', 'text-brand-bright-teal');
        notesTab.classList.remove('border-transparent', 'text-gray-500');
        notesContent.classList.remove('hidden');
    } else if (tab === 'correspondence') {
        correspondenceTab.classList.add('border-brand-bright-teal', 'text-brand-bright-teal');
        correspondenceTab.classList.remove('border-transparent', 'text-gray-500');
        correspondenceContent.classList.remove('hidden');
        
        // Load correspondence when tab is opened
        loadCorrespondence();
    } else if (tab === 'billing') {
        billingTab.classList.add('border-brand-bright-teal', 'text-brand-bright-teal');
        billingTab.classList.remove('border-transparent', 'text-gray-500');
        billingContent.classList.remove('hidden');
        
        // Load invoices when tab is opened
        loadInvoices();
    } else if (tab === 'videoCall') {
        videoCallTab.classList.add('border-brand-bright-teal', 'text-brand-bright-teal');
        videoCallTab.classList.remove('border-transparent', 'text-gray-500');
        videoCallContent.classList.remove('hidden');
    }
}

// Notes functionality
let currentNoteId = null;

// Properly escape HTML to prevent XSS and handle special characters
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Convert URLs in text to clickable links while escaping other HTML
    function linkify(text) {
        if (!text) return '';
        
        // First escape HTML to prevent XSS
        let escaped = escapeHtml(text);
        
        // URL regex pattern - matches http://, https://, and www. URLs
        const urlRegex = /(https?:\/\/[^\s<>"{}|\\^`\[\]]+|www\.[^\s<>"{}|\\^`\[\]]+)/gi;
        
        // Replace URLs with clickable links
        return escaped.replace(urlRegex, (url) => {
            // Add http:// if it's a www. URL
            let href = url;
            if (url.toLowerCase().startsWith('www.')) {
                href = 'https://' + url;
            }
            
            // NO TRUNCATION - Show full URL
            let displayUrl = url;
            
            return `<a href="${escapeHtml(href)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline break-all">${escapeHtml(displayUrl)}</a>`;
        });
    }

    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

async function loadNotes() {
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/notes`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        
        const notesList = document.getElementById('notesList');
        if (!notesList) {
            console.warn('notesList element not found');
            return;
        }
        
        if (data.success && data.notes && data.notes.length > 0) {
            notesList.innerHTML = data.notes.map(note => {
                const createdDate = new Date(note.created_at).toLocaleString('en-AU', {
                    timeZone: 'Australia/Sydney',
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                const noteTypeColors = {
                    'manual': 'bg-blue-100 text-brand-teal',
                    'soap': 'bg-purple-100 text-purple-800',
                    'ai_report': 'bg-green-100 text-brand-teal',
                    'observation': 'bg-gray-100 text-gray-800'
                };
                
                const typeColor = noteTypeColors[note.note_type] || 'bg-gray-100 text-gray-800';
                
                // Get subject and preview text (max 2 lines or 150 chars)
                const subject = note.subject || '';
                const noteText = note.note_text || '';
                
                // Get first 2 lines of note text (excluding subject if it exists)
                let previewText = '';
                if (noteText) {
                    const lines = noteText.split('\n').filter(line => line.trim());
                    const firstTwoLines = lines.slice(0, 2).join(' ').trim();
                    previewText = firstTwoLines.substring(0, 150);
                }
                
                const hasMore = noteText.length > previewText.length;
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition bg-white">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="px-2 py-1 text-xs font-semibold rounded ${typeColor}">
                                    ${note.note_type.replace('_', ' ').toUpperCase()}
                                </span>
                                ${subject ? `
                                    <span class="text-sm text-gray-800 font-semibold">
                                        ${subject}
                                    </span>
                                ` : ''}
                                <span class="text-sm text-gray-500">
                                    ${createdDate}
                                </span>
                                <span class="text-sm text-gray-500">
                                    by ${note.author}
                                </span>
                                ${note.appointment ? `
                                    <span class="text-xs text-gray-600">
                                        <i class="fas fa-calendar mr-1"></i>${note.appointment.appointment_type}
                                    </span>
                                ` : ''}
                                ${note.attachment_filename ? `
                                    <span class="text-xs text-blue-600 font-semibold">
                                        <i class="fas fa-paperclip mr-1"></i>Has Attachment
                                    </span>
                                ` : ''}
                            </div>
                            <div class="flex gap-2 ml-3">
                                <button onclick='viewNoteDetailById(${note.id})'
                                        class="px-3 py-1.5 bg-brand-bright-teal hover:bg-teal-600 text-white rounded text-xs transition font-semibold whitespace-nowrap">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                <button onclick='deleteNote(${note.id})'
                                        class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white rounded text-xs transition font-semibold whitespace-nowrap">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </div>
                        ${previewText ? `
                            <div class="text-sm text-gray-600 mt-2 line-clamp-2">
                                ${linkify(previewText)}${hasMore ? '...' : ''}
                            </div>
                        ` : ''}
                        ${note.attachment_filename ? `
                            <div class="mt-2 flex items-center gap-2 text-sm">
                                <a href="/api/notes/${note.id}/attachment" target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                                    <i class="fas fa-file-download"></i>
                                    <span>${note.attachment_filename}</span>
                                    <span class="text-xs text-gray-500">(${formatFileSize(note.attachment_size)})</span>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        } else {
            notesList.innerHTML = '<p class="text-gray-500 text-center py-8">No notes yet. Click "Add Note" to create your first note.</p>';
        }
    } catch (error) {
        console.error('Error loading notes:', error);
        document.getElementById('notesList').innerHTML = '<p class="text-red-600 text-center py-4">Error loading notes</p>';
    }
}

async function viewNoteDetailById(noteId) {
    try {
        // Fetch the full note data by ID to avoid JSON escaping issues with special characters
        const response = await fetch(`/api/patients/{{ patient.id }}/notes`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error loading note: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const note = data.notes.find(n => n.id === noteId);
        if (!note) {
            alert('Note not found');
            return;
        }
        
        viewNoteDetail(note);
    } catch (error) {
        console.error('Error loading note:', error);
        alert('Error loading note: ' + error.message);
    }
}

function viewNoteDetail(note) {
    const createdDate = new Date(note.created_at).toLocaleString('en-AU', {
        timeZone: 'Australia/Sydney',
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    
    const noteTypeColors = {
        'manual': 'bg-blue-100 text-brand-teal',
        'soap': 'bg-purple-100 text-purple-800',
        'ai_report': 'bg-green-100 text-brand-teal',
        'observation': 'bg-gray-100 text-gray-800',
        'call_summary': 'bg-yellow-100 text-yellow-800',
        'heygen_video': 'bg-indigo-100 text-indigo-800'
    };
    
    const typeColor = noteTypeColors[note.note_type] || 'bg-gray-100 text-gray-800';
    
    const modalContent = `
        <div class="mb-4">
            <span class="px-3 py-1 text-sm font-semibold rounded ${typeColor}">
                ${escapeHtml(note.note_type.replace('_', ' ').toUpperCase())}
            </span>
            ${note.subject ? `
                <span class="ml-2 text-sm font-semibold text-gray-800">
                    ${escapeHtml(note.subject)}
                </span>
            ` : ''}
            ${note.appointment ? `
                <span class="ml-2 text-sm text-gray-600">
                    <i class="fas fa-calendar mr-1"></i>${escapeHtml(note.appointment.appointment_type || 'Appointment')}
                </span>
            ` : ''}
        </div>
        
        <div class="text-sm text-gray-600 mb-4">
            <i class="fas fa-user mr-1"></i><strong>Author:</strong> ${escapeHtml(note.author || 'System')} <br>
            <i class="fas fa-clock mr-1"></i><strong>Created:</strong> ${escapeHtml(createdDate)}
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-4 max-h-96 overflow-y-auto">
            <div class="text-gray-800 whitespace-pre-wrap">
                ${linkify(note.note_text || '').replace(/\n/g, '<br>')}
            </div>
        </div>
        
        ${note.attachment_filename ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-paperclip text-blue-600 text-2xl"></i>
                        <div>
                            <p class="text-sm font-semibold text-gray-800">Attachment:</p>
                            <p class="text-sm text-gray-600">${escapeHtml(note.attachment_filename)}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(note.attachment_size)}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <a href="/api/notes/${note.id}/attachment" target="_blank" 
                           class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition font-semibold">
                            <i class="fas fa-eye mr-2"></i>View
                        </a>
                        <a href="/api/notes/${note.id}/attachment" download 
                           class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm transition font-semibold">
                            <i class="fas fa-download mr-2"></i>Download
                        </a>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <div class="flex gap-2 pt-4 border-t border-gray-200">
            <button onclick="editNote(${note.id}); closeNoteDetailModal();" 
                    class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-teal-600 transition font-semibold">
                <i class="fas fa-edit mr-2"></i>Edit Note
            </button>
            <button onclick="if(confirm('Are you sure you want to delete this note?')) { deleteNote(${note.id}); closeNoteDetailModal(); }" 
                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                <i class="fas fa-trash mr-2"></i>Delete Note
            </button>
            <button onclick="closeNoteDetailModal()" 
                    class="ml-auto px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                <i class="fas fa-times mr-2"></i>Close
            </button>
        </div>
    `;
    
    document.getElementById('noteDetailContent').innerHTML = modalContent;
    document.getElementById('noteDetailModal').classList.remove('hidden');
}

function closeNoteDetailModal() {
    document.getElementById('noteDetailModal').classList.add('hidden');
}

async function loadAppointmentsForNote() {
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/appointments`);
        const data = await response.json();
        
        const select = document.getElementById('noteAppointment');
        select.innerHTML = '<option value="">No appointment</option>';
        
        if (data.appointments) {
            data.appointments.forEach(appt => {
                const date = new Date(appt.start_time).toLocaleString('en-AU', {
                    timeZone: 'Australia/Sydney',
                    month: 'short', day: 'numeric', year: 'numeric'
                });
                select.innerHTML += `<option value="${appt.id}">${appt.appointment_type} - ${date}</option>`;
            });
        }
    } catch (error) {
        console.error('Error loading appointments:', error);
    }
}

function openNoteModal() {
    currentNoteId = null;
    document.getElementById('noteModalTitle').textContent = 'Add Note';
    document.getElementById('noteForm').reset();
    document.getElementById('noteId').value = '';
    loadAppointmentsForNote();
    document.getElementById('noteModal').classList.remove('hidden');
}

function closeNoteModal() {
    document.getElementById('noteModal').classList.add('hidden');
    currentNoteId = null;
}

async function saveNote(event) {
    event.preventDefault();
    
    const noteId = document.getElementById('noteId').value;
    const noteText = document.getElementById('noteText').value;
    const noteType = document.getElementById('noteType').value;
    const appointmentId = document.getElementById('noteAppointment').value;
    const fileInput = document.getElementById('noteAttachment');
    
    try {
        let response;
        if (noteId) {
            // Update existing note (file upload not supported for edits)
            response = await fetch(`/api/notes/${noteId}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({note_text: noteText, note_type: noteType})
            });
        } else {
            // Create new note
            const hasFile = fileInput.files && fileInput.files.length > 0;
            
            if (hasFile) {
                // Use FormData for file upload
                const formData = new FormData();
                formData.append('note_text', noteText);
                formData.append('note_type', noteType);
                formData.append('appointment_id', appointmentId || '');
                formData.append('author', 'Admin');
                formData.append('attachment', fileInput.files[0]);
                
                response = await fetch(`/api/patients/{{ patient.id }}/notes`, {
                    method: 'POST',
                    body: formData
                    // Don't set Content-Type header - browser will set it with boundary for multipart
                });
            } else {
                // Use JSON for text-only note
                response = await fetch(`/api/patients/{{ patient.id }}/notes`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        note_text: noteText,
                        note_type: noteType,
                        appointment_id: appointmentId || null,
                        author: 'Admin'
                    })
                });
            }
        }
        
        const data = await response.json();
        
        if (data.success) {
            closeNoteModal();
            loadNotes();
            alert('‚úÖ Note saved successfully!');
        } else {
            alert('Error saving note: ' + data.error);
        }
    } catch (error) {
        console.error('Error saving note:', error);
        alert('Error saving note: ' + error.message);
    }
}

async function editNote(noteId) {
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/notes`);
        const data = await response.json();
        
        const note = data.notes.find(n => n.id === noteId);
        if (note) {
            currentNoteId = noteId;
            document.getElementById('noteModalTitle').textContent = 'Edit Note';
            document.getElementById('noteId').value = noteId;
            document.getElementById('noteText').value = note.note_text;
            document.getElementById('noteType').value = note.note_type;
            loadAppointmentsForNote();
            if (note.appointment_id) {
                setTimeout(() => {
                    document.getElementById('noteAppointment').value = note.appointment_id;
                }, 100);
            }
            document.getElementById('noteModal').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading note:', error);
    }
}

async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    
    try {
        const response = await fetch(`/api/notes/${noteId}`, {method: 'DELETE'});
        const data = await response.json();
        
        if (data.success) {
            loadNotes();
        } else {
            alert('Error deleting note: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting note:', error);
        alert('Error deleting note');
    }
}

// Load notes on page load
document.addEventListener('DOMContentLoaded', loadNotes);

// SMS & Correspondence functionality
function openSmsModal() {
    document.getElementById('smsModal').classList.remove('hidden');
    // Update character count
    const messageField = document.getElementById('smsMessage');
    messageField.addEventListener('input', updateCharCount);
    updateCharCount();
}

function closeSmsModal() {
    document.getElementById('smsModal').classList.add('hidden');
    document.getElementById('smsForm').reset();
}

function updateCharCount() {
    const messageField = document.getElementById('smsMessage');
    const charCount = document.getElementById('charCount');
    charCount.textContent = messageField.value.length;
}

let tempPassword = '';

function openIOSInviteModal() {
    // Generate preview first
    generateInvitePreview();
    document.getElementById('iosInviteModal').classList.remove('hidden');
}

function closeIOSInviteModal() {
    document.getElementById('iosInviteModal').classList.add('hidden');
    document.getElementById('iosInviteForm').reset();
    tempPassword = '';
}

function generateNewPassword() {
    generateInvitePreview();
}

async function generateInvitePreview() {
    try {
        // Generate password on backend
        const response = await fetch(`/api/patients/{{ patient.id }}/generate-invite-password`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (data.success) {
            tempPassword = data.temp_password;
            document.getElementById('tempPasswordPreview').textContent = tempPassword;
            updateMessagePreview();
        } else {
            alert('Error generating password: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error generating password:', error);
        // Generate a simple password client-side as fallback
        tempPassword = Math.random().toString(36).slice(-12) + Math.random().toString(36).slice(-4);
        document.getElementById('tempPasswordPreview').textContent = tempPassword;
        updateMessagePreview();
    }
}

function updateMessagePreview() {
    const patientEmail = '{{ patient.email }}';
    const patientName = '{{ patient.first_name }}';
    const appStoreUrl = 'https://apps.apple.com/app/capturecare';
    
    // Email message
    const emailMessage = `Hi ${patientName}, 

You've been invited to use the CaptureCare patient app! 

Download the app and sign in with:
Email: ${patientEmail}
Password: ${tempPassword}

You can change your password after signing in.

Download: ${appStoreUrl}

- CaptureCare Team`;
    
    document.getElementById('emailMessagePreview').textContent = emailMessage;
    
    // SMS message (shorter)
    const smsMessage = `CaptureCare App Invite: Download the app and sign in with email ${patientEmail} and password ${tempPassword}. Change password after login.`;
    document.getElementById('smsMessagePreview').textContent = smsMessage;
    document.getElementById('smsCharCount').textContent = smsMessage.length;
    
    // Update SMS character count color
    const charCountEl = document.getElementById('smsCharCount');
    if (smsMessage.length > 160) {
        charCountEl.classList.add('text-red-600', 'font-bold');
    } else {
        charCountEl.classList.remove('text-red-600', 'font-bold');
    }
}

async function sendIOSInviteFromModal(event) {
    event.preventDefault();
    
    // Get selected send methods
    const sendMethods = Array.from(document.querySelectorAll('input[name="send_methods"]:checked')).map(cb => cb.value);
    
    if (sendMethods.length === 0) {
        alert('Please select at least one delivery method (Email or SMS)');
        return;
    }
    
    const btn = document.getElementById('sendInviteBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/send-ios-invite`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                send_methods: sendMethods,
                temp_password: tempPassword
            })
        });
        
        // Check if response is ok before parsing
        if (!response.ok) {
            let errorText = '';
            try {
                errorText = await response.text();
                // Try to parse as JSON if possible
                try {
                    const errorJson = JSON.parse(errorText);
                    throw new Error(errorJson.error || `Server error: ${response.status}`);
                } catch {
                    // Not JSON, use text
                    throw new Error(`Server error (${response.status}): ${errorText.substring(0, 100)}`);
                }
            } catch (e) {
                throw new Error(`Server error: ${response.status} - ${e.message}`);
            }
        }
        
        // Check content type before parsing JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Unexpected response format: ${text.substring(0, 100)}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            let message = '‚úÖ iOS app invite sent successfully!\n\n';
            if (data.email_sent) message += '‚úì Email sent\n';
            if (data.sms_sent) message += '‚úì SMS sent\n';
            message += `\nTemporary password: ${data.temp_password}\n\n`;
            message += 'Patient can sign in with their email and this password, then change it in the app.';
            alert(message);
            closeIOSInviteModal();
            loadCorrespondence(); // Reload correspondence list
        } else {
            alert('‚ùå Error sending invite: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error sending iOS app invite:', error);
        alert('‚ùå Error sending invite: ' + (error.message || 'Unknown error'));
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Legacy function for backward compatibility
async function sendIOSAppInvite() {
    openIOSInviteModal();
}

async function sendSms(event) {
    event.preventDefault();
    
    const phone = document.getElementById('smsPhone').value;
    const message = document.getElementById('smsMessage').value;
    
    if (!phone || !message) {
        alert('Please fill in all fields');
        return;
    }
    
    const btn = event.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/send-sms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone, message})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ SMS sent successfully!');
            closeSmsModal();
            loadCorrespondence(); // Reload correspondence list
        } else {
            alert('‚ùå Error sending SMS: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending SMS:', error);
        alert('‚ùå Error sending SMS: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send SMS';
    }
}

// Call functionality
let callStartTime = null;
let callTimerInterval = null;
let callSid = null;
let isMuted = false;
let isOnHold = false;

function openCallModal() {
    document.getElementById('callModal').classList.remove('hidden');
    document.getElementById('callSetupView').classList.remove('hidden');
    document.getElementById('activeCallView').classList.add('hidden');
}

function closeCallModal() {
    document.getElementById('callModal').classList.add('hidden');
    document.getElementById('callForm').reset();
    document.getElementById('callNotes').value = '';
    stopCallTimer();
    callSid = null;
    isMuted = false;
    isOnHold = false;
}

function startCallTimer() {
    callStartTime = Date.now();
    callTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimerInterval) {
        clearInterval(callTimerInterval);
        callTimerInterval = null;
    }
}

function getCallDuration() {
    if (!callStartTime) return 0;
    return Math.floor((Date.now() - callStartTime) / 1000);
}

async function initiateCall(event) {
    event.preventDefault();
    
    const phone = document.getElementById('callPhone').value;
    
    if (!phone) {
        alert('Please enter a phone number');
        return;
    }
    
    const btn = event.target.querySelector('button[type="submit"]');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/initiate-call`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone})
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Store call SID
            callSid = data.sid;
            
            // Switch to active call view
            document.getElementById('callSetupView').classList.add('hidden');
            document.getElementById('activeCallView').classList.remove('hidden');
            document.getElementById('activeCallNumber').textContent = phone;
            
            // Start the timer
            startCallTimer();
        } else {
            alert('‚ùå Error initiating call: ' + data.error);
        }
    } catch (error) {
        console.error('Error initiating call:', error);
        alert('‚ùå Error initiating call: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-phone mr-2"></i>Start Call';
    }
}

function toggleMute() {
    isMuted = !isMuted;
    const btn = document.getElementById('muteBtn');
    
    if (isMuted) {
        btn.classList.add('bg-red-100', 'hover:bg-red-200');
        btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
        btn.querySelector('i').classList.add('text-red-600');
        btn.querySelector('i').classList.remove('text-gray-700');
        btn.querySelector('i').classList.remove('fa-microphone');
        btn.querySelector('i').classList.add('fa-microphone-slash');
        btn.querySelector('span').classList.add('text-red-600');
        btn.querySelector('span').classList.remove('text-gray-700');
        btn.querySelector('span').textContent = 'Unmute';
    } else {
        btn.classList.remove('bg-red-100', 'hover:bg-red-200');
        btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
        btn.querySelector('i').classList.remove('text-red-600');
        btn.querySelector('i').classList.add('text-gray-700');
        btn.querySelector('i').classList.add('fa-microphone');
        btn.querySelector('i').classList.remove('fa-microphone-slash');
        btn.querySelector('span').classList.remove('text-red-600');
        btn.querySelector('span').classList.add('text-gray-700');
        btn.querySelector('span').textContent = 'Mute';
    }
}

function toggleHold() {
    isOnHold = !isOnHold;
    const btn = document.getElementById('holdBtn');
    
    if (isOnHold) {
        btn.classList.add('bg-yellow-100', 'hover:bg-yellow-200');
        btn.classList.remove('bg-gray-100', 'hover:bg-gray-200');
        btn.querySelector('i').classList.add('text-yellow-600');
        btn.querySelector('i').classList.remove('text-gray-700');
        btn.querySelector('i').classList.remove('fa-pause');
        btn.querySelector('i').classList.add('fa-play');
        btn.querySelector('span').classList.add('text-yellow-600');
        btn.querySelector('span').classList.remove('text-gray-700');
        btn.querySelector('span').textContent = 'Resume';
    } else {
        btn.classList.remove('bg-yellow-100', 'hover:bg-yellow-200');
        btn.classList.add('bg-gray-100', 'hover:bg-gray-200');
        btn.querySelector('i').classList.remove('text-yellow-600');
        btn.querySelector('i').classList.add('text-gray-700');
        btn.querySelector('i').classList.add('fa-pause');
        btn.querySelector('i').classList.remove('fa-play');
        btn.querySelector('span').classList.remove('text-yellow-600');
        btn.querySelector('span').classList.add('text-gray-700');
        btn.querySelector('span').textContent = 'Hold';
    }
}

async function hangupCall() {
    const duration = getCallDuration();
    const notes = document.getElementById('callNotes').value;
    
    // Stop the timer
    stopCallTimer();
    
    // Save call log with notes and duration
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/end-call`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                call_sid: callSid,
                duration: duration,
                notes: notes
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Close modal and reload correspondence
            closeCallModal();
            loadCorrespondence();
        } else {
            alert('‚ö†Ô∏è Warning: Failed to save call notes - ' + data.error + '\n\nYour notes:\n' + notes);
            console.error('Error saving call log:', data.error);
            // Still close the modal
            closeCallModal();
            loadCorrespondence();
        }
    } catch (error) {
        console.error('Error ending call:', error);
        // Still close the modal
        closeCallModal();
        loadCorrespondence();
    }
}

async function loadCorrespondence() {
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/correspondence`);
        const data = await response.json();
        
        const correspondenceList = document.getElementById('correspondenceList');
        
        if (data.success && data.correspondence.length > 0) {
            correspondenceList.innerHTML = data.correspondence.map((item, index) => {
                const sentDate = new Date(item.sent_at).toLocaleString('en-AU', {
                    timeZone: 'Australia/Sydney',
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                
                // Channel-specific styling
                let channelIcon, channelColor;
                if (item.channel === 'email') {
                    channelIcon = 'fa-envelope';
                    channelColor = 'bg-blue-100 text-blue-800';
                } else if (item.channel === 'voice') {
                    channelIcon = 'fa-phone';
                    channelColor = 'bg-purple-100 text-purple-800';
                } else if (item.channel === 'video') {
                    channelIcon = 'fa-video';
                    channelColor = 'bg-indigo-100 text-indigo-800';
                } else {
                    channelIcon = 'fa-sms';
                    channelColor = 'bg-green-100 text-green-800';
                }
                
                const directionIcon = item.direction === 'outbound' ? 'fa-arrow-right' : 'fa-arrow-left';
                const statusColor = item.status === 'delivered' || item.status === 'completed' ? 'text-green-600' : 
                                    item.status === 'failed' ? 'text-red-600' : 'text-gray-600';
                
                // Truncate message preview
                const messagePreview = item.body ? (item.body.length > 60 ? item.body.substring(0, 60) + '...' : item.body) : 
                                      item.channel === 'voice' ? 'Voice call' : 
                                      item.channel === 'video' ? 'Video consultation' : '';
                const recipientInfo = item.channel === 'email' ? 
                    (item.recipient_email || item.sender_email || 'N/A') :
                    (item.recipient_phone || item.sender_phone || 'N/A');
                
                return `
                    <div class="border border-gray-200 rounded-lg p-3 hover:bg-gray-50 transition flex items-center justify-between">
                        <div class="flex items-center gap-3 flex-1">
                            <span class="px-2 py-1 text-xs font-semibold rounded ${channelColor}">
                                <i class="fas ${channelIcon}"></i>
                            </span>
                            <span class="text-xs text-gray-600">
                                <i class="fas ${directionIcon}"></i>
                            </span>
                            <span class="text-sm text-gray-700 flex-1">
                                ${item.subject || messagePreview}
                            </span>
                            <span class="text-xs text-gray-500 whitespace-nowrap">${sentDate}</span>
                            ${item.status ? `
                                <span class="text-xs ${statusColor} font-semibold">
                                    ${item.status}
                                </span>
                            ` : ''}
                        </div>
                        <button onclick='viewCorrespondenceDetail(${JSON.stringify(item).replace(/'/g, "\\'")})'
                                class="ml-3 px-3 py-1 bg-brand-bright-teal hover:bg-teal-600 text-white rounded text-xs transition">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                    </div>
                `;
            }).join('');
        } else {
            correspondenceList.innerHTML = '<p class="text-gray-500 text-center py-8">No correspondence yet. Click "Send SMS" to send your first message.</p>';
        }
    } catch (error) {
        console.error('Error loading correspondence:', error);
        document.getElementById('correspondenceList').innerHTML = '<p class="text-red-600 text-center py-4">Error loading correspondence</p>';
    }
}

function viewCorrespondenceDetail(item) {
    const sentDate = new Date(item.sent_at).toLocaleString('en-AU', {
        timeZone: 'Australia/Sydney',
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    
    // Channel-specific styling
    let channelIcon, channelColor;
    if (item.channel === 'email') {
        channelIcon = 'fa-envelope';
        channelColor = 'bg-blue-100 text-blue-800';
    } else if (item.channel === 'voice') {
        channelIcon = 'fa-phone';
        channelColor = 'bg-purple-100 text-purple-800';
    } else if (item.channel === 'video') {
        channelIcon = 'fa-video';
        channelColor = 'bg-indigo-100 text-indigo-800';
    } else {
        channelIcon = 'fa-sms';
        channelColor = 'bg-green-100 text-green-800';
    }
    
    const directionIcon = item.direction === 'outbound' ? 'fa-arrow-right' : 'fa-arrow-left';
    const statusColor = item.status === 'delivered' || item.status === 'completed' ? 'text-green-600' : 
                        item.status === 'failed' ? 'text-red-600' : 'text-gray-600';
    
    const modalContent = `
        <div class="mb-4">
            <div class="flex items-center gap-2 mb-3">
                <span class="px-3 py-1 text-sm font-semibold rounded ${channelColor}">
                    <i class="fas ${channelIcon} mr-1"></i>${item.channel.toUpperCase()}
                </span>
                <span class="text-sm text-gray-600">
                    <i class="fas ${directionIcon} mr-1"></i>${item.direction}
                </span>
                ${item.status ? `
                    <span class="text-sm ${statusColor} font-semibold">
                        ${item.status}
                    </span>
                ` : ''}
            </div>
            
            <div class="text-sm text-gray-600 mb-2">
                <i class="fas fa-clock mr-1"></i>${sentDate}
            </div>
            
            ${item.subject ? `
                <div class="font-bold text-gray-800 mb-3 text-lg">
                    ${item.subject}
                </div>
            ` : ''}
            
            <div class="text-sm text-gray-600 mb-3">
                ${item.channel === 'email' ? 
                    (item.direction === 'outbound' ? 
                        `<i class="fas fa-envelope mr-1"></i>To: ${item.recipient_email || 'N/A'}` :
                        `<i class="fas fa-envelope mr-1"></i>From: ${item.sender_email || 'N/A'}`) :
                    (item.direction === 'outbound' ? 
                        `<i class="fas fa-phone mr-1"></i>To: ${item.recipient_phone || 'N/A'}` :
                        `<i class="fas fa-phone mr-1"></i>From: ${item.sender_phone || 'N/A'}`)
                }
            </div>
            
            ${(item.channel === 'voice' || item.channel === 'video') && item.call_duration ? `
                <div class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-clock mr-1"></i>Duration: ${item.call_duration}s
                </div>
            ` : ''}
        </div>
        
        ${item.channel === 'voice' && item.recording_url ? `
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-3">
                <p class="text-sm font-semibold text-purple-800 mb-2">
                    <i class="fas fa-microphone mr-1"></i>Call Recording
                </p>
                <audio controls class="w-full">
                    <source src="${item.recording_url}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
            </div>
        ` : ''}
        
        ${item.body || (item.channel !== 'voice') ? `
            <div class="bg-gray-50 rounded-lg p-4 mb-3">
                <div class="text-gray-800 whitespace-pre-wrap">
                    ${item.body || 'No message content'}
                </div>
            </div>
        ` : ''}
        
        ${item.transcription ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-3">
                <p class="text-sm font-semibold text-blue-800 mb-2">
                    <i class="fas fa-file-alt mr-1"></i>Transcription
                </p>
                <div class="text-sm text-gray-800 whitespace-pre-wrap">
                    ${item.transcription}
                </div>
            </div>
        ` : ''}
        
        ${item.error_message ? `
            <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-700 text-sm">
                <i class="fas fa-exclamation-circle mr-1"></i><strong>Error:</strong> ${item.error_message}
            </div>
        ` : ''}
    `;
    
    document.getElementById('correspondenceDetailContent').innerHTML = modalContent;
    document.getElementById('correspondenceDetailModal').classList.remove('hidden');
}

function closeCorrespondenceDetailModal() {
    document.getElementById('correspondenceDetailModal').classList.add('hidden');
}

// HeyGen Video Generation Functions
let availableAvatars = [];
let availableVoices = [];
let currentVideoId = null;

async function loadAvatarsAndVoices() {
    try {
        // Load avatars
        const avatarResponse = await fetch('/api/heygen/avatars');
        
        if (!avatarResponse.ok) {
            const errorText = await avatarResponse.text();
            console.error('HeyGen avatars API error:', avatarResponse.status, errorText);
            // Don't show alert if it's just a configuration issue - user might not want to use HeyGen
            return;
        }
        
        const avatarData = await avatarResponse.json();
        
        if (avatarData.success && avatarData.avatars) {
            availableAvatars = avatarData.avatars;
            populateAvatars();
        } else if (avatarData.error) {
            console.warn('HeyGen avatars error:', avatarData.error);
            // Don't show alert - just log it
        }
        
        // Load voices
        const voiceResponse = await fetch('/api/heygen/voices');
        
        if (!voiceResponse.ok) {
            console.error('HeyGen voices API error:', voiceResponse.status);
            return;
        }
        
        const voiceData = await voiceResponse.json();
        
        if (voiceData.success && voiceData.voices) {
            availableVoices = voiceData.voices;
            filterVoices();
        } else if (voiceData.error) {
            console.warn('HeyGen voices error:', voiceData.error);
        }
        
        console.log(`Loaded ${availableAvatars.length} avatars and ${availableVoices.length} voices`);
    } catch (error) {
        console.error('Error loading HeyGen options:', error);
        // Don't show alert - HeyGen might not be configured, which is okay
    }
}

function populateAvatars() {
    const select = document.getElementById('avatarSelect');
    select.innerHTML = '<option value="">ü§ñ Auto-select medical professional</option>';
    
    // Prioritize medical-related avatars
    const medicalAvatars = availableAvatars.filter(a => 
        a.avatar_name.toLowerCase().includes('nurse') ||
        a.avatar_name.toLowerCase().includes('doctor') ||
        a.avatar_name.toLowerCase().includes('medical')
    );
    
    const otherAvatars = availableAvatars.filter(a => !medicalAvatars.includes(a));
    
    if (medicalAvatars.length > 0) {
        const medGroup = document.createElement('optgroup');
        medGroup.label = 'üë®‚Äç‚öïÔ∏è Medical Professionals';
        medicalAvatars.forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar.avatar_id;
            const gender = avatar.gender ? `${avatar.gender} ‚Ä¢ ` : '';
            option.textContent = `${avatar.avatar_name} (${gender}Medical)`;
            medGroup.appendChild(option);
        });
        select.appendChild(medGroup);
    }
    
    if (otherAvatars.length > 0) {
        const otherGroup = document.createElement('optgroup');
        otherGroup.label = 'üë• Other Avatars';
        otherAvatars.slice(0, 20).forEach(avatar => {
            const option = document.createElement('option');
            option.value = avatar.avatar_id;
            const gender = avatar.gender ? `${avatar.gender} ‚Ä¢ ` : '';
            option.textContent = `${avatar.avatar_name} (${gender}${avatar.avatar_style || 'standard'})`;
            otherGroup.appendChild(option);
        });
        select.appendChild(otherGroup);
    }
}

function filterVoices() {
    const language = document.getElementById('voiceLanguage').value;
    const gender = document.getElementById('voiceGender').value;
    const select = document.getElementById('voiceSelect');
    
    let filtered = availableVoices;
    
    // Filter by language (HeyGen API returns 'languages' as array)
    if (language) {
        filtered = filtered.filter(v => {
            const languages = v.languages || [];
            return languages.some(lang => lang.toLowerCase().includes(language.toLowerCase()));
        });
    }
    
    // Filter by gender
    if (gender) {
        filtered = filtered.filter(v => 
            v.gender && v.gender.toLowerCase() === gender.toLowerCase()
        );
    }
    
    // Populate dropdown
    select.innerHTML = '<option value="">Auto-select best voice</option>';
    
    filtered.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.voice_id;
        const langs = voice.languages ? voice.languages.join(', ') : 'Unknown';
        const gen = voice.gender || '?';
        option.textContent = `${voice.name} (${langs} ‚Ä¢ ${gen})`;
        select.appendChild(option);
    });
    
    console.log(`Filtered to ${filtered.length} voices for ${language} ${gender}`);
}

async function generateHeyGenVideo() {
    const avatarId = document.getElementById('avatarSelect').value || null;
    const voiceId = document.getElementById('voiceSelect').value || null;
    const voiceLanguage = document.getElementById('voiceLanguage').value;
    const voiceGender = document.getElementById('voiceGender').value || null;
    const voiceSpeed = parseFloat(document.getElementById('voiceSpeed').value);
    
    // First, generate the health report script using AI
    const scriptResponse = await fetch(`/api/patients/{{ patient.id }}/generate_report?report_type=video_script`);
    const scriptData = await scriptResponse.json();
    
    if (!scriptData.success) {
        alert('Error generating video script: ' + scriptData.error);
        return;
    }
    
    const script = scriptData.report;
    
    // Show status
    document.getElementById('videoResult').classList.add('hidden');
    document.getElementById('videoStatus').classList.remove('hidden');
    document.getElementById('videoStatusText').textContent = 'Generating video script and starting video production...';
    
    try {
        const response = await fetch('/api/heygen/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                script: script,
                avatar_id: avatarId,
                voice_id: voiceId,
                voice_language: voiceLanguage,
                voice_gender: voiceGender,
                voice_speed: voiceSpeed,
                title: `Health Report - {{ patient.first_name }} {{ patient.last_name }}`
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.video_id) {
            currentVideoId = data.video_id;
            document.getElementById('videoStatusText').textContent = `Video generation in progress (ID: ${data.video_id})`;
            
            // Poll for completion
            pollVideoStatus();
        } else {
            document.getElementById('videoStatus').classList.add('hidden');
            alert('Error generating video: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error generating video:', error);
        document.getElementById('videoStatus').classList.add('hidden');
        alert('Error generating video: ' + error.message);
    }
}

async function checkVideoStatus() {
    if (!currentVideoId) {
        alert('No video generation in progress');
        return;
    }
    
    try {
        const response = await fetch(`/api/heygen/status/${currentVideoId}`);
        const data = await response.json();
        
        if (data.success) {
            handleVideoStatus(data);
        } else {
            alert('Error checking status: ' + data.error);
        }
    } catch (error) {
        console.error('Error checking video status:', error);
        alert('Error checking status: ' + error.message);
    }
}

function handleVideoStatus(data) {
    const status = data.status;
    
    if (status === 'completed') {
        document.getElementById('videoStatus').classList.add('hidden');
        document.getElementById('videoResult').classList.remove('hidden');
        document.getElementById('videoLink').href = data.video_url;
        document.getElementById('videoDownload').href = data.video_url;
        
        // Save video URL to patient notes automatically
        if (data.video_url && currentVideoId) {
            saveHeyGenVideoNote(data.video_url, currentVideoId);
        }
        
        currentVideoId = null;
    } else if (status === 'failed' || status === 'error') {
        document.getElementById('videoStatus').classList.add('hidden');
        alert('Video generation failed: ' + (data.error || 'Unknown error'));
        currentVideoId = null;
    } else {
        // Still processing
        document.getElementById('videoStatusText').textContent = `Video generation in progress (Status: ${status})`;
    }
}

async function pollVideoStatus() {
    const maxAttempts = 60; // 5 minutes with 5-second intervals
    let attempts = 0;
    
    const interval = setInterval(async () => {
        attempts++;
        
        if (attempts >= maxAttempts) {
            clearInterval(interval);
            document.getElementById('videoStatusText').textContent = 'Video generation timed out. Use Refresh button to check status.';
            return;
        }
        
        try {
            const response = await fetch(`/api/heygen/status/${currentVideoId}`);
            const data = await response.json();
            
            if (data.success) {
                const status = data.status;
                
                if (status === 'completed') {
                    clearInterval(interval);
                    handleVideoStatus(data);
                } else if (status === 'failed' || status === 'error') {
                    clearInterval(interval);
                    handleVideoStatus(data);
                } else {
                    document.getElementById('videoStatusText').textContent = 
                        `Video generation in progress... (${attempts * 5}s elapsed)`;
                }
            }
        } catch (error) {
            console.error('Error polling video status:', error);
        }
    }, 5000); // Poll every 5 seconds
}

// Load avatars and voices on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAvatarsAndVoices();
});

// ====================
// HEALTH REPORT EDITOR
// ====================

let reportEditor = null;
let currentReportType = 'patient';
let attachedFiles = [];

function openReportEditor(reportType) {
    currentReportType = reportType;
    
    // If video script, open special modal with date range, avatar, and script editing
    if (reportType === 'video_script') {
        openVideoScriptModal();
        return;
    }
    
    const modal = document.getElementById('reportEditorModal');
    const modalTitle = document.getElementById('reportEditorTitle');
    
    // Set title based on report type
    const titles = {
        'patient': 'Patient-Friendly Health Report',
        'clinical': 'Clinical Note (SOAP Format)'
    };
    modalTitle.textContent = titles[reportType] || 'Health Report';
    
    // Show loading
    document.getElementById('reportEditorLoading').classList.remove('hidden');
    document.getElementById('reportEditorContent').classList.add('hidden');
    
    // Open modal
    modal.classList.remove('hidden');
    
    // Generate report
    generateReport(reportType);
}

async function generateReport(reportType) {
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/generate_report?report_type=${reportType}`);
        const data = await response.json();
        
        if (data.success) {
            // Initialize Quill editor if not already done
            if (!reportEditor) {
                reportEditor = new Quill('#reportEditorQuill', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline', 'strike'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'color': [] }, { 'background': [] }],
                            [{ 'align': [] }],
                            ['link'],
                            ['clean']
                        ]
                    }
                });
            }
            
            // Set content
            reportEditor.root.innerHTML = data.report.replace(/\n/g, '<br>');
            
            // Set subject
            document.getElementById('reportSubject').value = `Health Report for ${data.patient_name} - ${new Date().toLocaleDateString()}`;
            
            // Show editor
            document.getElementById('reportEditorLoading').classList.add('hidden');
            document.getElementById('reportEditorContent').classList.remove('hidden');
            
        } else {
            alert('Error generating report: ' + data.error);
            closeReportEditor();
        }
    } catch (error) {
        console.error('Error generating report:', error);
        alert('Error generating report: ' + error.message);
        closeReportEditor();
    }
}

function closeReportEditor() {
    document.getElementById('reportEditorModal').classList.add('hidden');
    attachedFiles = [];
    updateAttachmentsList();
}

function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    attachedFiles = attachedFiles.concat(files);
    updateAttachmentsList();
}

function removeAttachment(index) {
    attachedFiles.splice(index, 1);
    updateAttachmentsList();
}

function updateAttachmentsList() {
    const container = document.getElementById('attachmentsList');
    
    if (attachedFiles.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-sm">No attachments</p>';
        return;
    }
    
    container.innerHTML = attachedFiles.map((file, index) => `
        <div class="flex items-center justify-between bg-gray-50 p-2 rounded border border-gray-200">
            <div class="flex items-center space-x-2">
                <i class="fas fa-file text-brand-bright-teal"></i>
                <span class="text-sm">${file.name}</span>
                <span class="text-xs text-gray-500">(${(file.size / 1024).toFixed(1)} KB)</span>
            </div>
            <button type="button" onclick="removeAttachment(${index})" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function updateRecipientField() {
    const recipientType = document.getElementById('reportRecipientType').value;
    const customEmailContainer = document.getElementById('customEmailContainer');
    const gpEmailContainer = document.getElementById('gpEmailContainer');
    const btnText = document.getElementById('sendReportBtnText');
    
    // Hide all optional fields first
    customEmailContainer.classList.add('hidden');
    gpEmailContainer.classList.add('hidden');
    
    // Update button text and show appropriate field
    if (recipientType === '') {
        btnText.innerHTML = '<i class="fas fa-save mr-1"></i>Save to Correspondence';
    } else if (recipientType === 'patient') {
        btnText.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Send to Patient & Save';
    } else if (recipientType === 'gp') {
        btnText.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Send to GP & Save';
        gpEmailContainer.classList.remove('hidden');
    } else if (recipientType === 'custom') {
        btnText.innerHTML = '<i class="fas fa-paper-plane mr-1"></i>Send Email & Save';
        customEmailContainer.classList.remove('hidden');
    }
}

async function sendReport() {
    if (!reportEditor) {
        alert('Report editor not initialized');
        return;
    }
    
    const recipientType = document.getElementById('reportRecipientType').value;
    
    // Validate email if sending
    if (recipientType === 'custom') {
        const customEmail = document.getElementById('reportCustomEmail').value.trim();
        if (!customEmail) {
            alert('Please enter an email address');
            return;
        }
        if (!customEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Please enter a valid email address');
            return;
        }
    } else if (recipientType === 'gp') {
        const gpEmail = document.getElementById('reportGpEmail').value.trim();
        if (!gpEmail) {
            alert('Please enter the GP\'s email address');
            return;
        }
        if (!gpEmail.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
            alert('Please enter a valid email address');
            return;
        }
    }
    
    const sendBtn = document.getElementById('sendReportBtn');
    const originalBtnText = sendBtn.innerHTML;
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    
    try {
        const formData = new FormData();
        formData.append('report_html', reportEditor.root.innerHTML);
        formData.append('subject', document.getElementById('reportSubject').value);
        formData.append('report_type', currentReportType === 'clinical' ? 'SOAP' : 'ai_report');
        formData.append('recipient_type', recipientType);
        
        // Add recipient email if applicable
        if (recipientType === 'custom') {
            formData.append('recipient_email', document.getElementById('reportCustomEmail').value.trim());
        } else if (recipientType === 'gp') {
            formData.append('recipient_email', document.getElementById('reportGpEmail').value.trim());
            formData.append('recipient_name', '{{ patient.gp_name|default("GP", true) }}');
        } else if (recipientType === 'patient') {
            formData.append('recipient_email', '{{ patient.email }}');
            formData.append('recipient_name', '{{ patient.first_name }} {{ patient.last_name }}');
        }
        
        // Add file attachments
        attachedFiles.forEach(file => {
            formData.append('attachments', file);
        });
        
        const response = await fetch('/api/patients/{{ patient.id }}/send_report', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ ' + data.message);
            closeReportEditor();
            // Reload page to show updated correspondence
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending report:', error);
        alert('‚ùå Error sending report: ' + error.message);
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalBtnText;
    }
}

function previewReport() {
    if (!reportEditor) {
        alert('Report editor not initialized');
        return;
    }
    
    const previewWindow = window.open('', 'Report Preview', 'width=800,height=600');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Report Preview</title>
            <style>
                body {
                    font-family: 'Segoe UI', Arial, sans-serif;
                    line-height: 1.6;
                    color: #3e4044;
                    max-width: 800px;
                    margin: 20px auto;
                    padding: 20px;
                }
                h1, h2, h3 { color: #00698f; }
            </style>
        </head>
        <body>
            <h1>${document.getElementById('reportSubject').value}</h1>
            <hr>
            ${reportEditor.root.innerHTML}
        </body>
        </html>
    `);
    previewWindow.document.close();
}

// ====================
// VIDEO SCRIPT MODAL
// ====================

let videoScriptEditor = null;
let videoScriptGenerated = false;
window.allVideoScriptVoices = [];

function openVideoScriptModal() {
    const modal = document.getElementById('videoScriptModal');
    modal.classList.remove('hidden');
    
    // Reset to step 1
    document.getElementById('videoScriptStep1').classList.remove('hidden');
    document.getElementById('videoScriptStep2').classList.add('hidden');
    document.getElementById('videoScriptStep3').classList.add('hidden');
    document.getElementById('videoScriptStep4').classList.add('hidden');
    
    // Load avatars immediately when modal opens
    loadVideoScriptAvatars();
}

function closeVideoScriptModal() {
    document.getElementById('videoScriptModal').classList.add('hidden');
}

async function loadVideoScriptAvatars() {
    const avatarSelect = document.getElementById('videoScriptAvatarSelect');
    avatarSelect.innerHTML = '<option value="">Loading your avatars...</option>';
    
    try {
        const response = await fetch('/api/heygen/avatars');
        
        if (!response.ok) {
            console.warn('HeyGen API not available:', response.status);
            avatarSelect.innerHTML = '<option value="">HeyGen not configured</option>';
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.avatars) {
            avatarSelect.innerHTML = '<option value="">-- Select an avatar from your account --</option>';
            
            data.avatars.forEach(avatar => {
                const option = document.createElement('option');
                option.value = avatar.avatar_id;
                const genderIcon = avatar.gender === 'female' ? 'üë©' : avatar.gender === 'male' ? 'üë®' : 'üßë';
                const style = avatar.avatar_style || 'normal';
                option.textContent = `${genderIcon} ${avatar.avatar_name} (${style})`;
                avatarSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${data.avatars.length} avatars from your HeyGen account`);
        } else {
            avatarSelect.innerHTML = '<option value="">HeyGen not configured</option>';
            console.warn('HeyGen not configured:', data.error);
        }
    } catch (error) {
        console.warn('HeyGen not available:', error);
        avatarSelect.innerHTML = '<option value="">HeyGen not configured</option>';
    }
}

function proceedToVoiceSelection() {
    const avatarId = document.getElementById('videoScriptAvatarSelect').value;
    
    if (!avatarId) {
        alert('Please select an avatar first');
        return;
    }
    
    // Move to step 2 (voice selection)
    document.getElementById('videoScriptStep1').classList.add('hidden');
    document.getElementById('videoScriptStep2').classList.remove('hidden');
    
    // Load voices and languages if not already loaded
    if (window.allVideoScriptVoices.length === 0) {
        loadVideoScriptVoicesAndLanguages();
    }
}

function goBackToAvatarSelection() {
    document.getElementById('videoScriptStep2').classList.add('hidden');
    document.getElementById('videoScriptStep1').classList.remove('hidden');
}

async function loadVideoScriptVoicesAndLanguages() {
    try {
        const [voicesRes, languagesRes] = await Promise.all([
            fetch('/api/heygen/voices'),
            fetch('/api/heygen/languages')
        ]);
        
        const voicesData = await voicesRes.json();
        const languagesData = await languagesRes.json();
        
        if (voicesData.success) {
            window.allVideoScriptVoices = voicesData.voices;
            console.log(`‚úÖ Loaded ${voicesData.voices.length} voices from HeyGen`);
            filterVideoScriptVoices();
        }
        
        if (languagesData.success) {
            const languageSelect = document.getElementById('videoScriptVoiceLanguage');
            languageSelect.innerHTML = '<option value="">-- Select language --</option>';
            
            languagesData.languages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang;
                option.textContent = lang;
                if (lang.toLowerCase().includes('english')) {
                    option.selected = true;
                }
                languageSelect.appendChild(option);
            });
            
            console.log(`‚úÖ Loaded ${languagesData.languages.length} languages from HeyGen`);
            filterVideoScriptVoices();
        }
    } catch (error) {
        console.error('Error loading voices/languages:', error);
        alert('Failed to load voice options. Please check your HeyGen API key in Settings.');
    }
}

function filterVideoScriptVoices() {
    const language = document.getElementById('videoScriptVoiceLanguage').value;
    const gender = document.getElementById('videoScriptVoiceGender').value;
    const voiceSelect = document.getElementById('videoScriptVoiceSelect');
    
    voiceSelect.innerHTML = '<option value="">Auto-select best voice</option>';
    
    if (window.allVideoScriptVoices.length === 0) return;
    
    const filteredVoices = window.allVideoScriptVoices.filter(voice => {
        // Check if language matches (handle both string and array formats)
        let matchesLanguage = !language;
        if (language) {
            if (voice.language && voice.language.toLowerCase().includes(language.toLowerCase())) {
                matchesLanguage = true;
            }
            if (voice.languages && Array.isArray(voice.languages)) {
                matchesLanguage = matchesLanguage || voice.languages.some(l => 
                    l.toLowerCase().includes(language.toLowerCase()) || 
                    language.toLowerCase().includes(l.toLowerCase())
                );
            }
        }
        
        const matchesGender = !gender || (voice.gender && voice.gender.toLowerCase() === gender.toLowerCase());
        return matchesLanguage && matchesGender;
    });
    
    filteredVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.voice_id;
        const genderIcon = voice.gender === 'female' ? '‚ôÄÔ∏è' : voice.gender === 'male' ? '‚ôÇÔ∏è' : '';
        const voiceLanguage = voice.language || (voice.languages ? voice.languages[0] : 'Unknown');
        option.textContent = `${voice.name} ${genderIcon} (${voiceLanguage})`;
        voiceSelect.appendChild(option);
    });
    
    console.log(`Filtered to ${filteredVoices.length} voices for language="${language}" gender="${gender}"`);
}

async function generateVideoScript() {
    const generateBtn = document.getElementById('generateScriptBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating Script...';
    
    // Calculate date range based on selected period
    const periodDays = parseInt(document.getElementById('videoScriptDateRange').value);
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - periodDays);
    
    const startDateStr = startDate.toISOString().split('T')[0];
    const endDateStr = endDate.toISOString().split('T')[0];
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/generate_report?report_type=video_script&start_date=${startDateStr}&end_date=${endDateStr}`);
        
        if (!response.ok) {
            const text = await response.text();
            console.error('Server error response:', text);
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response:', text.substring(0, 500));
            throw new Error('Server returned non-JSON response. Check if you are still logged in.');
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Initialize Quill editor if not already done
            if (!videoScriptEditor) {
                videoScriptEditor = new Quill('#videoScriptQuill', {
                    theme: 'snow',
                    modules: {
                        toolbar: [
                            [{ 'header': [1, 2, 3, false] }],
                            ['bold', 'italic', 'underline'],
                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            ['clean']
                        ]
                    }
                });
            }
            
            videoScriptEditor.root.innerHTML = data.report.replace(/\n/g, '<br>');
            videoScriptGenerated = true;
            
            // Move to step 3 (edit script)
            document.getElementById('videoScriptStep2').classList.add('hidden');
            document.getElementById('videoScriptStep3').classList.remove('hidden');
            
        } else {
            alert('Error generating script: ' + data.error);
        }
    } catch (error) {
        console.error('Error generating script:', error);
        alert('Error generating script: ' + error.message);
    } finally {
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles mr-2"></i>Generate Script';
    }
}

function goBackToVoiceSelection() {
    document.getElementById('videoScriptStep3').classList.add('hidden');
    document.getElementById('videoScriptStep2').classList.remove('hidden');
}

async function generateVideoFromScript() {
    if (!videoScriptEditor) {
        alert('Script editor not initialized');
        return;
    }
    
    const generateBtn = document.getElementById('generateVideoBtn');
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Starting Generation...';
    
    try {
        const scriptText = videoScriptEditor.getText().trim();
        
        if (!scriptText || scriptText.length < 10) {
            alert('Script is too short. Please add more content.');
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Generate Video';
            return;
        }
        
        const data = {
            script: scriptText,
            avatar_id: document.getElementById('videoScriptAvatarSelect').value,
            voice_id: document.getElementById('videoScriptVoiceSelect').value || null,
            voice_gender: document.getElementById('videoScriptVoiceGender').value || null,
            voice_language: document.getElementById('videoScriptVoiceLanguage').value || 'English',
            voice_speed: parseFloat(document.getElementById('videoScriptVoiceSpeed').value || 1.0),
            title: `Health Report Video for {{ patient.first_name }} {{ patient.last_name }}`
        };
        
        const response = await fetch('/api/heygen/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Move to step 4 (video status)
            document.getElementById('videoScriptStep3').classList.add('hidden');
            document.getElementById('videoScriptStep4').classList.remove('hidden');
            document.getElementById('videoScriptVideoStatus').classList.remove('hidden');
            document.getElementById('videoScriptVideoResult').classList.add('hidden');
            document.getElementById('videoScriptVideoStatusText').textContent = `Video generation started (ID: ${result.video_id})`;
            
            // Poll for status
            pollVideoScriptStatus(result.video_id);
            
        } else {
            alert('Error generating video: ' + result.error);
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Generate Video';
        }
    } catch (error) {
        console.error('Error generating video:', error);
        alert('Error generating video: ' + error.message);
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Generate Video';
    }
}

function pollVideoScriptStatus(videoId) {
    let attempts = 0;
    const maxAttempts = 60; // 5 minutes max
    
    const interval = setInterval(async () => {
        attempts++;
        
        if (attempts > maxAttempts) {
            clearInterval(interval);
            document.getElementById('videoScriptVideoStatusText').textContent = 'Video generation timed out. Please try again.';
            return;
        }
        
        try {
            const response = await fetch(`/api/heygen/status/${videoId}`);
            const data = await response.json();
            
            if (data.success) {
                const status = data.status;
                
                if (status === 'completed') {
                    clearInterval(interval);
                    document.getElementById('videoScriptVideoStatus').classList.add('hidden');
                    document.getElementById('videoScriptVideoResult').classList.remove('hidden');
                    document.getElementById('videoScriptVideoLink').href = data.video_url;
                    document.getElementById('videoScriptVideoDownload').href = data.video_url;
                    console.log('‚úÖ Video generation completed!', data.video_url);
                    
                    // Save video URL to patient notes automatically ONLY if not already saved in this session
                    if (!window.videoNoteSavedForId || window.videoNoteSavedForId !== videoId) {
                         saveHeyGenVideoNote(data.video_url, videoId);
                         window.videoNoteSavedForId = videoId;
                    }
                } else if (status === 'failed' || status === 'error') {
                    clearInterval(interval);
                    document.getElementById('videoScriptVideoStatusText').textContent = `Video generation failed: ${data.error || 'Unknown error'}`;
                } else {
                    document.getElementById('videoScriptVideoStatusText').textContent = 
                        `Video generation in progress... (${attempts * 5}s elapsed)`;
                }
            }
        } catch (error) {
            console.error('Error polling video status:', error);
        }
    }, 5000);
}

// Save HeyGen video URL to patient notes
async function saveHeyGenVideoNote(videoUrl, videoId) {
    try {
        const noteText = `AI Health report via Avatar\n${videoUrl}\n\nVideo ID: ${videoId}`;
        const subject = 'AI Health report via Avatar';
        
        const response = await fetch(`/api/patients/{{ patient.id }}/notes`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                note_text: noteText,
                note_type: 'heygen_video',
                subject: subject,
                author: '{{ current_user.username if current_user else "System" }}'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            console.log('‚úÖ HeyGen video saved to patient notes');
            // Reload notes to show the new entry
            if (typeof loadNotes === 'function') {
                loadNotes();
            }
        } else {
            console.error('‚ùå Failed to save video to notes:', data.error);
        }
    } catch (error) {
        console.error('‚ùå Error saving video to notes:', error);
    }
}

function resetVideoGeneration() {
    // Reset all states and go back to step 1
    videoScriptEditor = null;
    videoScriptGenerated = false;
    
    document.getElementById('videoScriptStep4').classList.add('hidden');
    document.getElementById('videoScriptStep1').classList.remove('hidden');
    document.getElementById('videoScriptVideoStatus').classList.add('hidden');
    document.getElementById('videoScriptVideoResult').classList.add('hidden');
    
    // Reload avatars
    loadVideoScriptAvatars();
}
</script>

<!-- Quill.js CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Report Editor Modal -->
<div id="reportEditorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-brand-teal to-brand-bright-teal text-white p-6 rounded-t-lg sticky top-0">
            <div class="flex justify-between items-center">
                <h2 id="reportEditorTitle" class="text-2xl font-bold">Health Report Editor</h2>
                <button onclick="closeReportEditor()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="reportEditorLoading" class="p-12 text-center">
            <i class="fas fa-spinner fa-spin text-6xl text-brand-bright-teal mb-4"></i>
            <p class="text-xl text-gray-600">Generating AI health report...</p>
        </div>
        
        <!-- Editor Content -->
        <div id="reportEditorContent" class="hidden p-6">
            <!-- Subject Line -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-envelope mr-2"></i>Email Subject
                </label>
                <input type="text" id="reportSubject" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-brand-bright-teal"
                       placeholder="Health Report Subject">
            </div>
            
            <!-- Rich Text Editor -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-edit mr-2"></i>Report Content
                </label>
                <div id="reportEditorQuill" style="height: 400px;" class="bg-white border border-gray-300 rounded-lg"></div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>Use the toolbar above to format your report. You can add headings, lists, colors, and more.
                </p>
            </div>
            
            <!-- File Attachments -->
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-paperclip mr-2"></i>Attachments (Optional)
                </label>
                <div class="flex items-center space-x-3 mb-3">
                    <label class="cursor-pointer bg-brand-soft-blue text-white px-4 py-2 rounded-lg hover:bg-brand-bright-teal transition">
                        <i class="fas fa-upload mr-2"></i>Add File
                        <input type="file" multiple onchange="handleFileUpload(event)" class="hidden" 
                               accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt">
                    </label>
                    <span class="text-sm text-gray-500">Add meal plans, PDFs, images, etc.</span>
                </div>
                <div id="attachmentsList" class="space-y-2">
                    <p class="text-gray-500 text-sm">No attachments</p>
                </div>
            </div>
            
            <!-- Email Recipient Section -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-user-md mr-2"></i>Send Email To (Optional)
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Recipient Type -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-2">Recipient</label>
                        <select id="reportRecipientType" onchange="updateRecipientField()" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal text-sm">
                            <option value="">None - Save to Correspondence Only</option>
                            <option value="patient">Patient ({{ patient.email }})</option>
                            <option value="gp">Patient's GP</option>
                            <option value="custom">Other (Custom Email)</option>
                        </select>
                    </div>
                    
                    <!-- Custom Email Field (shown when custom is selected) -->
                    <div id="customEmailContainer" class="hidden">
                        <label class="block text-xs font-medium text-gray-600 mb-2">Email Address</label>
                        <input type="email" id="reportCustomEmail" 
                               placeholder="doctor@example.com"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal text-sm">
                    </div>
                    
                    <!-- GP Email (shown when GP is selected) -->
                    <div id="gpEmailContainer" class="hidden">
                        <label class="block text-xs font-medium text-gray-600 mb-2">GP Email</label>
                        {% if patient.gp_name %}
                        <div class="p-2 bg-white rounded border border-gray-300 text-sm">
                            <p class="font-medium">{{ patient.gp_name }}</p>
                            <input type="email" id="reportGpEmail" 
                                   placeholder="Enter GP email address"
                                   class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                        </div>
                        {% else %}
                        <div class="p-2 bg-yellow-50 rounded border border-yellow-300 text-sm">
                            <p class="text-yellow-800"><i class="fas fa-exclamation-triangle mr-1"></i>No GP recorded</p>
                            <input type="email" id="reportGpEmail" 
                                   placeholder="Enter GP email address"
                                   class="w-full mt-1 px-2 py-1 border border-gray-300 rounded text-sm">
                        </div>
                        {% endif %}
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>Leave as "None" to save to Correspondence without sending an email. Select a recipient to send via email.
                </p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button type="button" onclick="previewReport()" 
                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-eye mr-2"></i>Preview
                </button>
                <div class="flex space-x-3">
                    <button type="button" onclick="closeReportEditor()" 
                            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button type="button" id="sendReportBtn" onclick="sendReport()" 
                            class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                        <i class="fas fa-save mr-2"></i><span id="sendReportBtnText">Save to Correspondence</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quill.js JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<!-- Video Script Modal -->
<div id="videoScriptModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 rounded-t-lg sticky top-0">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold"><i class="fas fa-video mr-2"></i>AI Avatar Health Video Generator</h2>
                    <p class="text-sm mt-1 opacity-90">Select avatar ‚Üí Choose voice ‚Üí Generate script ‚Üí Create video</p>
                </div>
                <button onclick="closeVideoScriptModal()" class="text-white hover:text-gray-200 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 1: Select Avatar from Account -->
        <div id="videoScriptStep1" class="p-6">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <span class="bg-purple-600 text-white rounded-full px-3 py-1 text-sm mr-2">Step 1</span>
                    Select Your Avatar
                </h3>
                <p class="text-gray-600 mb-4">Choose an avatar from your HeyGen account to present the health video.</p>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-user-circle mr-1"></i>Avatar
                    </label>
                    <select id="videoScriptAvatarSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-base">
                        <option value="">Loading your avatars...</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>These avatars are from your HeyGen account. Add more at heygen.com
                    </p>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="closeVideoScriptModal()" 
                        class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="proceedToVoiceBtn" onclick="proceedToVoiceSelection()" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md">
                    <i class="fas fa-arrow-right mr-2"></i>Next: Choose Voice
                </button>
            </div>
        </div>
        
        <!-- Step 2: Choose Voice & Language -->
        <div id="videoScriptStep2" class="hidden p-6">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <span class="bg-purple-600 text-white rounded-full px-3 py-1 text-sm mr-2">Step 2</span>
                    Choose Voice & Language
                </h3>
                <p class="text-gray-600 mb-4">Select the language, gender, and specific voice for your video.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-globe mr-1"></i>Language
                        </label>
                        <select id="videoScriptVoiceLanguage" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterVideoScriptVoices()">
                            <option value="">Loading languages...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-venus-mars mr-1"></i>Voice Gender
                        </label>
                        <select id="videoScriptVoiceGender" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" onchange="filterVideoScriptVoices()">
                            <option value="">Any gender</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                        </select>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-microphone mr-1"></i>Select Voice
                        </label>
                        <select id="videoScriptVoiceSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Auto-select best voice</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Leave as auto-select to automatically choose based on language & gender</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-gauge mr-1"></i>Speech Speed
                        </label>
                        <select id="videoScriptVoiceSpeed" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="0.8">üê¢ Slow (0.8x)</option>
                            <option value="0.9">Slightly Slow (0.9x)</option>
                            <option value="1.0" selected>‚úÖ Normal (1.0x)</option>
                            <option value="1.1">Slightly Fast (1.1x)</option>
                            <option value="1.2">üêá Fast (1.2x)</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar-alt mr-1"></i>Health Data Period
                        </label>
                        <select id="videoScriptDateRange" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="goBackToAvatarSelection()" 
                        class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Avatar
                </button>
                <button id="generateScriptBtn" onclick="generateVideoScript()" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md">
                    <i class="fas fa-wand-magic-sparkles mr-2"></i>Generate Script
                </button>
            </div>
        </div>
        
        <!-- Step 3: Review & Edit Script -->
        <div id="videoScriptStep3" class="hidden p-6">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <span class="bg-purple-600 text-white rounded-full px-3 py-1 text-sm mr-2">Step 3</span>
                    Review and Edit Video Script
                </h3>
                <p class="text-gray-600 mb-4">Edit the AI-generated script before creating your video. The avatar will speak this text.</p>
                
                <div id="videoScriptQuill" style="height: 400px;" class="bg-white border border-gray-300 rounded-lg"></div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>Keep the script concise (60-90 seconds when read aloud). Avoid complex medical terminology.
                </p>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="goBackToVoiceSelection()" 
                        class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Voice
                </button>
                <button id="generateVideoBtn" onclick="generateVideoFromScript()" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md">
                    <i class="fas fa-play-circle mr-2"></i>Generate Video
                </button>
            </div>
        </div>
        
        <!-- Step 4: Video Generation Status -->
        <div id="videoScriptStep4" class="hidden p-6">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <span class="bg-purple-600 text-white rounded-full px-3 py-1 text-sm mr-2">Step 4</span>
                    Video Generation
                </h3>
                
                <!-- Video Status -->
                <div id="videoScriptVideoStatus" class="hidden bg-yellow-50 border border-yellow-300 rounded-lg p-6 mb-4">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-spinner fa-spin text-purple-600 text-2xl"></i>
                        <div>
                            <p class="font-semibold text-purple-800 text-lg" id="videoScriptVideoStatusText">Generating video...</p>
                            <p class="text-sm text-purple-600 mt-1">This may take 2-5 minutes. Please wait...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Video Result -->
                <div id="videoScriptVideoResult" class="hidden bg-green-50 border border-green-300 rounded-lg p-6 mb-4">
                    <h4 class="font-bold text-green-800 mb-4 text-xl">
                        <i class="fas fa-check-circle mr-2"></i>Video Ready!
                    </h4>
                    <div class="flex flex-wrap items-center gap-3">
                        <a id="videoScriptVideoLink" href="#" target="_blank" class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold inline-flex items-center">
                            <i class="fas fa-external-link-alt mr-2"></i>Open Video
                        </a>
                        <a id="videoScriptVideoDownload" href="#" download class="px-6 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold inline-flex items-center">
                            <i class="fas fa-download mr-2"></i>Download
                        </a>
                    </div>
                    <p class="text-xs text-gray-600 mt-4">
                        <i class="fas fa-info-circle mr-1"></i>Video links expire after 7 days. Download for permanent storage.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                <button onclick="closeVideoScriptModal()" 
                        class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    <i class="fas fa-times mr-2"></i>Close
                </button>
                <button onclick="resetVideoGeneration()" 
                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700 transition font-semibold shadow-md">
                    <i class="fas fa-redo mr-2"></i>Create Another Video
                </button>
            </div>
        </div>
    </div>
</div>

</script>

<script>
// Patient Tab Management
const CURRENT_PATIENT_ID = {{ patient.id }};

// Initialize tabs on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeTabs();
    setupPatientSearch();
});

async function initializeTabs() {
    const openTabs = getOpenTabs();
    
    // Update current patient tab with latest name/email from server
    const currentTabIndex = openTabs.findIndex(tab => tab.id === CURRENT_PATIENT_ID);
    if (currentTabIndex >= 0) {
        openTabs[currentTabIndex].name = '{{ patient.first_name }} {{ patient.last_name }}';
        openTabs[currentTabIndex].email = '{{ patient.email }}';
    } else {
        // Add current patient if not already in tabs
        openTabs.push({
            id: CURRENT_PATIENT_ID,
            name: '{{ patient.first_name }} {{ patient.last_name }}',
            email: '{{ patient.email }}'
        });
    }
    
    // Refresh all other tab names from server to ensure they're up to date
    await refreshTabNames(openTabs);
    
    saveOpenTabs(openTabs);
    renderTabs();
}

async function refreshTabNames(tabs) {
    // Fetch current patient names from server for all tabs
    const patientIds = tabs.map(tab => tab.id).filter(id => id !== CURRENT_PATIENT_ID);
    
    if (patientIds.length === 0) {
        return tabs;
    }
    
    try {
        // Fetch patient data for all tabs
        const promises = patientIds.map(async (patientId) => {
            try {
                const response = await fetch(`/api/patients/${patientId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.patient) {
                        return {
                            id: patientId,
                            name: `${data.patient.first_name} ${data.patient.last_name}`,
                            email: data.patient.email
                        };
                    }
                }
            } catch (error) {
                console.error(`Error fetching patient ${patientId}:`, error);
            }
            return null;
        });
        
        const updatedPatients = await Promise.all(promises);
        
        // Update tabs with fresh data
        updatedPatients.forEach(patientData => {
            if (patientData) {
                const tabIndex = tabs.findIndex(tab => tab.id === patientData.id);
                if (tabIndex >= 0) {
                    tabs[tabIndex].name = patientData.name;
                    tabs[tabIndex].email = patientData.email;
                }
            }
        });
    } catch (error) {
        console.error('Error refreshing tab names:', error);
    }
    
    return tabs;
}

function getOpenTabs() {
    const tabs = localStorage.getItem('patientTabs');
    return tabs ? JSON.parse(tabs) : [];
}

function saveOpenTabs(tabs) {
    localStorage.setItem('patientTabs', JSON.stringify(tabs));
}

function renderTabs() {
    const tabs = getOpenTabs();
    const tabContainer = document.querySelector('#patientTabs .flex');
    
    if (tabs.length === 0) {
        document.getElementById('patientTabs').classList.add('hidden');
        return;
    }
    
    document.getElementById('patientTabs').classList.remove('hidden');
    
    tabContainer.innerHTML = tabs.map(tab => {
        const isActive = tab.id === CURRENT_PATIENT_ID;
        return `
            <div class="flex items-center gap-2 px-4 py-3 border-r border-gray-200 ${isActive ? 'bg-brand-bright-teal text-white' : 'bg-white text-gray-700 hover:bg-gray-50 cursor-pointer'} transition-colors"
                 onclick="${isActive ? '' : `switchToPatient(${tab.id})`}">
                <i class="fas fa-user ${isActive ? 'text-white' : 'text-gray-400'}"></i>
                <div class="min-w-0 flex-1">
                    <div class="font-semibold text-sm truncate">${tab.name}</div>
                    <div class="text-xs opacity-75 truncate">${tab.email}</div>
                </div>
                ${tabs.length > 1 ? `
                    <button onclick="event.stopPropagation(); closeTab(${tab.id})" 
                            class="ml-2 hover:bg-gray-200 ${isActive ? 'hover:bg-white/20' : ''} rounded-full p-1 transition">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                ` : ''}
            </div>
        `;
    }).join('');
}

function switchToPatient(patientId) {
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    window.location.href = `/patients/${patientId}?start_date=${startDate}&end_date=${endDate}`;
}

function closeTab(patientId) {
    let tabs = getOpenTabs();
    tabs = tabs.filter(tab => tab.id !== patientId);
    saveOpenTabs(tabs);
    
    if (patientId === CURRENT_PATIENT_ID) {
        // If closing current tab, switch to another one or go to patient list
        if (tabs.length > 0) {
            switchToPatient(tabs[0].id);
        } else {
            window.location.href = '/patients';
        }
    } else {
        renderTabs();
    }
}

function openPatientInNewTab(patientId, patientName, patientEmail) {
    const tabs = getOpenTabs();
    
    // Check if already open
    if (tabs.find(tab => tab.id === patientId)) {
        switchToPatient(patientId);
        return;
    }
    
    // Add new tab
    tabs.push({
        id: patientId,
        name: patientName,
        email: patientEmail
    });
    saveOpenTabs(tabs);
    
    // Navigate to patient
    switchToPatient(patientId);
}

// Patient Search
let searchTimeout;

function setupPatientSearch() {
    const searchInput = document.getElementById('patientSearch');
    const searchResults = document.getElementById('searchResults');
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            searchResults.classList.add('hidden');
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchPatients(query);
        }, 300);
    });
    
    // Hide results when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.classList.add('hidden');
        }
    });
    
    // Show results when focusing on search box
    searchInput.addEventListener('focus', function() {
        if (this.value.length >= 2) {
            searchPatients(this.value.trim());
        }
    });
}

async function searchPatients(query) {
    try {
        const response = await fetch(`/api/patients/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        const searchResults = document.getElementById('searchResults');
        
        if (data.success && data.patients.length > 0) {
            searchResults.innerHTML = data.patients.map(patient => `
                <div class="px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                     onclick="openPatientInNewTab(${patient.id}, '${patient.first_name} ${patient.last_name}', '${patient.email}')">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-user-circle text-2xl text-gray-400"></i>
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-gray-800 truncate">${patient.first_name} ${patient.last_name}</div>
                            <div class="text-sm text-gray-600 truncate">${patient.email}</div>
                            ${patient.phone ? `<div class="text-xs text-gray-500">${patient.phone}</div>` : ''}
                        </div>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                    </div>
                </div>
            `).join('');
            searchResults.classList.remove('hidden');
        } else {
            searchResults.innerHTML = '<div class="px-4 py-3 text-gray-500 text-center">No patients found</div>';
            searchResults.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error searching patients:', error);
        searchResults.innerHTML = '<div class="px-4 py-3 text-red-500 text-center">Error searching patients</div>';
        searchResults.classList.remove('hidden');
    }
}

function showAllPatients() {
    window.location.href = '/patients';
}

// ======================
// TARGET RANGES FUNCTIONS
// ======================

let currentTargetRanges = {};
let aiSuggestedRanges = {};

const METRIC_CONFIG = {
    'weight': { label: 'Weight', unit: 'kg', mode: 'range', icon: 'weight' },
    'heart_rate': { label: 'Heart Rate', unit: 'bpm', mode: 'range', icon: 'heartbeat' },
    'systolic_bp': { label: 'Systolic BP', unit: 'mmHg', mode: 'range', icon: 'heart-pulse' },
    'diastolic_bp': { label: 'Diastolic BP', unit: 'mmHg', mode: 'range', icon: 'heart-pulse' },
    'steps': { label: 'Daily Steps', unit: 'steps', mode: 'range', icon: 'walking' },
    'sleep_duration': { label: 'Sleep Duration', unit: 'hours', mode: 'range', icon: 'bed' },
    'spo2': { label: 'Blood Oxygen (SpO2)', unit: '%', mode: 'range', icon: 'lungs' },
    'hydration': { label: 'Hydration', unit: '%', mode: 'range', icon: 'droplet' },
    'body_temperature': { label: 'Body Temperature', unit: '¬∞C', mode: 'range', icon: 'thermometer' }
};

window.openTargetRangesModal = async function() {
    document.getElementById('targetRangesModal').classList.remove('hidden');
    await loadTargetRanges();
}

function closeTargetRangesModal() {
    document.getElementById('targetRangesModal').classList.add('hidden');
}

async function loadTargetRanges() {
    try {
        const response = await fetch('/api/patients/{{ patient.id }}/target-ranges');
        const data = await response.json();
        
        if (data.success) {
            currentTargetRanges = {};
            data.target_ranges.forEach(tr => {
                currentTargetRanges[tr.measurement_type] = tr;
            });
            
            renderTargetRangesForm(data.patient_age, data.patient_sex);
        }
    } catch (error) {
        console.error('Error loading target ranges:', error);
        document.getElementById('targetRangesContent').innerHTML = '<div class="text-red-500 text-center py-4">Error loading target ranges</div>';
    }
}

function renderTargetRangesForm(age, sex) {
    let html = `
        <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="flex justify-between items-center">
                <div>
                    <h4 class="font-semibold text-gray-800 mb-1">AI-Powered Target Suggestions</h4>
                    <p class="text-sm text-gray-600">Get personalized targets based on age (${age || 'N/A'}), sex (${sex || 'N/A'}), and weight</p>
                </div>
                <button onclick="generateAISuggestions()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-brain mr-2"></i>Generate AI Suggestions
                </button>
            </div>
        </div>
        
        <div class="space-y-4">
    `;
    
    Object.entries(METRIC_CONFIG).forEach(([metric, config]) => {
        const current = currentTargetRanges[metric] || {};
        const hasAISuggestion = current.suggested_min || current.suggested_max || current.suggested_value;
        
        const showInApp = current.show_in_patient_app !== false; // Default to true
        html += `
            <div class="border border-gray-200 rounded-lg p-4">
                <div class="flex items-center justify-between mb-3">
                    <h5 class="font-semibold text-gray-800">
                        <i class="fas fa-${config.icon} text-brand-bright-teal mr-2"></i>${config.label}
                    </h5>
                    <div class="flex items-center gap-3">
                        ${hasAISuggestion ? '<span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded"><i class="fas fa-brain mr-1"></i>AI Suggested</span>' : ''}
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="show_${metric}_in_app" ${showInApp ? 'checked' : ''} class="w-4 h-4 text-brand-bright-teal border-gray-300 rounded focus:ring-brand-bright-teal">
                            <span class="text-sm text-gray-700">
                                <i class="fas fa-mobile-alt mr-1"></i>Show in Patient App
                            </span>
                        </label>
                    </div>
                </div>
                
                ${config.mode === 'range' ? `
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Min Value</label>
                            <input type="number" step="0.1" id="target_${metric}_min" value="${current.min_value || ''}" placeholder="${current.suggested_min || ''}" class="w-full px-3 py-2 border border-gray-300 rounded">
                            ${hasAISuggestion && current.suggested_min ? `<p class="text-xs text-purple-600 mt-1">Suggested: ${current.suggested_min}</p>` : ''}
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Max Value</label>
                            <input type="number" step="0.1" id="target_${metric}_max" value="${current.max_value || ''}" placeholder="${current.suggested_max || ''}" class="w-full px-3 py-2 border border-gray-300 rounded">
                            ${hasAISuggestion && current.suggested_max ? `<p class="text-xs text-purple-600 mt-1">Suggested: ${current.suggested_max}</p>` : ''}
                        </div>
                    </div>
                ` : `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Value</label>
                        <input type="number" step="0.1" id="target_${metric}_value" value="${current.target_value || ''}" placeholder="${current.suggested_value || ''}" class="w-full px-3 py-2 border border-gray-300 rounded">
                        ${hasAISuggestion && current.suggested_value ? `<p class="text-xs text-purple-600 mt-1">Suggested: ${current.suggested_value}</p>` : ''}
                    </div>
                `}
                
                ${hasAISuggestion ? `
                    <button onclick="applyAISuggestion('${metric}')" class="mt-2 text-sm text-purple-600 hover:text-purple-700">
                        <i class="fas fa-check mr-1"></i>Apply AI Suggestion
                    </button>
                ` : ''}
            </div>
        `;
    });
    
    html += `
        </div>
        <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button onclick="closeTargetRangesModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                Cancel
            </button>
            <button onclick="saveTargetRanges()" class="px-6 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition">
                <i class="fas fa-save mr-2"></i>Save Targets
            </button>
        </div>
    `;
    
    document.getElementById('targetRangesContent').innerHTML = html;
}

async function generateAISuggestions() {
    try {
        document.getElementById('targetRangesContent').innerHTML = '<div class="text-center py-8"><i class="fas fa-brain fa-spin text-4xl text-purple-600"></i><p class="text-gray-600 mt-2">AI is generating personalized target ranges...</p></div>';
        
        const response = await fetch('/api/patients/{{ patient.id }}/target-ranges/ai-suggest', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            await loadTargetRanges();
            alert('AI suggestions generated successfully!');
        } else {
            alert('Error: ' + data.error);
            await loadTargetRanges();
        }
    } catch (error) {
        console.error('Error generating AI suggestions:', error);
        alert('Failed to generate AI suggestions');
        await loadTargetRanges();
    }
}

function applyAISuggestion(metric) {
    const current = currentTargetRanges[metric];
    if (!current) return;
    
    if (current.suggested_min) {
        document.getElementById(`target_${metric}_min`).value = current.suggested_min;
    }
    if (current.suggested_max) {
        document.getElementById(`target_${metric}_max`).value = current.suggested_max;
    }
    if (current.suggested_value) {
        document.getElementById(`target_${metric}_value`).value = current.suggested_value;
    }
}

async function saveTargetRanges() {
    try {
        const ranges = {};
        
        Object.entries(METRIC_CONFIG).forEach(([metric, config]) => {
            const showInApp = document.getElementById(`show_${metric}_in_app`)?.checked !== false; // Default to true if checkbox doesn't exist
            
            if (config.mode === 'range') {
                const min = document.getElementById(`target_${metric}_min`)?.value;
                const max = document.getElementById(`target_${metric}_max`)?.value;
                
                if (min || max) {
                    ranges[metric] = {
                        target_mode: 'range',
                        min: min,
                        max: max,
                        unit: config.unit,
                        source: 'manual',
                        show_in_patient_app: showInApp
                    };
                } else if (document.getElementById(`show_${metric}_in_app`)) {
                    // Even if no target values, save the visibility setting
                    ranges[metric] = {
                        show_in_patient_app: showInApp
                    };
                }
            } else {
                const value = document.getElementById(`target_${metric}_value`)?.value;
                
                if (value) {
                    ranges[metric] = {
                        target_mode: 'single',
                        target: value,
                        unit: config.unit,
                        source: 'manual',
                        show_in_patient_app: showInApp
                    };
                } else if (document.getElementById(`show_${metric}_in_app`)) {
                    // Even if no target values, save the visibility setting
                    ranges[metric] = {
                        show_in_patient_app: showInApp
                    };
                }
            }
        });
        
        const response = await fetch('/patients/{{ patient.id }}/target-ranges', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(ranges)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Target ranges saved successfully!');
            closeTargetRangesModal();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error saving target ranges:', error);
        alert('Failed to save target ranges');
    }
}

// ========================================
// Communication Method Selection
// ========================================

let currentCommunicationMethod = 'video'; // Default to video

function selectCommunicationMethod(method) {
    currentCommunicationMethod = method;
    
    const videoBtn = document.getElementById('selectVideoCallBtn');
    const phoneBtn = document.getElementById('selectPhoneCallBtn');
    const videoSection = document.getElementById('videoCallSection');
    const phoneSection = document.getElementById('phoneCallSection');
    
    if (method === 'video') {
        // Update button styles
        videoBtn.classList.remove('bg-gray-200', 'text-gray-700');
        videoBtn.classList.add('bg-indigo-600', 'text-white');
        phoneBtn.classList.remove('bg-green-600', 'text-white');
        phoneBtn.classList.add('bg-gray-200', 'text-gray-700');
        
        // Show/hide sections
        videoSection.classList.remove('hidden');
        phoneSection.classList.add('hidden');
    } else if (method === 'phone') {
        // Update button styles
        phoneBtn.classList.remove('bg-gray-200', 'text-gray-700');
        phoneBtn.classList.add('bg-green-600', 'text-white');
        videoBtn.classList.remove('bg-indigo-600', 'text-white');
        videoBtn.classList.add('bg-gray-200', 'text-gray-700');
        
        // Show/hide sections
        phoneSection.classList.remove('hidden');
        videoSection.classList.add('hidden');
    }
}

// ========================================
// Phone Call Functionality
// ========================================

let activePhoneCallSid = null;
let phoneCallStartTime = null;
let phoneCallTimerInterval = null;

async function initiatePhoneCall() {
    // Check mobile first, then phone
    const patientPhone = '{{ patient.mobile or patient.phone }}';
    
    if (!patientPhone) {
        alert('No phone number on file for this patient');
        return;
    }
    
    try {
        const response = await fetch(`/api/patients/${CURRENT_PATIENT_ID}/initiate-call`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: patientPhone })
        });
        
        const data = await response.json();
        
        if (data.success) {
            activePhoneCallSid = data.call_sid;
            phoneCallStartTime = Date.now();
            
            // Show active call view
            document.getElementById('prePhoneCallView').classList.add('hidden');
            document.getElementById('activePhoneCall').classList.remove('hidden');
            
            // Update status
            document.getElementById('phoneCallStatusText').textContent = data.status || 'Connecting...';
            
            // Start timer
            startPhoneCallTimer();
            
            // Poll for call status updates
            pollPhoneCallStatus();
        } else {
            alert('Failed to initiate call: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error initiating phone call:', error);
        alert('Failed to initiate call. Please try again.');
    }
}

async function endPhoneCall() {
    if (!activePhoneCallSid) {
        return;
    }
    
    try {
        const response = await fetch(`/api/patients/${CURRENT_PATIENT_ID}/end-call`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ call_sid: activePhoneCallSid })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Stop timer
            if (phoneCallTimerInterval) {
                clearInterval(phoneCallTimerInterval);
                phoneCallTimerInterval = null;
            }
            
            // Reset UI
            document.getElementById('activePhoneCall').classList.add('hidden');
            document.getElementById('prePhoneCallView').classList.remove('hidden');
            document.getElementById('phoneCallDuration').textContent = '00:00';
            
            // Reset state
            activePhoneCallSid = null;
            phoneCallStartTime = null;
            
            // Refresh correspondence
            if (typeof loadCorrespondence === 'function') {
                loadCorrespondence();
            }
        } else {
            alert('Failed to end call: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error ending phone call:', error);
        alert('Failed to end call. Please try again.');
    }
}

function startPhoneCallTimer() {
    if (phoneCallTimerInterval) {
        clearInterval(phoneCallTimerInterval);
    }
    
    phoneCallTimerInterval = setInterval(() => {
        if (phoneCallStartTime) {
            const elapsed = Math.floor((Date.now() - phoneCallStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('phoneCallDuration').textContent = timeStr;
        }
    }, 1000);
}

async function pollPhoneCallStatus() {
    if (!activePhoneCallSid) return;
    
    // Poll every 3 seconds to update call status
    const pollInterval = setInterval(async () => {
        if (!activePhoneCallSid) {
            clearInterval(pollInterval);
            return;
        }
        
        try {
            const response = await fetch(`/api/patients/${CURRENT_PATIENT_ID}/call-status/${activePhoneCallSid}`);
            const data = await response.json();
            
            if (data.success && data.status) {
                document.getElementById('phoneCallStatusText').textContent = data.status;
                
                // If call ended, clean up
                if (data.status === 'completed' || data.status === 'failed' || data.status === 'busy' || data.status === 'no-answer') {
                    clearInterval(pollInterval);
                    setTimeout(() => {
                        endPhoneCall();
                    }, 2000);
                }
            }
        } catch (error) {
            console.error('Error polling call status:', error);
        }
    }, 3000);
}

// ========================================
// Twilio Video Call Functionality
// ========================================

let videoRoom = null;
let localVideoTrack = null;
let localAudioTrack = null;
let videoCallStartTime = null;
let videoCallTimerInterval = null;
let currentVideoRoomName = null;
let isVideoMuted = false;
let isVideoCameraOff = false;

async function startVideoCall() {
    try {
        // Get access token from backend
        const response = await fetch(`/api/patients/{{ patient.id }}/video-token`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + data.error);
            return;
        }
        
        currentVideoRoomName = data.room_name;
        // Use the patient_join_url from server if provided, otherwise fallback to window.location.origin
        const videoRoomUrl = data.patient_join_url || (window.location.origin + '/video-room/' + data.room_name);
        document.getElementById('videoRoomUrl').value = videoRoomUrl;
        
        // Warn if using localhost
        if (videoRoomUrl.includes('127.0.0.1') || videoRoomUrl.includes('localhost')) {
            console.warn('‚ö†Ô∏è Patient join URL uses localhost - external patients cannot access this!');
            console.warn('‚ö†Ô∏è Set BASE_URL environment variable to your public URL (e.g., ngrok URL)');
        }
        
        // Connect to video room using Twilio Video SDK
        videoRoom = await Twilio.Video.connect(data.token, {
            name: data.room_name,
            audio: true,
            video: { width: 640 }
        });
        
        console.log('Connected to video room:', videoRoom.name);
        
        // Hide pre-call view, show active call
        document.getElementById('preCallView').classList.add('hidden');
        document.getElementById('activeVideoCall').classList.remove('hidden');
        
        // Start call timer
        videoCallStartTime = Date.now();
        videoCallTimerInterval = setInterval(updateVideoCallDuration, 1000);
        
        // Attach local video
        videoRoom.localParticipant.videoTracks.forEach(publication => {
            const videoElement = publication.track.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            document.getElementById('localParticipantVideo').innerHTML = '';
            document.getElementById('localParticipantVideo').appendChild(videoElement);
        });
        
        // Handle existing participants
        videoRoom.participants.forEach(participantConnected);
        
        // Handle new participants
        videoRoom.on('participantConnected', participantConnected);
        videoRoom.on('participantDisconnected', participantDisconnected);
        
        // Handle disconnect
        videoRoom.on('disconnected', () => {
            console.log('Disconnected from video room');
        });
        
    } catch (error) {
        console.error('Error starting video call:', error);
        alert('Failed to start video call: ' + error.message);
    }
}

function participantConnected(participant) {
    console.log('Participant connected:', participant.identity);
    
    // Update participant count
    const count = videoRoom.participants.size + 1; // +1 for local participant
    document.getElementById('participantCount').textContent = count;
    
    // Subscribe to tracks
    participant.tracks.forEach(publication => {
        if (publication.track) {
            attachTrack(publication.track);
        }
    });
    
    participant.on('trackSubscribed', attachTrack);
}

function participantDisconnected(participant) {
    console.log('Participant disconnected:', participant.identity);
    
    // Update participant count
    const count = videoRoom.participants.size + 1;
    document.getElementById('participantCount').textContent = count;
    
    // If no remote participants, show waiting message
    if (videoRoom.participants.size === 0) {
        document.getElementById('remoteParticipantVideo').innerHTML = `
            <div class="text-center text-white">
                <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
                <p class="text-lg">Waiting for patient to join...</p>
            </div>
        `;
    }
}

function attachTrack(track) {
    if (track.kind === 'video') {
        const videoElement = track.attach();
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        videoElement.style.objectFit = 'cover';
        document.getElementById('remoteParticipantVideo').innerHTML = '';
        document.getElementById('remoteParticipantVideo').appendChild(videoElement);
    } else if (track.kind === 'audio') {
        const audioElement = track.attach();
        document.body.appendChild(audioElement);
    }
}

function updateVideoCallDuration() {
    if (!videoCallStartTime) return;
    
    const elapsed = Math.floor((Date.now() - videoCallStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const seconds = (elapsed % 60).toString().padStart(2, '0');
    document.getElementById('videoCallDuration').textContent = `${minutes}:${seconds}`;
}

function toggleVideoMute() {
    if (!videoRoom) return;
    
    isVideoMuted = !isVideoMuted;
    const btn = document.getElementById('videoMuteBtn');
    
    videoRoom.localParticipant.audioTracks.forEach(publication => {
        if (isVideoMuted) {
            publication.track.disable();
            btn.classList.add('bg-red-600', 'hover:bg-red-700');
            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.remove('fa-microphone');
            btn.querySelector('i').classList.add('fa-microphone-slash');
        } else {
            publication.track.enable();
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.add('fa-microphone');
            btn.querySelector('i').classList.remove('fa-microphone-slash');
        }
    });
}

function toggleVideoCamera() {
    if (!videoRoom) return;
    
    isVideoCameraOff = !isVideoCameraOff;
    const btn = document.getElementById('videoToggleBtn');
    
    videoRoom.localParticipant.videoTracks.forEach(publication => {
        if (isVideoCameraOff) {
            publication.track.disable();
            btn.classList.add('bg-red-600', 'hover:bg-red-700');
            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.remove('fa-video');
            btn.querySelector('i').classList.add('fa-video-slash');
        } else {
            publication.track.enable();
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.add('fa-video');
            btn.querySelector('i').classList.remove('fa-video-slash');
        }
    });
}

async function endVideoCall() {
    if (!videoRoom) {
        console.log('No active video room to disconnect');
        return;
    }
    
    const duration = videoCallStartTime ? Math.floor((Date.now() - videoCallStartTime) / 1000) : 0;
    
    // Disconnect from room
    videoRoom.disconnect();
    videoRoom = null;
    
    // Stop timer
    if (videoCallTimerInterval) {
        clearInterval(videoCallTimerInterval);
        videoCallTimerInterval = null;
    }
    
    // Log the video call only if we have a valid room name and duration
    if (currentVideoRoomName && duration > 0) {
        try {
            const response = await fetch(`/api/patients/{{ patient.id }}/log-video-call`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    room_name: currentVideoRoomName,
                    duration: duration
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                console.error('Failed to log video call:', data.error);
            } else {
                console.log('‚úÖ Video call logged successfully');
            }
        } catch (error) {
            console.error('Error logging video call:', error);
        }
    } else {
        console.log('Skipping video call log - no room name or zero duration');
    }
    
    // Reset UI
    document.getElementById('preCallView').classList.remove('hidden');
    document.getElementById('activeVideoCall').classList.add('hidden');
    document.getElementById('videoCallDuration').textContent = '00:00';
    document.getElementById('participantCount').textContent = '1';
    document.getElementById('remoteParticipantVideo').innerHTML = `
        <div class="text-center text-white">
            <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
            <p class="text-lg">Waiting for patient to join...</p>
        </div>
    `;
    document.getElementById('localParticipantVideo').innerHTML = '<i class="fas fa-user text-white text-4xl opacity-50"></i>';
    
    // Reset room name
    currentVideoRoomName = null;
    videoCallStartTime = null;
    
    // Reload correspondence to show the logged video call
    loadCorrespondence();
}

async function sendVideoInvite() {
    if (!currentVideoRoomName) {
        // Create room first if not started
        try {
            const response = await fetch(`/api/patients/{{ patient.id }}/video-token`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            const data = await response.json();
            
            if (!data.success) {
                alert('Error: ' + data.error);
                return;
            }
            
            currentVideoRoomName = data.room_name;
        } catch (error) {
            console.error('Error creating video room:', error);
            alert('Failed to create video room');
            return;
        }
    }
    
    // Use base_url from server if available, otherwise use window.location.origin
    const baseUrl = window.baseUrl || window.location.origin;
    const videoRoomUrl = baseUrl + '/video-room/' + currentVideoRoomName;
    const patientPhone = '{{ patient.mobile or patient.phone }}';
    
    if (!patientPhone) {
        alert('Patient phone number not found. Please update patient details.');
        return;
    }
    
    const message = `Hi {{ patient.first_name }}, your healthcare provider has started a video consultation. Click this link to join: ${videoRoomUrl}`;
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/send-sms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone: patientPhone,
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Video invite sent to patient via SMS!');
        } else {
            alert('‚ùå Error sending invite: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending video invite:', error);
        alert('Failed to send video invite');
    }
}

function copyVideoUrl() {
    const input = document.getElementById('videoRoomUrl');
    input.select();
    document.execCommand('copy');
    alert('‚úÖ Video room URL copied to clipboard!');
}

// Video Call Modal Functions
let modalVideoRoom = null;
let modalVideoCallStartTime = null;
let modalVideoCallTimerInterval = null;
let modalCurrentVideoRoomName = null;
let isModalVideoMuted = false;
let isModalVideoCameraOff = false;

function openVideoCallModal() {
    document.getElementById('videoCallModal').classList.remove('hidden');
    document.getElementById('videoCallSetupView').classList.remove('hidden');
    document.getElementById('activeVideoCallView').classList.add('hidden');
}

function closeVideoCallModal() {
    // End any active call first
    if (modalVideoRoom) {
        endVideoCallFromModal();
    }
    document.getElementById('videoCallModal').classList.add('hidden');
}

async function startVideoCallFromModal() {
    try {
        // Get video token
        const response = await fetch(`/api/patients/{{ patient.id }}/video-token`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert('Error: ' + data.error);
            return;
        }
        
        modalCurrentVideoRoomName = data.room_name;
        // Use base_url from server if available, otherwise use window.location.origin
        const baseUrl = window.baseUrl || window.location.origin;
        const videoRoomUrl = baseUrl + '/video-room/' + modalCurrentVideoRoomName;
        document.getElementById('videoModalRoomUrl').value = videoRoomUrl;
        
        // Connect to Twilio Video
        modalVideoRoom = await Twilio.Video.connect(data.token, {
            name: data.room_name,
            audio: true,
            video: { width: 640, height: 480 }
        });
        
        // Switch to active call view
        document.getElementById('videoCallSetupView').classList.add('hidden');
        document.getElementById('activeVideoCallView').classList.remove('hidden');
        
        // Attach local video
        modalVideoRoom.localParticipant.videoTracks.forEach(publication => {
            const videoElement = publication.track.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            document.getElementById('videoModalLocalParticipant').innerHTML = '';
            document.getElementById('videoModalLocalParticipant').appendChild(videoElement);
        });
        
        // Handle participant connections
        modalVideoRoom.on('participantConnected', participant => {
            console.log('Participant connected:', participant.identity);
            updateModalParticipantCount();
            
            participant.tracks.forEach(publication => {
                if (publication.isSubscribed) {
                    attachModalParticipantTrack(publication.track);
                }
            });
            
            participant.on('trackSubscribed', track => {
                attachModalParticipantTrack(track);
            });
        });
        
        // Handle already-connected participants
        modalVideoRoom.participants.forEach(participant => {
            participant.tracks.forEach(publication => {
                if (publication.isSubscribed) {
                    attachModalParticipantTrack(publication.track);
                }
            });
        });
        
        // Handle participant disconnections
        modalVideoRoom.on('participantDisconnected', participant => {
            console.log('Participant disconnected:', participant.identity);
            updateModalParticipantCount();
            document.getElementById('videoModalRemoteParticipant').innerHTML = `
                <div class="text-center text-white">
                    <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
                    <p class="text-lg">Waiting for patient to join...</p>
                </div>
            `;
        });
        
        // Start timer
        modalVideoCallStartTime = Date.now();
        modalVideoCallTimerInterval = setInterval(updateModalVideoCallTimer, 1000);
        updateModalParticipantCount();
        
    } catch (error) {
        console.error('Error starting video call:', error);
        alert('Failed to start video call: ' + error.message);
        closeVideoCallModal();
    }
}

function attachModalParticipantTrack(track) {
    if (track.kind === 'video') {
        const videoElement = track.attach();
        videoElement.style.width = '100%';
        videoElement.style.height = '100%';
        videoElement.style.objectFit = 'cover';
        document.getElementById('videoModalRemoteParticipant').innerHTML = '';
        document.getElementById('videoModalRemoteParticipant').appendChild(videoElement);
    }
}

function updateModalVideoCallTimer() {
    if (modalVideoCallStartTime) {
        const elapsed = Math.floor((Date.now() - modalVideoCallStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('videoModalCallDuration').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
}

function updateModalParticipantCount() {
    if (modalVideoRoom) {
        const count = modalVideoRoom.participants.size + 1; // +1 for local participant
        document.getElementById('videoModalParticipantCount').textContent = count;
    }
}

function toggleVideoMute() {
    if (!modalVideoRoom) return;
    
    isModalVideoMuted = !isModalVideoMuted;
    const btn = document.getElementById('videoModalMuteBtn');
    
    modalVideoRoom.localParticipant.audioTracks.forEach(publication => {
        if (isModalVideoMuted) {
            publication.track.disable();
            btn.classList.add('bg-red-600', 'hover:bg-red-700');
            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.remove('fa-microphone');
            btn.querySelector('i').classList.add('fa-microphone-slash');
        } else {
            publication.track.enable();
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.add('fa-microphone');
            btn.querySelector('i').classList.remove('fa-microphone-slash');
        }
    });
}

function toggleVideoModalCamera() {
    if (!modalVideoRoom) return;
    
    isModalVideoCameraOff = !isModalVideoCameraOff;
    const btn = document.getElementById('videoModalVideoToggleBtn');
    
    modalVideoRoom.localParticipant.videoTracks.forEach(publication => {
        if (isModalVideoCameraOff) {
            publication.track.disable();
            btn.classList.add('bg-red-600', 'hover:bg-red-700');
            btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.remove('fa-video');
            btn.querySelector('i').classList.add('fa-video-slash');
        } else {
            publication.track.enable();
            btn.classList.remove('bg-red-600', 'hover:bg-red-700');
            btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            btn.querySelector('i').classList.add('fa-video');
            btn.querySelector('i').classList.remove('fa-video-slash');
        }
    });
}

async function endVideoCallFromModal() {
    if (!modalVideoRoom) {
        console.log('No active video room to disconnect');
        closeVideoCallModal();
        return;
    }
    
    const duration = modalVideoCallStartTime ? Math.floor((Date.now() - modalVideoCallStartTime) / 1000) : 0;
    
    // Disconnect from room
    modalVideoRoom.disconnect();
    modalVideoRoom = null;
    
    // Stop timer
    if (modalVideoCallTimerInterval) {
        clearInterval(modalVideoCallTimerInterval);
        modalVideoCallTimerInterval = null;
    }
    
    // Log the video call only if we have a valid room name and duration
    if (modalCurrentVideoRoomName && duration > 0) {
        try {
            const response = await fetch(`/api/patients/{{ patient.id }}/log-video-call`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    room_name: modalCurrentVideoRoomName,
                    duration: duration
                })
            });
            
            const data = await response.json();
            if (!data.success) {
                console.error('Failed to log video call:', data.error);
            } else {
                console.log('‚úÖ Video call logged successfully');
            }
        } catch (error) {
            console.error('Error logging video call:', error);
        }
    }
    
    // Reset state
    modalCurrentVideoRoomName = null;
    modalVideoCallStartTime = null;
    isModalVideoMuted = false;
    isModalVideoCameraOff = false;
    
    // Close modal and minimized widget
    document.getElementById('videoCallModal').classList.add('hidden');
    document.getElementById('minimizedVideoWidget').classList.add('hidden');
    document.getElementById('videoCallSetupView').classList.remove('hidden');
    document.getElementById('activeVideoCallView').classList.add('hidden');
    
    // Reload correspondence
    loadCorrespondence();
}

async function sendVideoInviteFromModal() {
    if (!modalCurrentVideoRoomName) {
        alert('Please start the video call first before sending an invite.');
        return;
    }
    
    // Use base_url from server if available, otherwise use window.location.origin
    const baseUrl = window.baseUrl || window.location.origin;
    const videoRoomUrl = baseUrl + '/video-room/' + modalCurrentVideoRoomName;
    const patientPhone = '{{ patient.mobile or patient.phone }}';
    
    if (!patientPhone) {
        alert('Patient phone number not found. Please update patient details.');
        return;
    }
    
    const message = `Hi {{ patient.first_name }}, your healthcare provider has started a video consultation. Click this link to join: ${videoRoomUrl}`;
    
    try {
        const response = await fetch(`/api/patients/{{ patient.id }}/send-sms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone: patientPhone,
                message: message
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Video invite sent to patient via SMS!');
        } else {
            alert('‚ùå Error sending invite: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending video invite:', error);
        alert('Failed to send video invite');
    }
}

function minimizeVideoCallModal() {
    // Hide the modal
    document.getElementById('videoCallModal').classList.add('hidden');
    
    // Show the minimized widget
    document.getElementById('minimizedVideoWidget').classList.remove('hidden');
    
    // Attach local video to minimized preview (small version)
    if (modalVideoRoom) {
        modalVideoRoom.localParticipant.videoTracks.forEach(publication => {
            const videoElement = publication.track.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            document.getElementById('minimizedVideoPreview').innerHTML = '';
            document.getElementById('minimizedVideoPreview').appendChild(videoElement);
        });
    }
    
    // Update minimized timer
    setInterval(() => {
        if (modalVideoCallStartTime) {
            const elapsed = Math.floor((Date.now() - modalVideoCallStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('minimizedVideoDuration').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }, 1000);
    
    // Sync minimized control buttons with current state
    syncMinimizedButtons();
}

function maximizeVideoCallModal() {
    // Hide the minimized widget
    document.getElementById('minimizedVideoWidget').classList.add('hidden');
    
    // Show the modal
    document.getElementById('videoCallModal').classList.remove('hidden');
    
    // Re-attach local video to main modal view
    if (modalVideoRoom) {
        modalVideoRoom.localParticipant.videoTracks.forEach(publication => {
            const videoElement = publication.track.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            document.getElementById('videoModalLocalParticipant').innerHTML = '';
            document.getElementById('videoModalLocalParticipant').appendChild(videoElement);
        });
    }
}

function syncMinimizedButtons() {
    // Update minimized mute button
    const minimizedMuteBtn = document.getElementById('minimizedMuteBtn');
    if (isModalVideoMuted) {
        minimizedMuteBtn.querySelector('i').classList.remove('fa-microphone');
        minimizedMuteBtn.querySelector('i').classList.add('fa-microphone-slash');
    } else {
        minimizedMuteBtn.querySelector('i').classList.add('fa-microphone');
        minimizedMuteBtn.querySelector('i').classList.remove('fa-microphone-slash');
    }
    
    // Update minimized video button
    const minimizedVideoBtn = document.getElementById('minimizedVideoBtn');
    if (isModalVideoCameraOff) {
        minimizedVideoBtn.querySelector('i').classList.remove('fa-video');
        minimizedVideoBtn.querySelector('i').classList.add('fa-video-slash');
    } else {
        minimizedVideoBtn.querySelector('i').classList.add('fa-video');
        minimizedVideoBtn.querySelector('i').classList.remove('fa-video-slash');
    }
}

function copyVideoModalRoomUrl() {
    const input = document.getElementById('videoModalRoomUrl');
    input.select();
    document.execCommand('copy');
    alert('‚úÖ Video room URL copied to clipboard!');
}
</script>

<!-- Twilio Video SDK -->
<script src="https://sdk.twilio.com/js/video/releases/2.28.1/twilio-video.min.js"></script>

<!-- Sync Progress Modal -->
<div id="syncProgressModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-sync fa-spin mr-3 text-brand-bright-teal"></i>
                    Syncing Health Data
                </h2>
                <button onclick="closeSyncModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <div id="syncStatus" class="space-y-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-spinner fa-spin text-brand-bright-teal mt-1"></i>
                    <div>
                        <p class="font-semibold text-gray-800">Initializing sync...</p>
                        <p class="text-sm text-gray-600">Preparing to fetch health data</p>
                    </div>
                </div>
            </div>
            
            <div id="syncProgressBar" class="mt-6 bg-gray-200 rounded-full h-2 overflow-hidden">
                <div id="syncProgressFill" class="bg-brand-bright-teal h-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <div id="syncSummary" class="mt-6 hidden">
                <div class="bg-gray-50 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">Sync Summary:</h3>
                    <div id="syncSummaryContent" class="text-sm text-gray-600 space-y-1"></div>
                </div>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200 flex justify-end">
            <button id="syncCloseBtn" onclick="closeSyncModal()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold hidden">
                Close
            </button>
        </div>
    </div>
</div>

<script>
let syncInProgress = false;

function addSyncStatus(message, detail = '', type = 'info') {
    const statusDiv = document.getElementById('syncStatus');
    const icon = type === 'success' ? 'fa-check-circle text-green-500' : 
                 type === 'error' ? 'fa-times-circle text-red-500' : 
                 'fa-spinner fa-spin text-brand-bright-teal';
    
    const statusItem = document.createElement('div');
    statusItem.className = 'flex items-start space-x-3 animate-fade-in';
    statusItem.innerHTML = `
        <i class="fas ${icon} mt-1"></i>
        <div>
            <p class="font-semibold text-gray-800">${message}</p>
            ${detail ? `<p class="text-sm text-gray-600">${detail}</p>` : ''}
        </div>
    `;
    statusDiv.appendChild(statusItem);
    
    // Auto-scroll to bottom
    statusDiv.scrollTop = statusDiv.scrollHeight;
}

function updateSyncProgress(percent) {
    document.getElementById('syncProgressFill').style.width = percent + '%';
}

function showSyncSummary(summary) {
    const summaryDiv = document.getElementById('syncSummary');
    const summaryContent = document.getElementById('syncSummaryContent');
    summaryDiv.classList.remove('hidden');
    summaryContent.innerHTML = summary;
}

function openSyncModal() {
    document.getElementById('syncProgressModal').classList.remove('hidden');
    document.getElementById('syncStatus').innerHTML = '';
    document.getElementById('syncProgressFill').style.width = '0%';
    document.getElementById('syncSummary').classList.add('hidden');
    document.getElementById('syncCloseBtn').classList.add('hidden');
}

function closeSyncModal() {
    if (!syncInProgress) {
        document.getElementById('syncProgressModal').classList.add('hidden');
        // Reload page to show new data
        setTimeout(() => location.reload(), 500);
    }
}

async function startSync(fullSync = false) {
    if (syncInProgress) {
        alert('Sync already in progress. Please wait...');
        return;
    }
    
    syncInProgress = true;
    openSyncModal();
    
    try {
        // Get sync info first
        addSyncStatus('Checking last sync date...', 'Determining what data to fetch');
        updateSyncProgress(5);
        
        const response = await fetch(`/patients/{{ patient.id }}/sync-info`);
        const syncInfo = await response.json();
        
        if (syncInfo.last_record) {
            const lastDate = new Date(syncInfo.last_record.timestamp);
            const startDate = new Date(lastDate);
            startDate.setDate(startDate.getDate() - 1); // 1 day before
            
            addSyncStatus('Sync range determined', 
                `Fetching data from ${startDate.toLocaleDateString()} (1 day before last record on ${lastDate.toLocaleDateString()})`);
        } else {
            addSyncStatus('Initial sync detected', 'Fetching all available data (up to 1 year)');
        }
        
        updateSyncProgress(10);
        
        // Start sync
        addSyncStatus('Connecting to Withings API...', 'Authenticating and establishing connection');
        updateSyncProgress(15);
        
        const formData = new FormData();
        formData.append('send_email', 'false');
        if (fullSync) {
            formData.append('full_sync', 'true');
        }
        
        const syncResponse = await fetch(`/patients/{{ patient.id }}/sync`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: formData
        });
        
        updateSyncProgress(30);
        addSyncStatus('Fetching body measurements...', 'Retrieving weight, blood pressure, heart rate, and other metrics');
        
        // Simulate progress (since sync is synchronous, we'll update after completion)
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateSyncProgress(50);
        addSyncStatus('Fetching activity data...', 'Retrieving steps, calories, and exercise data');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateSyncProgress(70);
        addSyncStatus('Fetching sleep data...', 'Retrieving sleep duration and quality metrics');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        updateSyncProgress(85);
        addSyncStatus('Fetching device data...', 'Updating device information');
        
        await new Promise(resolve => setTimeout(resolve, 500));
        updateSyncProgress(90);
        addSyncStatus('Saving data to database...', 'Storing all retrieved health records');
        
        // Wait for response - check if it's JSON first
        let syncResult;
        const contentType = syncResponse.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            syncResult = await syncResponse.json();
        } else {
            // Response is not JSON (likely HTML error page)
            const text = await syncResponse.text();
            console.error('Non-JSON response:', text.substring(0, 500));
            throw new Error('Server returned an error. Please check the console for details.');
        }
        
        if (syncResult.success) {
            updateSyncProgress(100);
            addSyncStatus('Sync completed successfully!', 'All data has been retrieved and saved', 'success');
            
            // Show summary with actual results
            showSyncSummary(`
                <p>‚úÖ <strong>Sync completed successfully!</strong></p>
                <p class="mt-2">üìä <strong>${syncResult.measurements || 0}</strong> measurements added</p>
                <p>üèÉ <strong>${syncResult.activities || 0}</strong> activity records added</p>
                <p>üò¥ <strong>${syncResult.sleep || 0}</strong> sleep records added</p>
                <p class="mt-2 font-semibold">Total: <strong>${syncResult.total || 0}</strong> new records</p>
                <p class="mt-2 text-xs text-gray-500">The page will refresh to show the new data.</p>
            `);
            document.getElementById('syncCloseBtn').classList.remove('hidden');
            syncInProgress = false;
        } else {
            throw new Error(syncResult.error || 'Sync failed');
        }
        
    } catch (error) {
        console.error('Sync error:', error);
        addSyncStatus('Sync failed', error.message || 'An error occurred during sync', 'error');
        document.getElementById('syncCloseBtn').classList.remove('hidden');
        syncInProgress = false;
    }
}
</script>

{% endblock %}
