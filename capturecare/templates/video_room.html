<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Video Consultation - CaptureCare</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            teal: '#265063',
                            'bright-teal': '#00698f'
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    {% if not credentials_missing %}
    <script src="https://sdk.twilio.com/js/video/releases/2.28.1/twilio-video.min.js"></script>
    {% endif %}
    
    <style>
        /* Prevent zoom on mobile */
        html {
            touch-action: manipulation;
        }
        
        /* Full screen video container */
        #videoContainer {
            height: calc(100vh - 180px);
            min-height: 400px;
        }
        
        @media (max-width: 640px) {
            #videoContainer {
                height: calc(100vh - 140px);
            }
        }
        
        /* Smooth transitions */
        * {
            -webkit-tap-highlight-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 overflow-hidden">
    <div class="min-h-screen flex flex-col">
        <!-- Compact Header -->
        <div class="bg-gradient-to-r from-brand-teal to-brand-bright-teal shadow-lg">
            <div class="px-3 sm:px-6 py-2 sm:py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-video text-white text-lg sm:text-xl"></i>
                        <h1 class="text-sm sm:text-lg font-bold text-white">CaptureCareÂ® Video Call</h1>
                    </div>
                    <div class="text-xs text-white flex items-center gap-1">
                        <i class="fas fa-shield-alt"></i>
                        <span class="hidden sm:inline">Secure</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 container mx-auto px-4 py-8 flex items-center justify-center">
            {% if credentials_missing %}
            <!-- Waiting Screen (No Credentials or Room Not Ready) - Mobile Optimized -->
            <div class="w-full max-w-2xl mx-auto px-4">
                <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl p-6 sm:p-8 md:p-10 text-center">
                    <!-- Animated Icon -->
                    <div class="mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full mb-4 sm:mb-6 animate-pulse">
                            <i class="fas fa-video text-indigo-600 text-3xl sm:text-4xl"></i>
                        </div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-3 px-2">Waiting for Your Appointment</h2>
                        <p class="text-base sm:text-lg text-gray-600 mb-6 sm:mb-8 px-2">Your provider will start the call shortly</p>
                    </div>

                    <!-- Status Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg sm:rounded-xl p-4 sm:p-6 mb-6 sm:mb-8 text-left">
                        <div class="flex items-start gap-3 sm:gap-4">
                            <i class="fas fa-info-circle text-blue-600 text-lg sm:text-xl mt-1"></i>
                            <div class="flex-1">
                                <h3 class="font-semibold text-blue-900 mb-2 text-sm sm:text-base">What to do next:</h3>
                                <ul class="space-y-2 text-xs sm:text-sm text-blue-800">
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Keep this page open - it will update automatically</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Your provider will send you a notification when ready</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Make sure your camera and microphone are working</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Requirements -->
                    <div class="grid sm:grid-cols-2 gap-3 sm:gap-4 mb-6 sm:mb-8">
                        <div class="bg-gray-50 rounded-lg p-3 sm:p-4 text-left">
                            <div class="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2">
                                <i class="fas fa-camera text-gray-600 text-sm sm:text-base"></i>
                                <h4 class="font-semibold text-gray-800 text-sm sm:text-base">Camera Access</h4>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-600">Allow camera access when prompted</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-3 sm:p-4 text-left">
                            <div class="flex items-center gap-2 sm:gap-3 mb-1 sm:mb-2">
                                <i class="fas fa-microphone text-gray-600 text-sm sm:text-base"></i>
                                <h4 class="font-semibold text-gray-800 text-sm sm:text-base">Microphone Access</h4>
                            </div>
                            <p class="text-xs sm:text-sm text-gray-600">Allow microphone for audio</p>
                        </div>
                    </div>

                    <!-- Auto-refresh Message -->
                    <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
                        <i class="fas fa-sync-alt animate-spin"></i>
                        <span>Checking for your appointment... This page will refresh automatically</span>
                    </div>
                </div>
            </div>

            <script>
                // Auto-refresh every 10 seconds to check if room is ready
                setTimeout(() => {
                    window.location.reload();
                }, 10000);
            </script>

            {% else %}
            <!-- Pre-Join View (Room is Ready) - Mobile Optimized -->
            <div id="preJoinView" class="w-full max-w-2xl mx-auto px-4">
                <div class="bg-white rounded-xl sm:rounded-2xl shadow-2xl p-6 sm:p-8 md:p-10 text-center">
                    <div class="mb-6 sm:mb-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full mb-3 sm:mb-4">
                            <i class="fas fa-video text-green-600 text-2xl sm:text-3xl"></i>
                        </div>
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2 sm:mb-3">Your Call is Ready!</h2>
                        <p class="text-base sm:text-lg text-gray-600 px-2">Join your secure video consultation</p>
                    </div>

                    <!-- Camera Preview -->
                    <div class="bg-gray-900 rounded-lg sm:rounded-xl overflow-hidden mb-6 sm:mb-8 shadow-2xl" style="height: 240px; max-height: 40vh;">
                        <div id="localPreview" class="w-full h-full flex items-center justify-center">
                            <div class="text-center text-white px-4">
                                <i class="fas fa-user-circle text-5xl sm:text-6xl mb-2 sm:mb-3 opacity-50"></i>
                                <p class="text-sm sm:text-base">Camera preview</p>
                                <p class="text-xs sm:text-sm opacity-75 mt-1 sm:mt-2">Tap below to join</p>
                            </div>
                        </div>
                    </div>

                    <!-- Join Button (Large & Touch-Friendly) -->
                    <button onclick="joinRoom()" 
                        class="w-full sm:w-auto px-8 sm:px-12 py-4 sm:py-5 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:from-green-700 hover:to-emerald-700 transition font-bold text-base sm:text-lg shadow-xl mb-6 transform hover:scale-105 active:scale-95">
                        <i class="fas fa-video mr-2"></i>Join Video Call
                    </button>

                    <!-- Privacy Notice -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 sm:p-4 text-left">
                        <div class="flex items-start gap-2 sm:gap-3">
                            <i class="fas fa-shield-alt text-green-600 mt-1 text-sm sm:text-base"></i>
                            <div class="text-xs sm:text-sm text-green-800">
                                <p class="font-semibold mb-1">Secure & Private</p>
                                <p class="leading-relaxed">Your call is encrypted. Please allow camera and microphone access when prompted.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Call View - Full Screen -->
            <div id="activeCallView" class="hidden w-full h-full fixed inset-0 flex flex-col">
                <!-- Main Video Container (Full Screen) -->
                <div id="videoContainer" class="flex-1 relative bg-black">
                    <!-- Practitioner Video (LARGE - Full Screen) -->
                    <div id="remoteVideoContainer" class="absolute inset-0">
                        <div id="remoteParticipantVideo" class="w-full h-full flex items-center justify-center">
                            <div class="text-center text-white px-4">
                                <i class="fas fa-user-circle text-6xl sm:text-7xl mb-3 sm:mb-4 opacity-50 animate-pulse"></i>
                                <p class="text-lg sm:text-xl font-semibold mb-1 sm:mb-2">Waiting for your healthcare provider...</p>
                                <p class="text-xs sm:text-sm opacity-75">They will join shortly</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient's Own Video (SMALL - Picture-in-Picture) -->
                    <div id="localVideoContainer" class="absolute bottom-20 sm:bottom-4 right-2 sm:right-4 w-24 h-32 sm:w-32 sm:h-44 md:w-40 md:h-52 bg-gray-800 rounded-lg sm:rounded-xl overflow-hidden border-2 border-white shadow-2xl z-10">
                        <div id="localParticipantVideo" class="w-full h-full flex items-center justify-center bg-gray-900">
                            <i class="fas fa-user text-white text-2xl sm:text-3xl opacity-50"></i>
                        </div>
                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs py-1 px-2 text-center">
                            You
                        </div>
                    </div>
                    
                    <!-- Call Status Overlay (Top) -->
                    <div class="absolute top-2 sm:top-4 left-2 sm:left-4 right-2 sm:right-4 flex items-center justify-between z-10">
                        <!-- Call Duration -->
                        <div class="bg-black bg-opacity-70 rounded-lg px-3 py-2 sm:px-4 sm:py-2">
                            <div class="flex items-center gap-2 text-white">
                                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span id="callDuration" class="text-sm sm:text-base font-bold tabular-nums">00:00</span>
                            </div>
                        </div>
                        
                        <!-- Participant Count -->
                        <div class="bg-black bg-opacity-70 rounded-lg px-3 py-2 sm:px-4 sm:py-2">
                            <div class="flex items-center gap-2 text-white">
                                <i class="fas fa-users text-xs sm:text-sm"></i>
                                <span id="participantCount" class="text-sm sm:text-base font-bold">1</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Control Bar (Mobile Optimized) -->
                <div class="bg-gradient-to-t from-black to-transparent absolute bottom-0 left-0 right-0 pb-safe">
                    <div class="px-3 sm:px-6 py-3 sm:py-4">
                        <div class="flex items-center justify-center gap-2 sm:gap-4">
                            <!-- Mute Button -->
                            <button id="muteBtn" onclick="toggleMute()" 
                                class="w-12 h-12 sm:w-14 sm:h-14 bg-gray-700 hover:bg-gray-600 rounded-full transition flex items-center justify-center text-white shadow-lg active:scale-95">
                                <i class="fas fa-microphone text-lg sm:text-xl"></i>
                            </button>
                            
                            <!-- Leave Call Button (Prominent) -->
                            <button onclick="leaveRoom()" 
                                class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-full transition flex items-center justify-center text-white font-bold shadow-xl active:scale-95 transform scale-110">
                                <i class="fas fa-phone-slash text-xl sm:text-2xl"></i>
                            </button>
                            
                            <!-- Video Toggle Button -->
                            <button id="videoToggleBtn" onclick="toggleVideo()" 
                                class="w-12 h-12 sm:w-14 sm:h-14 bg-gray-700 hover:bg-gray-600 rounded-full transition flex items-center justify-center text-white shadow-lg active:scale-95">
                                <i class="fas fa-video text-lg sm:text-xl"></i>
                            </button>
                        </div>
                        
                        <!-- Optional Labels (Desktop Only) -->
                        <div class="hidden md:flex items-center justify-center gap-8 mt-3 text-white text-xs opacity-75">
                            <span>Mute/Unmute</span>
                            <span class="text-red-400 font-semibold">Leave Call</span>
                            <span>Camera On/Off</span>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                const ROOM_NAME = "{{ room_name }}";
                const ACCESS_TOKEN = "{{ access_token }}";
                
                let room = null;
                let localAudioTrack = null;
                let localVideoTrack = null;
                let callStartTime = null;
                let callTimerInterval = null;
                let isMuted = false;
                let isVideoOff = false;

                async function joinRoom() {
                    try {
                        // Create local tracks
                        const tracks = await Twilio.Video.createLocalTracks({
                            audio: true,
                            video: { width: 640 }
                        });
                        
                        localAudioTrack = tracks.find(track => track.kind === 'audio');
                        localVideoTrack = tracks.find(track => track.kind === 'video');
                        
                        // Connect to room
                        room = await Twilio.Video.connect(ACCESS_TOKEN, {
                            name: ROOM_NAME,
                            tracks: tracks
                        });
                        
                        console.log('âœ… Connected to room:', room.name);
                        
                        // Show active call view
                        document.getElementById('preJoinView').classList.add('hidden');
                        document.getElementById('activeCallView').classList.remove('hidden');
                        
                        // Start call timer
                        callStartTime = Date.now();
                        callTimerInterval = setInterval(updateCallDuration, 1000);
                        
                        // Attach local video
                        if (localVideoTrack) {
                            const videoElement = localVideoTrack.attach();
                            videoElement.style.width = '100%';
                            videoElement.style.height = '100%';
                            videoElement.style.objectFit = 'cover';
                            document.getElementById('localParticipantVideo').innerHTML = '';
                            document.getElementById('localParticipantVideo').appendChild(videoElement);
                        }
                        
                        // Handle existing participants
                        room.participants.forEach(participantConnected);
                        
                        // Handle new participants
                        room.on('participantConnected', participantConnected);
                        room.on('participantDisconnected', participantDisconnected);
                        
                    } catch (error) {
                        console.error('âŒ Error joining room:', error);
                        alert('Unable to join video call. Please check your camera and microphone permissions and try again.\n\nError: ' + error.message);
                    }
                }

                function participantConnected(participant) {
                    console.log('ðŸ‘¤ Participant connected:', participant.identity);
                    
                    // Update participant count
                    const count = room.participants.size + 1;
                    document.getElementById('participantCount').textContent = count;
                    
                    // Subscribe to tracks
                    participant.tracks.forEach(publication => {
                        if (publication.track) {
                            attachTrack(publication.track);
                        }
                    });
                    
                    participant.on('trackSubscribed', attachTrack);
                }

                function participantDisconnected(participant) {
                    console.log('ðŸ‘¤ Participant disconnected:', participant.identity);
                    
                    // Update participant count
                    const count = room.participants.size + 1;
                    document.getElementById('participantCount').textContent = count;
                    
                    // If no remote participants, show waiting message
                    if (room.participants.size === 0) {
                        document.getElementById('remoteParticipantVideo').innerHTML = `
                            <div class="text-center text-white">
                                <i class="fas fa-user-circle text-7xl mb-4 opacity-50 animate-pulse"></i>
                                <p class="text-xl font-semibold mb-2">Waiting for your healthcare provider...</p>
                                <p class="text-sm opacity-75">They will join shortly</p>
                            </div>
                        `;
                    }
                }

                function attachTrack(track) {
                    if (track.kind === 'video') {
                        const videoElement = track.attach();
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                        document.getElementById('remoteParticipantVideo').innerHTML = '';
                        document.getElementById('remoteParticipantVideo').appendChild(videoElement);
                    } else if (track.kind === 'audio') {
                        const audioElement = track.attach();
                        document.body.appendChild(audioElement);
                    }
                }

                function updateCallDuration() {
                    if (!callStartTime) return;
                    
                    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
                }

                function toggleMute() {
                    if (!localAudioTrack) return;
                    
                    isMuted = !isMuted;
                    const btn = document.getElementById('muteBtn');
                    
                    if (isMuted) {
                        localAudioTrack.disable();
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                        btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.remove('fa-microphone');
                        btn.querySelector('i').classList.add('fa-microphone-slash');
                    } else {
                        localAudioTrack.enable();
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.add('fa-microphone');
                        btn.querySelector('i').classList.remove('fa-microphone-slash');
                    }
                }

                function toggleVideo() {
                    if (!localVideoTrack) return;
                    
                    isVideoOff = !isVideoOff;
                    const btn = document.getElementById('videoToggleBtn');
                    
                    if (isVideoOff) {
                        localVideoTrack.disable();
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                        btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.remove('fa-video');
                        btn.querySelector('i').classList.add('fa-video-slash');
                    } else {
                        localVideoTrack.enable();
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.add('fa-video');
                        btn.querySelector('i').classList.remove('fa-video-slash');
                    }
                }

                function leaveRoom() {
                    if (room) {
                        room.disconnect();
                        room = null;
                    }
                    
                    if (callTimerInterval) {
                        clearInterval(callTimerInterval);
                        callTimerInterval = null;
                    }
                    
                    // Stop local tracks
                    if (localVideoTrack) {
                        localVideoTrack.stop();
                    }
                    if (localAudioTrack) {
                        localAudioTrack.stop();
                    }
                    
                    // Show mobile-friendly thank you message
                    document.body.innerHTML = `
                        <div class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-50 flex items-center justify-center p-4">
                            <div class="max-w-lg w-full">
                                <div class="bg-white rounded-2xl shadow-2xl p-8 sm:p-12 text-center">
                                    <div class="inline-flex items-center justify-center w-20 h-20 sm:w-24 sm:h-24 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full mb-6 animate-bounce">
                                        <i class="fas fa-check text-green-600 text-3xl sm:text-4xl"></i>
                                    </div>
                                    <h2 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-3">Call Ended</h2>
                                    <p class="text-base sm:text-lg text-gray-600 mb-6">Thank you for using CaptureCare telehealth services.</p>
                                    <p class="text-sm text-gray-500 mb-8">You can safely close this window now.</p>
                                    
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                                        <div class="flex items-start gap-3">
                                            <i class="fas fa-info-circle text-green-600 mt-1"></i>
                                            <div class="text-sm text-green-800">
                                                <p class="font-semibold mb-1">What happens next?</p>
                                                <p>Your healthcare provider will follow up with you if needed. Check your email for any appointment summaries or prescriptions.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    if (room) {
                        room.disconnect();
                    }
                });
            </script>
            {% endif %}
        </div>

        <!-- Compact Footer -->
        <div class="bg-white border-t border-gray-200 py-2 sm:py-3 mt-auto">
            <div class="px-4 text-center text-xs sm:text-sm text-gray-500">
                <i class="fas fa-shield-alt mr-1"></i>
                <span class="hidden sm:inline">Secure telehealth by CaptureCareÂ®</span>
                <span class="sm:hidden">Secure & Encrypted</span>
            </div>
        </div>
    </div>
</body>
</html>
