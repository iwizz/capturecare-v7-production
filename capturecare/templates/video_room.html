<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Consultation - CaptureCare</title>
    <!-- Tailwind CSS removed - using inline styles and custom CSS instead -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% if not credentials_missing %}
    <script src="https://sdk.twilio.com/js/video/releases/2.28.1/twilio-video.min.js"></script>
    {% endif %}
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="fas fa-video text-indigo-600 text-2xl"></i>
                        <h1 class="text-2xl font-bold text-gray-800">CaptureCareÂ® Video Consultation</h1>
                    </div>
                    <div class="text-sm text-green-600 flex items-center gap-2">
                        <i class="fas fa-shield-alt"></i>
                        <span class="hidden sm:inline">Secure & HIPAA Compliant</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 container mx-auto px-4 py-8 flex items-center justify-center">
            {% if credentials_missing %}
            <!-- Waiting Screen (No Credentials or Room Not Ready) -->
            <div class="max-w-2xl mx-auto w-full">
                <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
                    <!-- Animated Icon -->
                    <div class="mb-8">
                        <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full mb-6 animate-pulse">
                            <i class="fas fa-video text-indigo-600 text-4xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">Waiting for Your Appointment</h2>
                        <p class="text-lg text-gray-600 mb-8">Your healthcare provider will start the video consultation shortly.</p>
                    </div>

                    <!-- Status Info -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 text-left">
                        <div class="flex items-start gap-4">
                            <i class="fas fa-info-circle text-blue-600 text-xl mt-1"></i>
                            <div class="flex-1">
                                <h3 class="font-semibold text-blue-900 mb-2">What to do next:</h3>
                                <ul class="space-y-2 text-sm text-blue-800">
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Keep this page open - it will update automatically</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Your provider will send you a notification when ready</span>
                                    </li>
                                    <li class="flex items-center gap-2">
                                        <i class="fas fa-check-circle text-blue-600"></i>
                                        <span>Make sure your camera and microphone are working</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Technical Requirements -->
                    <div class="grid md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-gray-50 rounded-lg p-4 text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <i class="fas fa-camera text-gray-600"></i>
                                <h4 class="font-semibold text-gray-800">Camera Access</h4>
                            </div>
                            <p class="text-sm text-gray-600">Allow camera access when prompted</p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-left">
                            <div class="flex items-center gap-3 mb-2">
                                <i class="fas fa-microphone text-gray-600"></i>
                                <h4 class="font-semibold text-gray-800">Microphone Access</h4>
                            </div>
                            <p class="text-sm text-gray-600">Allow microphone access for audio</p>
                        </div>
                    </div>

                    <!-- Auto-refresh Message -->
                    <div class="flex items-center justify-center gap-2 text-sm text-gray-500">
                        <i class="fas fa-sync-alt animate-spin"></i>
                        <span>Checking for your appointment... This page will refresh automatically</span>
                    </div>
                </div>
            </div>

            <script>
                // Auto-refresh every 10 seconds to check if room is ready
                setTimeout(() => {
                    window.location.reload();
                }, 10000);
            </script>

            {% else %}
            <!-- Pre-Join View (Room is Ready) -->
            <div id="preJoinView" class="max-w-3xl mx-auto w-full">
                <div class="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
                    <div class="mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full mb-4">
                            <i class="fas fa-video text-green-600 text-3xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-3">Your Consultation is Ready!</h2>
                        <p class="text-lg text-gray-600">Click the button below to join your secure video consultation with your healthcare provider.</p>
                    </div>

                    <!-- Camera Preview -->
                    <div class="bg-gray-900 rounded-xl overflow-hidden mb-8 shadow-2xl" style="height: 320px;">
                        <div id="localPreview" class="w-full h-full flex items-center justify-center">
                            <div class="text-center text-white">
                                <i class="fas fa-user-circle text-6xl mb-3 opacity-50"></i>
                                <p class="text-lg">Camera preview will appear here</p>
                                <p class="text-sm opacity-75 mt-2">Click "Join Now" to connect</p>
                            </div>
                        </div>
                    </div>

                    <!-- Join Button -->
                    <button onclick="joinRoom()" class="px-10 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:from-green-700 hover:to-emerald-700 transition font-bold text-lg shadow-lg mb-6 transform hover:scale-105">
                        <i class="fas fa-video mr-2"></i>Join Video Consultation
                    </button>

                    <!-- Privacy Notice -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-start gap-3 text-left">
                            <i class="fas fa-shield-alt text-green-600 mt-1"></i>
                            <div class="text-sm text-green-800">
                                <p class="font-semibold mb-1">Privacy & Security</p>
                                <p>Your video call is encrypted end-to-end. Please allow camera and microphone access when prompted by your browser.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Call View -->
            <div id="activeCallView" class="hidden w-full max-w-6xl">
                <!-- Video Container -->
                <div class="bg-gray-900 rounded-2xl overflow-hidden shadow-2xl" style="min-height: 600px;">
                    <!-- Remote Participant Video (Large) -->
                    <div id="remoteVideoContainer" class="relative bg-gray-800" style="height: 520px;">
                        <div id="remoteParticipantVideo" class="w-full h-full flex items-center justify-center">
                            <div class="text-center text-white">
                                <i class="fas fa-user-circle text-7xl mb-4 opacity-50 animate-pulse"></i>
                                <p class="text-xl font-semibold mb-2">Waiting for your healthcare provider...</p>
                                <p class="text-sm opacity-75">They will join shortly</p>
                            </div>
                        </div>
                        
                        <!-- Local Video (Small, Bottom Right) -->
                        <div id="localVideoContainer" class="absolute bottom-4 right-4 w-56 h-42 bg-gray-700 rounded-xl overflow-hidden border-3 border-white shadow-2xl">
                            <div id="localParticipantVideo" class="w-full h-full flex items-center justify-center">
                                <i class="fas fa-user text-white text-4xl opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Controls -->
                    <div class="bg-gray-800 px-6 py-4 flex items-center justify-between">
                        <!-- Call Duration -->
                        <div class="text-white">
                            <div class="text-xs opacity-75 mb-1">Connected</div>
                            <div id="callDuration" class="text-2xl font-bold tabular-nums text-green-400">00:00</div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="flex gap-3">
                            <button id="muteBtn" onclick="toggleMute()" class="px-5 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl transition flex items-center gap-2 text-white shadow-lg">
                                <i class="fas fa-microphone text-lg"></i>
                                <span class="hidden sm:inline font-semibold">Mute</span>
                            </button>
                            
                            <button id="videoToggleBtn" onclick="toggleVideo()" class="px-5 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl transition flex items-center gap-2 text-white shadow-lg">
                                <i class="fas fa-video text-lg"></i>
                                <span class="hidden sm:inline font-semibold">Camera</span>
                            </button>
                            
                            <button onclick="leaveRoom()" class="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 rounded-xl transition flex items-center gap-2 text-white font-bold shadow-lg">
                                <i class="fas fa-phone-slash"></i>
                                <span>Leave Call</span>
                            </button>
                        </div>
                        
                        <!-- Participant Count -->
                        <div class="text-white">
                            <div class="text-xs opacity-75 mb-1">Participants</div>
                            <div id="participantCount" class="text-2xl font-bold text-blue-400">1</div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="mt-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-5">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-600 text-lg mt-1"></i>
                            <div class="text-sm text-gray-700">
                                <p class="font-semibold mb-1">During your consultation:</p>
                                <p>Use the controls above to mute your microphone or turn off your camera. Click "Leave Call" when you're finished.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                const ROOM_NAME = "{{ room_name }}";
                const ACCESS_TOKEN = "{{ access_token }}";
                
                let room = null;
                let localAudioTrack = null;
                let localVideoTrack = null;
                let callStartTime = null;
                let callTimerInterval = null;
                let isMuted = false;
                let isVideoOff = false;

                async function joinRoom() {
                    try {
                        // Create local tracks
                        const tracks = await Twilio.Video.createLocalTracks({
                            audio: true,
                            video: { width: 640 }
                        });
                        
                        localAudioTrack = tracks.find(track => track.kind === 'audio');
                        localVideoTrack = tracks.find(track => track.kind === 'video');
                        
                        // Connect to room
                        room = await Twilio.Video.connect(ACCESS_TOKEN, {
                            name: ROOM_NAME,
                            tracks: tracks
                        });
                        
                        console.log('âœ… Connected to room:', room.name);
                        
                        // Show active call view
                        document.getElementById('preJoinView').classList.add('hidden');
                        document.getElementById('activeCallView').classList.remove('hidden');
                        
                        // Start call timer
                        callStartTime = Date.now();
                        callTimerInterval = setInterval(updateCallDuration, 1000);
                        
                        // Attach local video
                        if (localVideoTrack) {
                            const videoElement = localVideoTrack.attach();
                            videoElement.style.width = '100%';
                            videoElement.style.height = '100%';
                            videoElement.style.objectFit = 'cover';
                            document.getElementById('localParticipantVideo').innerHTML = '';
                            document.getElementById('localParticipantVideo').appendChild(videoElement);
                        }
                        
                        // Handle existing participants
                        room.participants.forEach(participantConnected);
                        
                        // Handle new participants
                        room.on('participantConnected', participantConnected);
                        room.on('participantDisconnected', participantDisconnected);
                        
                    } catch (error) {
                        console.error('âŒ Error joining room:', error);
                        alert('Unable to join video call. Please check your camera and microphone permissions and try again.\n\nError: ' + error.message);
                    }
                }

                function participantConnected(participant) {
                    console.log('ðŸ‘¤ Participant connected:', participant.identity);
                    
                    // Update participant count
                    const count = room.participants.size + 1;
                    document.getElementById('participantCount').textContent = count;
                    
                    // Subscribe to tracks
                    participant.tracks.forEach(publication => {
                        if (publication.track) {
                            attachTrack(publication.track);
                        }
                    });
                    
                    participant.on('trackSubscribed', attachTrack);
                }

                function participantDisconnected(participant) {
                    console.log('ðŸ‘¤ Participant disconnected:', participant.identity);
                    
                    // Update participant count
                    const count = room.participants.size + 1;
                    document.getElementById('participantCount').textContent = count;
                    
                    // If no remote participants, show waiting message
                    if (room.participants.size === 0) {
                        document.getElementById('remoteParticipantVideo').innerHTML = `
                            <div class="text-center text-white">
                                <i class="fas fa-user-circle text-7xl mb-4 opacity-50 animate-pulse"></i>
                                <p class="text-xl font-semibold mb-2">Waiting for your healthcare provider...</p>
                                <p class="text-sm opacity-75">They will join shortly</p>
                            </div>
                        `;
                    }
                }

                function attachTrack(track) {
                    if (track.kind === 'video') {
                        const videoElement = track.attach();
                        videoElement.style.width = '100%';
                        videoElement.style.height = '100%';
                        videoElement.style.objectFit = 'cover';
                        document.getElementById('remoteParticipantVideo').innerHTML = '';
                        document.getElementById('remoteParticipantVideo').appendChild(videoElement);
                    } else if (track.kind === 'audio') {
                        const audioElement = track.attach();
                        document.body.appendChild(audioElement);
                    }
                }

                function updateCallDuration() {
                    if (!callStartTime) return;
                    
                    const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('callDuration').textContent = `${minutes}:${seconds}`;
                }

                function toggleMute() {
                    if (!localAudioTrack) return;
                    
                    isMuted = !isMuted;
                    const btn = document.getElementById('muteBtn');
                    
                    if (isMuted) {
                        localAudioTrack.disable();
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                        btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.remove('fa-microphone');
                        btn.querySelector('i').classList.add('fa-microphone-slash');
                    } else {
                        localAudioTrack.enable();
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.add('fa-microphone');
                        btn.querySelector('i').classList.remove('fa-microphone-slash');
                    }
                }

                function toggleVideo() {
                    if (!localVideoTrack) return;
                    
                    isVideoOff = !isVideoOff;
                    const btn = document.getElementById('videoToggleBtn');
                    
                    if (isVideoOff) {
                        localVideoTrack.disable();
                        btn.classList.add('bg-red-600', 'hover:bg-red-700');
                        btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.remove('fa-video');
                        btn.querySelector('i').classList.add('fa-video-slash');
                    } else {
                        localVideoTrack.enable();
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        btn.querySelector('i').classList.add('fa-video');
                        btn.querySelector('i').classList.remove('fa-video-slash');
                    }
                }

                function leaveRoom() {
                    if (room) {
                        room.disconnect();
                        room = null;
                    }
                    
                    if (callTimerInterval) {
                        clearInterval(callTimerInterval);
                        callTimerInterval = null;
                    }
                    
                    // Show thank you message
                    document.getElementById('activeCallView').innerHTML = `
                        <div class="max-w-3xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-xl p-12 text-center">
                                <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-green-100 to-emerald-100 rounded-full mb-6">
                                    <i class="fas fa-check text-green-600 text-4xl"></i>
                                </div>
                                <h2 class="text-3xl font-bold text-gray-800 mb-3">Consultation Ended</h2>
                                <p class="text-lg text-gray-600 mb-6">Thank you for using CaptureCare telehealth services.</p>
                                <p class="text-sm text-gray-500">You can safely close this window now.</p>
                            </div>
                        </div>
                    `;
                }

                // Cleanup on page unload
                window.addEventListener('beforeunload', () => {
                    if (room) {
                        room.disconnect();
                    }
                });
            </script>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="bg-white border-t border-gray-200 py-4 mt-8">
            <div class="container mx-auto px-4 text-center text-sm text-gray-500">
                <i class="fas fa-shield-alt mr-1"></i>
                Secure telehealth consultation powered by CaptureCareÂ® | HIPAA Compliant
            </div>
        </div>
    </div>
</body>
</html>
