{% extends "base.html" %}

{% block title %}Communications - CaptureCare{% endblock %}

{% block head %}
<!-- Twilio Video SDK -->
<script src="https://sdk.twilio.com/js/video/releases/2.27.0/twilio-video.min.js"></script>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-comments mr-3 text-brand-bright-teal"></i>
            Communications
        </h1>
        <p class="text-gray-600">View all SMS, email, and call correspondence with patients</p>
    </div>

    <!-- New Communication Actions -->
    <div class="bg-gradient-to-r from-brand-bright-teal to-brand-teal rounded-lg shadow-lg p-6 mb-6">
        <div class="flex items-center justify-between">
            <div class="text-white">
                <h2 class="text-xl font-bold mb-1">
                    <i class="fas fa-bolt mr-2"></i>Quick Actions
                </h2>
                <p class="text-sm opacity-90">Initiate communication with patients</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openSmsModal()" class="px-6 py-3 bg-white text-brand-bright-teal rounded-lg hover:bg-gray-100 transition font-semibold shadow-md">
                    <i class="fas fa-sms mr-2"></i>Send SMS
                </button>
                <button onclick="openPhoneCallModal()" class="px-6 py-3 bg-white text-brand-bright-teal rounded-lg hover:bg-gray-100 transition font-semibold shadow-md">
                    <i class="fas fa-phone mr-2"></i>Make Call
                </button>
                <button onclick="openVideoCallModal()" class="px-6 py-3 bg-white text-brand-bright-teal rounded-lg hover:bg-gray-100 transition font-semibold shadow-md">
                    <i class="fas fa-video mr-2"></i>Video Call
                </button>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-{% if is_practitioner %}5{% else %}4{% endif %} gap-4">
            {% if is_practitioner %}
            <!-- Patient Filter (Practitioners Only) -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-users mr-1 text-brand-bright-teal"></i>Patients
                </label>
                <select id="patientFilter" onchange="loadCorrespondence()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="my_patients">üë§ My Patients Only</option>
                    <option value="all">üë• All Patients</option>
                </select>
            </div>
            {% endif %}
            
            <!-- Channel Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Channel</label>
                <select id="channelFilter" onchange="loadCorrespondence()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="">All Channels</option>
                    <option value="sms">üì± SMS Only</option>
                    <option value="email">üìß Email Only</option>
                </select>
            </div>

            <!-- Direction Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Direction</label>
                <select id="directionFilter" onchange="loadCorrespondence()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="">All Directions</option>
                    <option value="inbound">‚¨áÔ∏è Inbound</option>
                    <option value="outbound">‚¨ÜÔ∏è Outbound</option>
                </select>
            </div>

            <!-- Patient Search -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Search Patient</label>
                <input type="text" id="patientSearch" placeholder="Name or email..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent"
                       onkeyup="searchDebounce()">
            </div>

            <!-- Workflow Status Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Workflow Status</label>
                <select id="statusFilter" onchange="loadCorrespondence()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="">All Status</option>
                    <option value="pending">‚è≥ Pending</option>
                    <option value="completed">‚úÖ Completed</option>
                    <option value="follow_up_needed">üîî Follow-up Needed</option>
                    <option value="no_action_required">‚úîÔ∏è No Action Required</option>
                </select>
            </div>

            <!-- Refresh Button -->
            <div class="flex items-end">
                <button onclick="loadCorrespondence()" class="w-full px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-sync-alt mr-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Correspondence List -->
    <div class="bg-white rounded-lg shadow-md">
        <!-- Header -->
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">
                    <span id="correspondenceCount">0</span> Messages
                </h2>
                <div class="text-sm text-gray-600">
                    <span id="loadingIndicator" class="hidden">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading...
                    </span>
                </div>
            </div>
        </div>

        <!-- Correspondence Items -->
        <div id="correspondenceList" class="divide-y divide-gray-200">
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-envelope text-4xl mb-3 text-gray-300"></i>
                <p>Loading correspondence...</p>
            </div>
        </div>

        <!-- Load More Button -->
        <div id="loadMoreContainer" class="p-6 text-center hidden">
            <button onclick="loadMore()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                <i class="fas fa-chevron-down mr-2"></i>Load More
            </button>
        </div>
    </div>
</div>

<!-- SMS Modal -->
<div id="smsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-sms mr-2 text-brand-bright-teal"></i>Send SMS
                </h3>
                <button onclick="closeSmsModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <form id="smsForm" onsubmit="sendSmsMessage(event)" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
                <select id="smsPatientSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="">Loading patients...</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                <input type="tel" id="smsPhone" required placeholder="+61 400 000 000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Message</label>
                <textarea id="smsMessage" required rows="4" placeholder="Type your message here..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent"></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    <span id="smsCharCount">0</span>/160 characters
                </p>
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeSmsModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-semibold">
                    Cancel
                </button>
                <button type="submit" class="flex-1 px-4 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-paper-plane mr-2"></i>Send SMS
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Phone Call Modal -->
<div id="phoneCallModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-phone mr-2 text-brand-bright-teal"></i>Make Phone Call
                </h3>
                <button onclick="closePhoneCallModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <!-- Call Setup View -->
            <div id="callSetup" class="call-view">
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
                    <select id="callPatientSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                        <option value="">Loading patients...</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Phone Number</label>
                    <input type="tel" id="callPhone" required placeholder="+61 400 000 000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                </div>
                <button onclick="initiatePhoneCall()" class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold">
                    <i class="fas fa-phone-alt mr-2"></i>Start Call
                </button>
            </div>
            
            <!-- Active Call View -->
            <div id="activeCall" class="call-view hidden">
                <div class="text-center mb-6">
                    <div class="inline-block p-6 bg-green-100 rounded-full mb-4">
                        <i class="fas fa-phone-alt text-5xl text-green-600"></i>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 mb-1" id="callPatientName">Calling...</h4>
                    <p class="text-gray-600" id="callPhoneNumber"></p>
                    <p class="text-2xl font-bold text-brand-bright-teal mt-4" id="callDuration">00:00</p>
                    <p class="text-sm text-gray-500" id="callStatus">Connecting...</p>
                </div>
                <div class="flex gap-3 mb-4">
                    <button onclick="toggleMute()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                        <i id="muteIcon" class="fas fa-microphone mr-2"></i>
                        <span id="muteText">Mute</span>
                    </button>
                    <button onclick="toggleHold()" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                        <i id="holdIcon" class="fas fa-pause mr-2"></i>
                        <span id="holdText">Hold</span>
                    </button>
                </div>
                <button onclick="endPhoneCall()" class="w-full px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-semibold">
                    <i class="fas fa-phone-slash mr-2"></i>End Call
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Video Call Modal -->
<div id="videoCallModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-video mr-2 text-brand-bright-teal"></i>Video Call
                </h3>
                <button onclick="closeVideoCallModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Video Setup View -->
        <div id="videoSetup" class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Select Patient</label>
                <select id="videoPatientSelect" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-brand-bright-teal focus:border-transparent">
                    <option value="">Loading patients...</option>
                </select>
            </div>
            <div class="mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        A video room will be created and you can send the link to your patient via SMS.
                    </p>
                </div>
            </div>
            <button onclick="startVideoCallSession()" class="w-full px-4 py-3 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                <i class="fas fa-video mr-2"></i>Start Video Call
            </button>
        </div>
        
        <!-- Active Video Call View -->
        <div id="activeVideoCall" class="hidden">
            <!-- Video Grid -->
            <div class="bg-gray-900 p-4">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <!-- Remote Participant Video -->
                    <div class="relative bg-gray-800 rounded-lg overflow-hidden" style="height: 300px;">
                        <div id="remoteVideo" class="w-full h-full flex items-center justify-center text-white">
                            <div class="text-center">
                                <i class="fas fa-user-circle text-6xl mb-2 text-gray-600"></i>
                                <p class="text-sm text-gray-400">Waiting for patient...</p>
                            </div>
                        </div>
                        <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 px-3 py-1 rounded text-white text-sm">
                            <span id="remoteParticipantName">Patient</span>
                        </div>
                    </div>
                    
                    <!-- Local Video (You) -->
                    <div class="relative bg-gray-800 rounded-lg overflow-hidden" style="height: 300px;">
                        <div id="localVideo" class="w-full h-full"></div>
                        <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 px-3 py-1 rounded text-white text-sm">
                            You
                        </div>
                    </div>
                </div>
                
                <!-- Video Controls -->
                <div class="flex items-center justify-center gap-4 mb-4">
                    <button onclick="toggleVideoMute()" class="p-4 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition">
                        <i id="videoMuteIcon" class="fas fa-microphone text-xl"></i>
                    </button>
                    <button onclick="toggleVideoCamera()" class="p-4 bg-gray-700 text-white rounded-full hover:bg-gray-600 transition">
                        <i id="videoCameraIcon" class="fas fa-video text-xl"></i>
                    </button>
                    <button onclick="endVideoCall()" class="p-4 bg-red-600 text-white rounded-full hover:bg-red-700 transition">
                        <i class="fas fa-phone-slash text-xl"></i>
                    </button>
                </div>
                
                <!-- Call Info -->
                <div class="text-center text-white">
                    <p class="text-2xl font-bold mb-1" id="videoCallDuration">00:00</p>
                    <p class="text-sm text-gray-400" id="videoCallStatus">Connected</p>
                </div>
            </div>
            
            <!-- Send Invite Section -->
            <div class="p-6 bg-gray-50 border-t border-gray-200">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Patient Join Link</label>
                <div class="flex gap-2">
                    <input type="text" id="videoRoomLink" readonly class="flex-1 px-4 py-2 border border-gray-300 rounded-lg bg-white">
                    <button onclick="copyVideoLink()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-semibold">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button onclick="sendVideoLinkSms()" class="px-4 py-2 bg-brand-bright-teal text-white rounded-lg hover:bg-brand-teal transition font-semibold">
                        <i class="fas fa-sms mr-1"></i> Send SMS
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Detail Modal -->
<div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200 sticky top-0 bg-white">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Message Details</h3>
                    <p class="text-sm text-gray-600 mt-1" id="modalPatient"></p>
                </div>
                <button onclick="closeMessageModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6">
            <!-- Channel & Direction -->
            <div class="flex items-center gap-4 mb-4">
                <span id="modalChannel" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                <span id="modalDirection" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                <span id="modalStatus" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
            </div>

            <!-- Subject (Email only) -->
            <div id="modalSubjectContainer" class="mb-4 hidden">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Subject</label>
                <p id="modalSubject" class="text-gray-800"></p>
            </div>

            <!-- Contact Info -->
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Contact</label>
                <p id="modalContact" class="text-gray-800"></p>
            </div>

            <!-- Message Body -->
            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Message</label>
                <div id="modalBody" class="text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded-lg border border-gray-200"></div>
            </div>

            <!-- Timestamps -->
            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                <div>
                    <label class="font-semibold">Sent:</label>
                    <p id="modalSentAt"></p>
                </div>
                <div id="modalDeliveredContainer" class="hidden">
                    <label class="font-semibold">Delivered:</label>
                    <p id="modalDeliveredAt"></p>
                </div>
            </div>

            <!-- Error Message -->
            <div id="modalErrorContainer" class="mt-4 hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-sm font-semibold text-red-800 mb-1">Error</p>
                    <p id="modalError" class="text-sm text-red-600"></p>
                </div>
            </div>

            <!-- View Patient Button -->
            <div class="mt-6">
                <a id="viewPatientBtn" href="#" class="block w-full px-4 py-3 bg-brand-bright-teal text-white text-center rounded-lg hover:bg-brand-teal transition font-semibold">
                    <i class="fas fa-user mr-2"></i>View Patient Record
                </a>
            </div>
        </div>
    </div>
</div>

<script>
let currentOffset = 0;
const limit = 50;
let totalMessages = 0;
let searchTimeout = null;

// Load correspondence on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCorrespondence();
});

function searchDebounce() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        loadCorrespondence();
    }, 500);
}

async function updateWorkflowStatus(correspondenceId, newStatus, event) {
    event.stopPropagation();
    
    try {
        const response = await fetch(`/api/correspondence/${correspondenceId}/workflow-status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                workflow_status: newStatus
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update the dropdown color
            const select = event.target;
            const statusMap = {
                'pending': 'bg-yellow-100 text-yellow-800',
                'completed': 'bg-green-100 text-green-800',
                'follow_up_needed': 'bg-red-100 text-red-800',
                'no_action_required': 'bg-gray-100 text-gray-800'
            };
            select.className = `px-3 py-1 rounded-lg text-xs font-semibold border-0 cursor-pointer ${statusMap[newStatus]}`;
        } else {
            alert('Failed to update status: ' + data.error);
            // Reload to reset the dropdown
            loadCorrespondence();
        }
    } catch (error) {
        console.error('Error updating workflow status:', error);
        alert('Failed to update status');
        loadCorrespondence();
    }
}

async function loadCorrespondence(append = false) {
    const channel = document.getElementById('channelFilter').value;
    const direction = document.getElementById('directionFilter').value;
    const patientSearch = document.getElementById('patientSearch').value;
    const workflowStatus = document.getElementById('statusFilter').value;
    
    // Get patient filter if it exists (for practitioners)
    const patientFilterElement = document.getElementById('patientFilter');
    const patientFilter = patientFilterElement ? patientFilterElement.value : 'all';
    
    if (!append) {
        currentOffset = 0;
    }
    
    document.getElementById('loadingIndicator').classList.remove('hidden');
    
    try {
        const params = new URLSearchParams({
            channel: channel,
            direction: direction,
            patient_search: patientSearch,
            workflow_status: workflowStatus,
            patient_filter: patientFilter,
            limit: limit,
            offset: currentOffset
        });
        
        const response = await fetch(`/api/correspondence/all?${params}`);
        const data = await response.json();
        
        if (data.success) {
            totalMessages = data.total;
            document.getElementById('correspondenceCount').textContent = totalMessages;
            
            if (append) {
                appendCorrespondence(data.correspondence);
            } else {
                renderCorrespondence(data.correspondence);
            }
            
            // Show/hide load more button
            if (currentOffset + limit < totalMessages) {
                document.getElementById('loadMoreContainer').classList.remove('hidden');
            } else {
                document.getElementById('loadMoreContainer').classList.add('hidden');
            }
        }
    } catch (error) {
        console.error('Error loading correspondence:', error);
        document.getElementById('correspondenceList').innerHTML = `
            <div class="p-8 text-center text-red-500">
                <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                <p>Error loading correspondence</p>
            </div>
        `;
    } finally {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }
}

function renderCorrespondence(correspondence) {
    const list = document.getElementById('correspondenceList');
    
    if (correspondence.length === 0) {
        list.innerHTML = `
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
                <p>No correspondence found</p>
            </div>
        `;
        return;
    }
    
    list.innerHTML = correspondence.map(msg => createCorrespondenceCard(msg)).join('');
}

function appendCorrespondence(correspondence) {
    const list = document.getElementById('correspondenceList');
    const newHtml = correspondence.map(msg => createCorrespondenceCard(msg)).join('');
    list.insertAdjacentHTML('beforeend', newHtml);
}

function createCorrespondenceCard(msg) {
    const channelIcon = msg.channel === 'sms' ? 'fa-sms' : 'fa-envelope';
    const channelColor = msg.channel === 'sms' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
    const directionIcon = msg.direction === 'inbound' ? 'fa-arrow-down' : 'fa-arrow-up';
    const directionColor = msg.direction === 'inbound' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800';
    
    // Show "sent" instead of "queued" for better UX
    const displayStatus = msg.status === 'queued' ? 'sent' : msg.status;
    const statusColor = displayStatus === 'failed' ? 'text-red-600' : 
                       displayStatus === 'delivered' ? 'text-green-600' : 
                       displayStatus === 'sent' ? 'text-blue-600' : 'text-gray-600';
    
    const preview = msg.body ? msg.body.substring(0, 100) + (msg.body.length > 100 ? '...' : '') : '';
    
    // Workflow status styling
    const workflowStatusMap = {
        'pending': { emoji: '‚è≥', color: 'bg-yellow-100 text-yellow-800' },
        'completed': { emoji: '‚úÖ', color: 'bg-green-100 text-green-800' },
        'follow_up_needed': { emoji: 'üîî', color: 'bg-red-100 text-red-800' },
        'no_action_required': { emoji: '‚úîÔ∏è', color: 'bg-gray-100 text-gray-800' }
    };
    const workflowInfo = workflowStatusMap[msg.workflow_status] || workflowStatusMap['pending'];
    
    return `
        <div class="p-4 border-b border-gray-200 hover:bg-gray-50 transition">
            <div class="flex items-start gap-4">
                <div class="flex-shrink-0">
                    <i class="fas ${channelIcon} text-2xl text-gray-400"></i>
                </div>
                <div class="flex-grow min-w-0 cursor-pointer" onclick='window.location.href="/patients/${msg.patient_id}#correspondence"'>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-semibold text-gray-800 hover:text-brand-bright-teal">${msg.patient_name}</span>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${channelColor}">
                            ${msg.channel.toUpperCase()}
                        </span>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${directionColor}">
                            <i class="fas ${directionIcon} mr-1"></i>${msg.direction}
                        </span>
                    </div>
                    ${msg.subject ? `<p class="text-sm font-medium text-gray-700 mb-1">${msg.subject}</p>` : ''}
                    <p class="text-sm text-gray-600 mb-2">${preview}</p>
                    <div class="flex items-center gap-3 text-xs text-gray-500">
                        <span><i class="far fa-clock mr-1"></i>${msg.sent_at} AEDT</span>
                        <span class="${statusColor}"><i class="fas fa-circle mr-1 text-xs"></i>${displayStatus || 'unknown'}</span>
                    </div>
                </div>
                <div class="flex-shrink-0">
                    <select 
                        class="px-3 py-1 rounded-lg text-xs font-semibold border-0 cursor-pointer ${workflowInfo.color}"
                        onchange="updateWorkflowStatus(${msg.id}, this.value, event)"
                        onclick="event.stopPropagation()">
                        <option value="pending" ${msg.workflow_status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                        <option value="completed" ${msg.workflow_status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                        <option value="follow_up_needed" ${msg.workflow_status === 'follow_up_needed' ? 'selected' : ''}>üîî Follow-up</option>
                        <option value="no_action_required" ${msg.workflow_status === 'no_action_required' ? 'selected' : ''}>‚úîÔ∏è No Action</option>
                    </select>
                </div>
            </div>
        </div>
    `;
}

function viewMessage(msg) {
    // Set modal content
    document.getElementById('modalTitle').textContent = msg.channel === 'sms' ? 'SMS Message' : 'Email Message';
    document.getElementById('modalPatient').textContent = `Patient: ${msg.patient_name}`;
    
    // Channel badge
    const channelBadge = document.getElementById('modalChannel');
    channelBadge.textContent = msg.channel.toUpperCase();
    channelBadge.className = `px-3 py-1 rounded-full text-sm font-semibold ${
        msg.channel === 'sms' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'
    }`;
    
    // Direction badge
    const directionBadge = document.getElementById('modalDirection');
    directionBadge.textContent = msg.direction.toUpperCase();
    directionBadge.className = `px-3 py-1 rounded-full text-sm font-semibold ${
        msg.direction === 'inbound' ? 'bg-purple-100 text-purple-800' : 'bg-orange-100 text-orange-800'
    }`;
    
    // Status badge
    const statusBadge = document.getElementById('modalStatus');
    statusBadge.textContent = msg.status || 'unknown';
    statusBadge.className = `px-3 py-1 rounded-full text-sm font-semibold ${
        msg.status === 'failed' ? 'bg-red-100 text-red-800' :
        msg.status === 'delivered' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
    }`;
    
    // Subject (email only)
    if (msg.subject) {
        document.getElementById('modalSubject').textContent = msg.subject;
        document.getElementById('modalSubjectContainer').classList.remove('hidden');
    } else {
        document.getElementById('modalSubjectContainer').classList.add('hidden');
    }
    
    // Contact info
    const contact = msg.channel === 'sms' 
        ? (msg.direction === 'inbound' ? msg.sender_phone : msg.recipient_phone)
        : (msg.direction === 'inbound' ? msg.sender_email : msg.recipient_email);
    document.getElementById('modalContact').textContent = contact || 'N/A';
    
    // Message body
    document.getElementById('modalBody').textContent = msg.body || 'No message content';
    
    // Timestamps (already in AEST from backend)
    document.getElementById('modalSentAt').textContent = msg.sent_at + ' AEDT';
    if (msg.delivered_at) {
        document.getElementById('modalDeliveredAt').textContent = msg.delivered_at + ' AEDT';
        document.getElementById('modalDeliveredContainer').classList.remove('hidden');
    } else {
        document.getElementById('modalDeliveredContainer').classList.add('hidden');
    }
    
    // Error message
    if (msg.error_message) {
        document.getElementById('modalError').textContent = msg.error_message;
        document.getElementById('modalErrorContainer').classList.remove('hidden');
    } else {
        document.getElementById('modalErrorContainer').classList.add('hidden');
    }
    
    // View patient button
    document.getElementById('viewPatientBtn').href = `/patients/${msg.patient_id}`;
    
    // Show modal
    document.getElementById('messageModal').classList.remove('hidden');
}

function closeMessageModal() {
    document.getElementById('messageModal').classList.add('hidden');
}

function loadMore() {
    currentOffset += limit;
    loadCorrespondence(true);
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    const intervals = {
        year: 31536000,
        month: 2592000,
        week: 604800,
        day: 86400,
        hour: 3600,
        minute: 60
    };
    
    for (const [name, value] of Object.entries(intervals)) {
        const interval = Math.floor(seconds / value);
        if (interval >= 1) {
            return interval === 1 ? `1 ${name} ago` : `${interval} ${name}s ago`;
        }
    }
    
    return 'Just now';
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeMessageModal();
    }
});

// Close modal on background click
document.getElementById('messageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeMessageModal();
    }
});

// ==================== NEW COMMUNICATION FEATURES ====================

// Global variables for calls
let currentCallSid = null;
let callTimer = null;
let callStartTime = null;
let isMuted = false;
let isOnHold = false;
let videoRoom = null;
let videoCallTimer = null;
let videoCallStartTime = null;
let isVideoMuted = false;
let isVideoCameraOff = false;
let localVideoTrack = null;
let localAudioTrack = null;
let currentPatientId = null;
let currentPatientPhone = null;

// Load patients when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadPatients();
});

// ==================== PATIENT LOADING ====================

async function loadPatients() {
    try {
        const response = await fetch('/api/patients/list');
        const data = await response.json();
        
        if (data.success) {
            const patients = data.patients;
            const options = '<option value="">Select a patient...</option>' + 
                patients.map(p => `<option value="${p.id}" data-phone="${p.phone || ''}">${p.name}${p.phone ? ' (' + p.phone + ')' : ''}</option>`).join('');
            
            document.getElementById('smsPatientSelect').innerHTML = options;
            document.getElementById('callPatientSelect').innerHTML = options;
            document.getElementById('videoPatientSelect').innerHTML = options;
            
            // Add change event listeners to auto-fill phone numbers
            document.getElementById('smsPatientSelect').addEventListener('change', function(e) {
                const phone = e.target.selectedOptions[0]?.getAttribute('data-phone');
                if (phone) document.getElementById('smsPhone').value = phone;
            });
            
            document.getElementById('callPatientSelect').addEventListener('change', function(e) {
                const phone = e.target.selectedOptions[0]?.getAttribute('data-phone');
                if (phone) document.getElementById('callPhone').value = phone;
            });
        }
    } catch (error) {
        console.error('Error loading patients:', error);
    }
}

// ==================== SMS MODAL ====================

function openSmsModal() {
    document.getElementById('smsModal').classList.remove('hidden');
    document.getElementById('smsForm').reset();
}

function closeSmsModal() {
    document.getElementById('smsModal').classList.add('hidden');
}

// SMS character counter
document.addEventListener('DOMContentLoaded', function() {
    const smsMessageEl = document.getElementById('smsMessage');
    if (smsMessageEl) {
        smsMessageEl.addEventListener('input', function() {
            document.getElementById('smsCharCount').textContent = this.value.length;
        });
    }
});

async function sendSmsMessage(event) {
    event.preventDefault();
    
    const patientId = document.getElementById('smsPatientSelect').value;
    const phone = document.getElementById('smsPhone').value;
    const message = document.getElementById('smsMessage').value;
    
    if (!patientId || !phone || !message) {
        alert('Please fill in all fields');
        return;
    }
    
    const submitBtn = event.target.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
    
    try {
        const response = await fetch(`/api/patients/${patientId}/send-sms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone, message})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ SMS sent successfully!');
            closeSmsModal();
            loadCorrespondence(); // Reload to show new message
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending SMS:', error);
        alert('‚ùå Error sending SMS: ' + error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send SMS';
    }
}

// ==================== PHONE CALL MODAL ====================

function openPhoneCallModal() {
    document.getElementById('phoneCallModal').classList.remove('hidden');
    document.getElementById('callSetup').classList.remove('hidden');
    document.getElementById('activeCall').classList.add('hidden');
}

function closePhoneCallModal() {
    if (currentCallSid && confirm('End the current call?')) {
        endPhoneCall();
    }
    document.getElementById('phoneCallModal').classList.add('hidden');
    if (callTimer) clearInterval(callTimer);
}

async function initiatePhoneCall() {
    const patientId = document.getElementById('callPatientSelect').value;
    const phone = document.getElementById('callPhone').value;
    
    if (!patientId || !phone) {
        alert('Please select a patient and enter phone number');
        return;
    }
    
    try {
        const response = await fetch(`/api/patients/${patientId}/initiate-call`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone})
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentCallSid = data.call_sid;
            currentPatientId = patientId;
            currentPatientPhone = phone;
            
            // Update UI
            document.getElementById('callSetup').classList.add('hidden');
            document.getElementById('activeCall').classList.remove('hidden');
            
            const patientName = document.getElementById('callPatientSelect').selectedOptions[0].text;
            document.getElementById('callPatientName').textContent = patientName;
            document.getElementById('callPhoneNumber').textContent = phone;
            document.getElementById('callStatus').textContent = data.status || 'Connecting...';
            
            // Start call timer
            callStartTime = Date.now();
            callTimer = setInterval(updateCallDuration, 1000);
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error initiating call:', error);
        alert('‚ùå Error initiating call: ' + error.message);
    }
}

function updateCallDuration() {
    if (!callStartTime) return;
    const seconds = Math.floor((Date.now() - callStartTime) / 1000);
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('callDuration').textContent = 
        `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function toggleMute() {
    // Note: Actual muting would require Twilio Voice SDK on client side
    // This is a UI state toggle - full implementation would require more integration
    isMuted = !isMuted;
    document.getElementById('muteIcon').className = isMuted ? 'fas fa-microphone-slash mr-2' : 'fas fa-microphone mr-2';
    document.getElementById('muteText').textContent = isMuted ? 'Unmute' : 'Mute';
}

function toggleHold() {
    // Note: Actual hold would require Twilio Voice SDK
    isOnHold = !isOnHold;
    document.getElementById('holdIcon').className = isOnHold ? 'fas fa-play mr-2' : 'fas fa-pause mr-2';
    document.getElementById('holdText').textContent = isOnHold ? 'Resume' : 'Hold';
}

async function endPhoneCall() {
    if (!currentCallSid) return;
    
    try {
        const response = await fetch(`/api/patients/${currentPatientId}/end-call`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({call_sid: currentCallSid})
        });
        
        const data = await response.json();
        
        if (data.success || data.message) {
            alert('‚úÖ Call ended');
            closePhoneCallModal();
            loadCorrespondence(); // Reload to show call log
        }
    } catch (error) {
        console.error('Error ending call:', error);
    }
    
    // Cleanup
    if (callTimer) clearInterval(callTimer);
    currentCallSid = null;
    callStartTime = null;
    isMuted = false;
    isOnHold = false;
}

// ==================== VIDEO CALL MODAL ====================

function openVideoCallModal() {
    document.getElementById('videoCallModal').classList.remove('hidden');
    document.getElementById('videoSetup').classList.remove('hidden');
    document.getElementById('activeVideoCall').classList.add('hidden');
}

function closeVideoCallModal() {
    if (videoRoom && confirm('End the video call?')) {
        endVideoCall();
    }
    document.getElementById('videoCallModal').classList.add('hidden');
}

async function startVideoCallSession() {
    const patientId = document.getElementById('videoPatientSelect').value;
    
    if (!patientId) {
        alert('Please select a patient');
        return;
    }
    
    currentPatientId = patientId;
    
    try {
        // Get video token
        const response = await fetch(`/api/patients/${patientId}/video-token`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (!data.success) {
            alert('‚ùå Error: ' + data.error);
            return;
        }
        
        // Create video room link
        const roomUrl = (window.location.origin + '/video-room/' + data.room_name);
        document.getElementById('videoRoomLink').value = roomUrl;
        
        // Show active video call view
        document.getElementById('videoSetup').classList.add('hidden');
        document.getElementById('activeVideoCall').classList.remove('hidden');
        
        // Connect to Twilio Video
        if (typeof Twilio === 'undefined' || !Twilio.Video) {
            alert('‚ö†Ô∏è Twilio Video SDK not loaded. Please refresh the page.');
            return;
        }
        
        const tracks = await Twilio.Video.createLocalTracks({
            audio: true,
            video: { width: 640, height: 480 }
        });
        
        localAudioTrack = tracks.find(track => track.kind === 'audio');
        localVideoTrack = tracks.find(track => track.kind === 'video');
        
        videoRoom = await Twilio.Video.connect(data.token, {
            name: data.room_name,
            tracks: tracks
        });
        
        console.log('‚úÖ Connected to video room:', videoRoom.name);
        
        // Attach local video
        if (localVideoTrack) {
            const videoElement = localVideoTrack.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            document.getElementById('localVideo').appendChild(videoElement);
        }
        
        // Start call timer
        videoCallStartTime = Date.now();
        videoCallTimer = setInterval(updateVideoCallDuration, 1000);
        
        // Handle participant connections
        videoRoom.on('participantConnected', participant => {
            console.log('Participant connected:', participant.identity);
            handleRemoteParticipant(participant);
        });
        
        videoRoom.participants.forEach(handleRemoteParticipant);
        
    } catch (error) {
        console.error('Error starting video call:', error);
        alert('‚ùå Error starting video call: ' + error.message);
    }
}

function handleRemoteParticipant(participant) {
    document.getElementById('remoteParticipantName').textContent = participant.identity;
    
    participant.on('trackSubscribed', track => {
        if (track.kind === 'video') {
            const videoElement = track.attach();
            videoElement.style.width = '100%';
            videoElement.style.height = '100%';
            videoElement.style.objectFit = 'cover';
            const remoteDiv = document.getElementById('remoteVideo');
            remoteDiv.innerHTML = '';
            remoteDiv.appendChild(videoElement);
        }
    });
}

function updateVideoCallDuration() {
    if (!videoCallStartTime) return;
    const seconds = Math.floor((Date.now() - videoCallStartTime) / 1000);
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    document.getElementById('videoCallDuration').textContent = 
        `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
}

function toggleVideoMute() {
    if (!localAudioTrack) return;
    
    if (isVideoMuted) {
        localAudioTrack.enable();
        document.getElementById('videoMuteIcon').className = 'fas fa-microphone text-xl';
    } else {
        localAudioTrack.disable();
        document.getElementById('videoMuteIcon').className = 'fas fa-microphone-slash text-xl';
    }
    isVideoMuted = !isVideoMuted;
}

function toggleVideoCamera() {
    if (!localVideoTrack) return;
    
    if (isVideoCameraOff) {
        localVideoTrack.enable();
        document.getElementById('videoCameraIcon').className = 'fas fa-video text-xl';
    } else {
        localVideoTrack.disable();
        document.getElementById('videoCameraIcon').className = 'fas fa-video-slash text-xl';
    }
    isVideoCameraOff = !isVideoCameraOff;
}

async function endVideoCall() {
    if (videoRoom) {
        videoRoom.disconnect();
        videoRoom = null;
    }
    
    if (videoCallTimer) {
        clearInterval(videoCallTimer);
        videoCallTimer = null;
    }
    
    // Log the video call
    if (currentPatientId && videoCallStartTime) {
        const duration = Math.floor((Date.now() - videoCallStartTime) / 1000);
        try {
            await fetch(`/api/patients/${currentPatientId}/log-video-call`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({duration})
            });
        } catch (error) {
            console.error('Error logging video call:', error);
        }
    }
    
    closeVideoCallModal();
    loadCorrespondence(); // Reload to show video call log
    
    // Reset states
    videoCallStartTime = null;
    isVideoMuted = false;
    isVideoCameraOff = false;
    localAudioTrack = null;
    localVideoTrack = null;
}

function copyVideoLink() {
    const input = document.getElementById('videoRoomLink');
    input.select();
    document.execCommand('copy');
    alert('‚úÖ Link copied to clipboard!');
}

async function sendVideoLinkSms() {
    if (!currentPatientId) return;
    
    const roomLink = document.getElementById('videoRoomLink').value;
    const phone = currentPatientPhone || document.getElementById('callPhone').value;
    
    if (!phone) {
        alert('‚ö†Ô∏è Patient phone number not available');
        return;
    }
    
    const message = `Hi! Please join the video consultation using this link: ${roomLink}`;
    
    try {
        const response = await fetch(`/api/patients/${currentPatientId}/send-sms`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone, message})
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ Video link sent via SMS!');
        } else {
            alert('‚ùå Error sending SMS: ' + data.error);
        }
    } catch (error) {
        console.error('Error sending video link SMS:', error);
        alert('‚ùå Error sending SMS');
    }
}

// Close modals on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSmsModal();
        if (!currentCallSid) closePhoneCallModal();
        if (!videoRoom) closeVideoCallModal();
    }
});

// Close modals on background click
['smsModal', 'phoneCallModal', 'videoCallModal'].forEach(modalId => {
    document.getElementById(modalId)?.addEventListener('click', function(e) {
        if (e.target === this) {
            if (modalId === 'smsModal') closeSmsModal();
            else if (modalId === 'phoneCallModal' && !currentCallSid) closePhoneCallModal();
            else if (modalId === 'videoCallModal' && !videoRoom) closeVideoCallModal();
        }
    });
});
</script>
{% endblock %}
